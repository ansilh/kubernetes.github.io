<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=generator content="Relearn 5.23.2+tip"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="Kubernetes pocket gude and more"><meta name=author content="Ansil H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubernetes.ansilh.com/images/hero.png"><meta name=twitter:title content><meta name=twitter:description content="Kubernetes pocket gude and more"><meta property="og:title" content><meta property="og:description" content="Kubernetes pocket gude and more"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.ansilh.com/index.html"><meta property="og:image" content="https://kubernetes.ansilh.com/images/hero.png"><meta property="og:site_name" content="Hugo Relearn Theme"><title></title>
<link href=./images/logo.svg?1704645833 rel=icon type=image/svg+xml><link href=./css/fontawesome-all.min.css?1704645834 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=./css/fontawesome-all.min.css?1704645834 rel=stylesheet></noscript><link href=./css/nucleus.css?1704645834 rel=stylesheet><link href=./css/auto-complete.css?1704645834 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=./css/auto-complete.css?1704645834 rel=stylesheet></noscript><link href=./css/perfect-scrollbar.min.css?1704645834 rel=stylesheet><link href=./css/fonts.css?1704645834 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=./css/fonts.css?1704645834 rel=stylesheet></noscript><link href=./css/theme.css?1704645834 rel=stylesheet><link href=./css/theme-neon.css?1704645834 rel=stylesheet id=R-variant-style><link href=./css/chroma-neon.css?1704645834 rel=stylesheet id=R-variant-chroma-style><link href=./css/variant.css?1704645834 rel=stylesheet><link href=./css/print.css?1704645834 rel=stylesheet media=print><link href=./css/format-print.css?1704645834 rel=stylesheet><link href=./css/ie.css?1704645834 rel=stylesheet><script src=./js/url.js?1704645834></script><script src=./js/variant.js?1704645834></script><script>window.index_js_url="./index.search.js";var root_url="./",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://kubernetes.ansilh.com/",window.relearn.themeVariantModifier="",window.variants&&variants.init(["neon"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><style>#R-body img.bg-white{background-color:#fff}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=./index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable home" tabindex=-1><div class=flex-block-wrapper><section><h1 class=a11y-only>Subsections of</h1><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 1</div><h1 id=introduction>Introduction</h1><h4 id=history-of-k8s>History of K8S</h4><div style=float:left><li>2003-2004: Google introduced Borg system , which started as a small project to manage new search engine.
Later on it was heavily used for managing internal distributed systems and jobs<li>2013: Google moved from Borg to Omega - a flexible and scalable scheduler for large clusters<li>2014: Google introduced kubernetes and big players (IBM, Docker, RedHat, Microsoft) joined the project<li>2015: Kubernetes 1.0 released and Google partnered with Linux Foundation to form the Cloud Native Computing Foundation (CNCF)<li>2016: Kubernetes went to mainstream and Helm package manager introduced and `minikube` was also released. Windows support added to k8s<li>2017: Kubernetes reached v.1.7 and were widely adopted by industry. IBM and Google introduced `Istio` service mesh.<li>2018: Industry understands the power of k8s and adoption rate increased<li>2019: Journey continues...</div><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Introduction</h1><article class=default><header class=headline></header><h1 id=linux-kernel-architecture>Linux Kernel Architecture</h1><p><a href=#R-image-76f707a4d98f248825b2215be2888f24 class=lightbox-link><img src=./01-introduction/01-linux-kernel/kernel-architecture.png alt=Kernel class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-76f707a4d98f248825b2215be2888f24><img src=./01-introduction/01-linux-kernel/kernel-architecture.png alt=Kernel class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>At the top is the user, or application, space. This is where the user applications are executed.
Below the user space is the kernel space.</p><p>There is also the GNU C Library (glibc). This provides the system call interface that connects to the kernel and provides the mechanism to transition between the user-space application and the kernel. This is important because the kernel and user application occupy different protected address spaces. And while each user-space process occupies its own virtual address space, the kernel occupies a single address space.</p><p>The Linux kernel can be further divided into three gross levels.</p><ul><li>At the top is the system call interface, which implements the basic functions such as read and write.</li><li>Below the system call interface is the kernel code, which can be more accurately defined as the architecture-independent kernel code. This code is common to all of the processor architectures supported by Linux.</li><li>Below this is the architecture-dependent code, which forms what is more commonly called a BSP (Board Support Package). This code serves as the processor and platform-specific code for the given architecture.</li></ul><p>The Linux kernel implements a number of important architectural attributes. At a high level, and at lower levels, the kernel is layered into a number of distinct subsystems.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=linux-namespaces>Linux Namespaces</h1><p>Namespaces are a feature of the Linux kernel that partitions kernel resources such that one set of processes sees one set of resources while another set of processes sees a different set of resources. The feature works by having the same name space for these resources in the various sets of processes, but those names referring to distinct resources. Examples of resource names that can exist in multiple spaces, so that the named resources are partitioned, are process IDs, hostnames, user IDs, file names, and some names associated with network access, and interprocess communication.</p><p>Namespaces are a fundamental aspect of containers on Linux.</p><table><thead><tr><th>Namespace</th><th>Constant</th><th>Isolates</th></tr></thead><tbody><tr><td>Cgroup</td><td>CLONE_NEWCGROUP</td><td>Cgroup root directory</td></tr><tr><td>IPC</td><td>CLONE_NEWIPC</td><td>System V IPC, POSIX message queues</td></tr><tr><td>Network</td><td>CLONE_NEWNET</td><td>Network devices, stacks, ports, etc.</td></tr><tr><td>Mount</td><td>CLONE_NEWNS</td><td>Mount points</td></tr><tr><td>PID</td><td>CLONE_NEWPID</td><td>Process IDs</td></tr><tr><td>User</td><td>CLONE_NEWUSER</td><td>User and group IDs</td></tr><tr><td>UTS</td><td>CLONE_NEWUTS</td><td>Hostname and NIS domain name</td></tr></tbody></table><p>The kernel assigns each process a symbolic link per namespace kind in <code>/proc/&lt;pid>/ns/</code>. The inode number pointed to by this symlink is the same for each process in this namespace. This uniquely identifies each namespace by the inode number pointed to by one of its symlinks.</p><p>Reading the symlink via readlink returns a string containing the namespace kind name and the inode number of the namespace.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cgroups>CGroups</h1><p>cgroups (abbreviated from control groups) is a Linux kernel feature that limits, accounts for, and isolates the resource usage (CPU, memory, disk I/O, network, etc.) of a collection of processes.</p><h4 id=resource-limiting>Resource limiting</h4><p>groups can be set to not exceed a configured memory limit</p><h4 id=prioritization>Prioritization</h4><p>Some groups may get a larger share of CPU utilization or disk I/O throughput</p><h4 id=accounting>Accounting</h4><p>Measures a group&rsquo;s resource usage, which may be used</p><h4 id=control>Control</h4><p><a href=https://www.kernel.org/doc/Documentation/cgroup-v1/freezer-subsystem.txt target=_blank>Freezing</a> groups of processes, their checkpointing and restarting</p><p>You can read and explore more about cGroups in this <a href=https://www.digitalocean.com/community/tutorials/how-to-limit-resources-using-cgroups-on-centos-6 target=_blank>post</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=container-from-scratch>Container from scratch</h1><p>Using namespaces , we can start a process which will be completely isolated from other processes running in the system.</p><h3 id=create-root-file-system>Create root File System</h3><h4 id=create-directory-to-store-rootfs-contents>Create directory to store rootfs contents</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mkdir -p /root/busybox/rootfs
</span></span><span class=line><span class=cl>$ <span class=nv>CONTAINER_ROOT</span><span class=o>=</span>/root/busybox/rootfs
</span></span><span class=line><span class=cl>$ <span class=nb>cd</span> <span class=si>${</span><span class=nv>CONTAINER_ROOT</span><span class=si>}</span></span></span></code></pre></div><h4 id=download-busybox-binary>Download busybox binary</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget https://busybox.net/downloads/binaries/1.28.1-defconfig-multiarch/busybox-x86_64</span></span></code></pre></div><h4 id=create-needed-directories-and-symlinks>Create needed directories and symlinks</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mv busybox-x86_64 busybox
</span></span><span class=line><span class=cl>$ chmod <span class=m>755</span> busybox
</span></span><span class=line><span class=cl>$ mkdir bin
</span></span><span class=line><span class=cl>$ mkdir proc
</span></span><span class=line><span class=cl>$ mkdir sys
</span></span><span class=line><span class=cl>$ mkdir tmp
</span></span><span class=line><span class=cl>$ <span class=k>for</span> i in <span class=k>$(</span>./busybox --list<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>   ln -s /busybox bin/<span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><h3 id=start-container>Start Container</h3><h4 id=start-a-shell-in-new-contianer>Start a shell in new contianer</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ unshare --mount --uts --ipc --net --pid --fork --user --map-root-user chroot <span class=si>${</span><span class=nv>CONTAINER_ROOT</span><span class=si>}</span> /bin/sh</span></span></code></pre></div><h4 id=mount-essential-kernel-structures>Mount essential kernel structures</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mount -t proc none /proc
</span></span><span class=line><span class=cl>$ mount -t sysfs none /sys
</span></span><span class=line><span class=cl>$ mount -t tmpfs none /tmp</span></span></code></pre></div><h3 id=configure-networking>Configure networking</h3><h4 id=from-host-system--create-a-veth-pair-and-then-map-that-to-container>From Host system , create a veth pair and then map that to container</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ip link add vethlocal <span class=nb>type</span> veth  peer name vethNS
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> vethlocal up
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> vethNS up
</span></span><span class=line><span class=cl>$ sudo ps -ef <span class=p>|</span>grep <span class=s1>&#39;/bin/sh&#39;</span>
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> vethNS netns &lt;pid of /bin/sh&gt;</span></span></code></pre></div><h4 id=from-container--execute-ip-link>From container , execute <code>ip link</code></h4><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=what-is-docker>What is Docker</h1><p>Docker is a tool designed to make it easier to create, deploy, and run applications by using containers. Containers allow a developer to package up an application with all of the parts it needs, such as libraries and other dependencies, and ship it all out as one package.</p><p>In a way, Docker is a bit like a virtual machine. But unlike a virtual machine, rather than creating a whole virtual operating system, Docker allows applications to use the same Linux kernel as the system that they&rsquo;re running on and only requires applications be shipped with things not already running on the host computer. This gives a significant performance boost and reduces the size of the application.</p><p><a href=#R-image-6c22661c37fcae73e6bbe92dd77addbe class=lightbox-link><img src=./01-introduction/05-docker/docker.jpg alt=Kernel class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-6c22661c37fcae73e6bbe92dd77addbe><img src=./01-introduction/05-docker/docker.jpg alt=Kernel class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=kubernetes>Kubernetes</h1><h3 id=pet-vs-cattle>Pet vs Cattle.</h3><p>In the pets service model, each pet server is given a loving names like zeus, ares, hades, poseidon, and athena. They are “unique, lovingly hand-raised, and cared for, and when they get sick, you nurse them back to health”. You scale these up by making them bigger, and when they are unavailable, everyone notices.</p><p>In the cattle service model, the servers are given identification numbers like web-01, web-02, web-03, web-04, and web-05, much the same way cattle are given numbers tagged to their ear. Each server is “almost identical to each other” and “when one gets sick, you replace it with another one”. You scale these by creating more of them, and when one is unavailable, no one notices.</p><p>Kubernetes is a portable, extensible open-source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p><p>Google open-sourced the Kubernetes project in 2014. Kubernetes builds upon a decade and a half of experience that Google has with running production workloads at scale, combined with best-of-breed ideas and practices from the community</p><p><a href=https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/ target=_blank>Read More here</a></p><p><a href=#R-image-0b9cc5c82fdb92db04b52aad49280872 class=lightbox-link><img src="./01-introduction/06-kubernetes/kubernetes.svg?classes=shadow&amp;width=60pc" alt="Container and Kubernetes" class="figure-image bg-white border lightbox shadow" style=height:auto;width:60pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0b9cc5c82fdb92db04b52aad49280872><img src="./01-introduction/06-kubernetes/kubernetes.svg?classes=shadow&amp;width=60pc" alt="Container and Kubernetes" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h3 id=kubernetes-architecture>Kubernetes Architecture</h3><p><a href=#R-image-a5340e20600f52e2a0f26892709e1cd2 class=lightbox-link><img src="./01-introduction/06-kubernetes/kubernetes-architecture.png?classes=shadow" alt="Container and Kubernetes" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a5340e20600f52e2a0f26892709e1cd2><img src="./01-introduction/06-kubernetes/kubernetes-architecture.png?classes=shadow" alt="Container and Kubernetes" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h4 id=container-runtime>Container runtime</h4><p>Docker , rkt , containerd or any OCI compliant runtime which will download image , configures network , mount volumes and assist container life cycle management.</p><h4 id=kubelet>kubelet</h4><p>Responsible for instructing container runtime to start , stop or modify a container</p><h4 id=kube-proxy>kube-proxy</h4><p>Manage service IPs and iptables rules</p><h4 id=kube-apiserver>kube-apiserver</h4><p>API server interacts with all other components in cluster
All client interactions will happen via API server</p><h4 id=kube-scheduler>kube-scheduler</h4><p>Responsible for scheduling workload on minions or worker nodes based on resource constraints</p><h4 id=kube-controller-manager>kube-controller-manager</h4><p>Responsible for monitoring different containers in reconciliation loop
Will discuss more about different controllers later in this course</p><h4 id=etcd>etcd</h4><p>Persistent store where we store all configurations and cluster state</p><h4 id=cloud-controller-manager>cloud-controller-manager</h4><p>Cloud vendor specific controller and cloud vendor is Responsible to develop this program</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=container-networking>Container Networking</h1><p>We need to access the container from outside world and the container running on different hosts have to communicate each other.</p><p>Here we will see how can we do it with bridging.</p><h4 id=traditional-networking>Traditional networking</h4><p><a href=#R-image-ec14fa668cb4e8d427e49aee1a6c621d class=lightbox-link><img src="./01-introduction/07-network-plugins/nw-traditional.png?classes=shadow" alt=Network class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-ec14fa668cb4e8d427e49aee1a6c621d><img src="./01-introduction/07-network-plugins/nw-traditional.png?classes=shadow" alt=Network class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h4 id=create-a-veth-pair-on-host>Create a veth pair on Host.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ip link add veth0 <span class=nb>type</span> veth peer name veth1
</span></span><span class=line><span class=cl>$ sudo ip link show</span></span></code></pre></div><h4 id=create-a-network-namespace>Create a network namespace</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ip netns add bash-nw-namespace
</span></span><span class=line><span class=cl>$ sudo ip netns show</span></span></code></pre></div><h4 id=connect-one-end-to-namespace>Connect one end to namespace</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> veth1 netns bash-nw-namespace
</span></span><span class=line><span class=cl>$ sudo ip link list</span></span></code></pre></div><h4 id=resulting-network>Resulting network</h4><p><a href=#R-image-092d79b4f04e422de48728c0f2740bd6 class=lightbox-link><img src="./01-introduction/07-network-plugins/nw-namespace.png?classes=shadow" alt=Network class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-092d79b4f04e422de48728c0f2740bd6><img src="./01-introduction/07-network-plugins/nw-namespace.png?classes=shadow" alt=Network class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h4 id=create-a-bridge-interface>Create a Bridge interface</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo brctl addbr cbr0</span></span></code></pre></div><h4 id=add-an-external-interface-to-bridge>Add an external interface to bridge</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo brctl addif cbr0 enp0s9
</span></span><span class=line><span class=cl>$ sudo brctl show</span></span></code></pre></div><h4 id=connect-other-end-to-a-switch>Connect other end to a switch</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo brctl addif cbr0 veth0
</span></span><span class=line><span class=cl>$ sudo brctl show</span></span></code></pre></div><h4 id=resulting-network-1>Resulting network</h4><p><a href=#R-image-a7a4bc7fbc49f35e7433b5cc13e6b7a1 class=lightbox-link><img src="./01-introduction/07-network-plugins/nw-namespace-with-bridge.png?classes=shadow" alt=Network class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a7a4bc7fbc49f35e7433b5cc13e6b7a1><img src="./01-introduction/07-network-plugins/nw-namespace-with-bridge.png?classes=shadow" alt=Network class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h4 id=assign-ip-to-interface>Assign IP to interface</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ip netns <span class=nb>exec</span> bash-nw-namespace bash
</span></span><span class=line><span class=cl>$ sudo ip addr add 192.168.56.10/24 dev veth1
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> lo up
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> dev veth1 up</span></span></code></pre></div><h4 id=access-container-ip-from-outside>Access container IP from outside</h4><p>Like bridging , we can opt other networking solutions.</p><p>Later we will see how Weave Network and Calico plugins works.
You may read bit more on Docker networking basics on below blog post</p><p><a href=https://blog.docker.com/2016/12/understanding-docker-networking-drivers-use-cases/ target=_blank>Docker networking</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 2</div><h1 id=installation>Installation</h1><ul><li>In this chapter we will install VirtualBox and setup networking.</li><li>We will learn how to install and configure Docker.</li><li>Also we will install a two node kubernetes cluster using kubeadm.</li></ul><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Installation</h1><article class=default><header class=headline></header><h1 id=install-virtualbox>Install VirtualBox</h1><ul><li><p>Download the latest VBox installer and VBox Extension Pack</p><ul><li><a href=https://download.virtualbox.org/virtualbox/LATEST.TXT target=_blank>https://download.virtualbox.org/virtualbox/LATEST.TXT</a></li><li><a href=https://download.virtualbox.org/virtualbox/ target=_blank>https://download.virtualbox.org/virtualbox/</a>&lt;LATEST>/</li></ul></li><li><p>Installation procedure is available in below link</p><ul><li><a href=https://www.wikihow.com/Install-VirtualBox target=_blank>https://www.wikihow.com/Install-VirtualBox</a></li></ul></li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=virtualbox-network-configuration>VirtualBox Network Configuration</h1><ul><li>Create HostOnly network ( Default will be 192.168.56.0/24)<ul><li>Open Virtual Box</li><li>Got to menu and navigate to File ->Host Network Manager</li><li>Then click &ldquo;Create&rdquo;
This will create a Host-Only Network.</li></ul></li></ul><p>DHCP should be disabled on this network.</p><p>Internet access is needed on all VMs (for downloading needed binaries).</p><p>Make sure you can see the NAT network.(If not , create one).</p><table><thead><tr><th>VBox Host Networking</th><th></th></tr></thead><tbody><tr><td>HostOnly</td><td>192.168.56.0/24</td></tr><tr><td>NAT</td><td>VBOX Defined</td></tr></tbody></table><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=ubuntu-1604-installation>Ubuntu 16.04 Installation</h1><ul><li>Download Ubuntu 16.04 ISO
<a href=http://releases.ubuntu.com/16.04/ubuntu-16.04.5-server-amd64.iso target=_blank>http://releases.ubuntu.com/16.04/ubuntu-16.04.5-server-amd64.iso</a></li></ul><p>Create a template VM which will be used to clone all needed VMs</p><ul><li>You need at least 50GB free space to host all VMs</li><li>All VMs will be placed in a directory called (Don&rsquo;t create these manually now!)
<code>DRIVE_NAME:/VMs/</code> (Replace <code>DRIVE_NAME</code> with a mount point or Driver name)</li><li>Install Ubuntu 16.04 with latest patches</li><li>VM configuration<ul><li>VM Name : <code>k8s-master-01</code></li><li>Memory : 2 GB</li><li>CPU : 2</li><li>Disk : 100GB</li><li>HostOnly interface : 1 (ref. step 1).</li><li>NAT network interface : 1</li></ul></li></ul><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>By default , NAT will be the first in network adapter order , change it.
NAT interface should be the second interface and
Host-Only should be the first one</p></div></div><ul><li><p>Install Ubuntu on this VM and go ahead with all default options</p></li><li><p>When asked, provide user name <code>k8s</code> and set password</p></li><li><p>Make sure to select the NAT interface as primary during installation.</p></li><li><p>Select below in <code>Software Selection</code> screen</p></li><li><p>Manual Software Selection</p></li><li><p>OpenSSH Server</p></li><li><p>After restart , make sure NAT interface is up</p></li><li><p>Login to the template VM with user <code>k8s</code> and execute below commands to install latest patches.</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-get update
</span></span><span class=line><span class=cl>$ sudo apt-get upgrade</span></span></code></pre></div><ul><li>Poweroff template VM</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo poweroff</span></span></code></pre></div><h4 id=clone-vm>Clone VM</h4><p>You may use VirtualBox GUI to create a full clone - Preferred
You can use below commands to clone a VM - Execute it at your own risk ;)</p><ul><li>Open CMD and execute below commands to create all needed VMs.
You can replace the value of <code>DRIVER_NAME</code> with a drive which is having enough free space (~50GB)</li><li>Windows</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> <span class=nb>set</span> <span class=nv>DRIVE_NAME</span><span class=o>=</span>D
</span></span><span class=line><span class=cl> <span class=nb>cd</span> C:<span class=se>\P</span>rogram Files<span class=se>\O</span>racle<span class=se>\V</span>irtualBox
</span></span><span class=line><span class=cl> VBoxManage.exe clonevm <span class=s2>&#34;k8s-master-01&#34;</span> --name <span class=s2>&#34;k8s-worker-01&#34;</span> --groups <span class=s2>&#34;/K8S Training&#34;</span> --basefolder <span class=s2>&#34;%DRIVE_NAME%:\VMs&#34;</span> --register</span></span></code></pre></div><ul><li>Mac or Linux (Need to test)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl> <span class=nv>DRIVE_NAME</span><span class=o>=</span><span class=si>${</span><span class=nv>HOME</span><span class=si>}</span>
</span></span><span class=line><span class=cl> VBoxManage clonevm <span class=s2>&#34;k8s-master-01&#34;</span> --name <span class=s2>&#34;k8s-worker-01&#34;</span> --groups <span class=s2>&#34;/K8S Training&#34;</span> --basefolder <span class=si>${</span><span class=nv>DRIVE_NAME</span><span class=si>}</span>/VMs<span class=s2>&#34; --register</span></span></span></code></pre></div><h5 id=start-vms-one-by-one-and-perform-below>Start VMs one by one and perform below</h5><h5 id=execute-below-steps-on-both-master-and-worker-nodes>Execute below steps on both master and worker nodes</h5><ul><li>Assign IP address and make sure it comes up at boot time.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl stop networking
</span></span><span class=line><span class=cl>$ sudo vi /etc/network/interfaces</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>auto</span> <span class=s>enp0s3 #&lt;-- Make sure to use HostOnly interface (it can also be enp0s8)</span>
</span></span><span class=line><span class=cl><span class=na>iface</span> <span class=s>enp0s3 inet static</span>
</span></span><span class=line><span class=cl>    <span class=na>address</span> <span class=s>192.168.56.X #&lt;--- Replace X with corresponding IP octet</span>
</span></span><span class=line><span class=cl>    <span class=na>netmask</span> <span class=s>255.255.255.0</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart networking</span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>You may access the VM using the IP via SSH and can complete all remaining steps from that session (for copy paste :) )</p></div></div><ul><li>Change Host name</li></ul><h5 id=execute-below-steps-only-on-worker-node>Execute below steps only on worker node</h5><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nv>HOST_NAME</span><span class=o>=</span>&lt;host name&gt; <span class=c1># &lt;--- Replace &lt;host name&gt; with corresponding one</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo hostnamectl set-hostname <span class=si>${</span><span class=nv>HOST_NAME</span><span class=si>}</span> --static --transient</span></span></code></pre></div><ul><li>Regenrate SSH Keys</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo /bin/rm -v /etc/ssh/ssh_host_*
</span></span><span class=line><span class=cl>$ sudo dpkg-reconfigure openssh-server</span></span></code></pre></div><ul><li>Change iSCSI initiator IQN</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /etc/iscsi/initiatorname.iscsi</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>InitiatorName</span><span class=o>=</span>iqn.1993-08.org.debian:01:HOST_NAME  <span class=c1>#&lt;--- Append HostName to have unique iscsi iqn</span></span></span></code></pre></div><ul><li>Change Machine UUID</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo rm /etc/machine-id /var/lib/dbus/machine-id
</span></span><span class=line><span class=cl>$ sudo systemd-machine-id-setup</span></span></code></pre></div><h5 id=execute-below-steps-on-both-master-and-worker-nodes-1>Execute below steps on both master and worker nodes</h5><ul><li><p>Remove 127.0.1.1 entry from /etc/hosts</p></li><li><p>Add needed entries in /etc/hosts</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo bash -c  <span class=s2>&#34;cat &lt;&lt;EOF &gt;&gt;/etc/hosts
</span></span></span><span class=line><span class=cl><span class=s2>192.168.56.201 k8s-master-01
</span></span></span><span class=line><span class=cl><span class=s2>192.168.56.202 k8s-worker-01
</span></span></span><span class=line><span class=cl><span class=s2>EOF&#34;</span></span></span></code></pre></div><ul><li>Add public DNS incase the local one is not responding in NAT</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ sudo bash -c  <span class=s2>&#34;cat &lt;&lt;EOF &gt;&gt;/etc/resolvconf/resolv.conf.d/tail
</span></span></span><span class=line><span class=cl><span class=s2>nameserver 8.8.8.8
</span></span></span><span class=line><span class=cl><span class=s2>EOF&#34;</span></span></span></code></pre></div><ul><li>Disable swap by commenting out swap_1 LV</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /etc/fstab</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code># /dev/mapper/k8s--master--01--vg-swap_1 none            swap    sw              0       0</code></pre></div><ul><li>Reboot VMs</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo reboot</span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>Do a ping test to make sure both VMs can reach each other.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=install-docker>Install Docker</h1><p>In this session, we will install and setup docker in a simple and easy way on Ubuntu 16.04.</p><ul><li>Add gpg key to aptitude</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class=p>|</span> sudo apt-key add -</span></span></code></pre></div><ul><li>Add repository</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo add-apt-repository <span class=s2>&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span></span></span></code></pre></div><ul><li>Refresh repository</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-get update</span></span></code></pre></div><ul><li>Verify whether docker is available in repo or not</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-cache policy docker-ce</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>docker-ce:
  Installed: (none)
  Candidate: 5:18.09.0~3-0~ubuntu-xenial
  Version table:
     5:18.09.0~3-0~ubuntu-xenial 500
...</code></pre></div><ul><li>Install docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-get install -y docker-ce</span></span></code></pre></div><ul><li>Make sure docker is running</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl status docker</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>● docker.service - Docker Application Container Engine
   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
   Active: active (running) since Wed 2018-12-26 17:14:59 UTC; 4min 27s ago
     Docs: https://docs.docker.com
 Main PID: 1191 (dockerd)
    Tasks: 10
   Memory: 76.4M
      CPU: 625ms
   CGroup: /system.slice/docker.service
           └─1191 /usr/bin/dockerd -H unix://
...</code></pre></div><ul><li>Add user to docker group so that this user can execute docker commands.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo usermod -aG docker <span class=si>${</span><span class=nv>USER</span><span class=si>}</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Logout the session and login again to refresh the group membership.</p></div></div><ul><li>Verify docker by executing info command.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker info <span class=p>|</span>grep <span class=s1>&#39;Server Version&#39;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Server Version: 18.09.0
</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=setup-golang>Setup Golang</h1><ul><li>Download Golang tarball</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -O https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz</span></span></code></pre></div><ul><li>Extract the contents</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tar -xvf go1.11.4.linux-amd64.tar.gz</span></span></code></pre></div><ul><li>Move the contents to /usr/local directory</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mv go /usr/local/</span></span></code></pre></div><ul><li>Add the environmental variable GOPATH to .profile</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;&gt;~/.profile
</span></span></span><span class=line><span class=cl><span class=s>export GOPATH=\$HOME/work
</span></span></span><span class=line><span class=cl><span class=s>export PATH=\$PATH:/usr/local/go/bin:\$GOPATH/bin
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Create the work directory</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir <span class=nv>$HOME</span>/work</span></span></code></pre></div><ul><li>Load the profile</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>source</span> ~/.profile</span></span></code></pre></div><ul><li>Verify Golang setup</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ go version</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>go version go1.11.4 linux/amd64
</span></span></span></code></pre></div><ul><li>Create a directory tree to map to a github repository</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir -p <span class=nv>$GOPATH</span>/src/github.com/ansilh/golang-demo</span></span></code></pre></div><ul><li>Create a hello world golang program</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi <span class=nv>$GOPATH</span>/src/github.com/ansilh/golang-demo/main.go</span></span></code></pre></div><ul><li>Paste below code</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>  
</span></span><span class=line><span class=cl> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Hello World.!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><ul><li>Build and install the program</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>go install github.com/ansilh/golang-demo
</span></span></span></code></pre></div><ul><li>Execute the program to see the output</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ golang-demo</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Hello World.!
</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=build-a-demo-webapp>Build a Demo WebApp</h1><ul><li>Create a directory for the demo app.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir -p <span class=si>${</span><span class=nv>GOPATH</span><span class=si>}</span>/src/github.com/ansilh/demo-webapp</span></span></code></pre></div><ul><li>Create demo-webapp.go file</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi <span class=si>${</span><span class=nv>GOPATH</span><span class=si>}</span>/src/github.com/ansilh/demo-webapp/demo-webapp.go</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>demoDefault</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;404 - Page not found - This is a dummy default backend&#34;</span><span class=p>)</span> <span class=c1>// send data to client side
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>demoDefault</span><span class=p>)</span> <span class=c1>// set router
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:9090&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span> <span class=c1>// set listen port
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=s>&#34;ListenAndServe: &#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><ul><li>Build a static binary</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> <span class=nv>$GOPATH</span>/src/github.com/ansilh/demo-webapp
</span></span><span class=line><span class=cl>$ <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> <span class=nv>GOOS</span><span class=o>=</span>linux <span class=nv>GOARCH</span><span class=o>=</span>amd64 go build -a -installsuffix cgo -ldflags<span class=o>=</span><span class=s2>&#34;-w -s&#34;</span> -o <span class=nv>$GOPATH</span>/bin/demo-webapp</span></span></code></pre></div><ul><li>Execute the program</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ demo-webapp</span></span></code></pre></div><p>Open the browser and check if you can see the response using IP:9090
If you see the output “404 – Page not found – This is a dummy default backend” indicates that the program is working</p><p>Press Ctrl+c to terminate the program</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=build-a-docker-image>Build a Docker image</h1><p>Create a <a href=https://hub.docker.com/ target=_blank>Docker Hub account</a></p><ul><li>Let’s create a directory to store the Dockerfile</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir ~/demo-webapp</span></span></code></pre></div><ul><li>Copy the pre-built program</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cp <span class=nv>$GOPATH</span>/bin/demo-webapp ~/demo-webapp/</span></span></code></pre></div><ul><li>Create a Dockerfile.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> ~/demo-webapp/
</span></span><span class=line><span class=cl>$ vi Dockerfile</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>FROM scratch
LABEL maintainer=&#34;Ansil H&#34;
LABEL email=&#34;ansilh@gmail.com&#34;
COPY demo-webapp /
CMD [&#34;/demo-webapp&#34;]</code></pre></div><ul><li>Build the docker image</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo docker build -t &lt;docker login name&gt;/demo-webapp .
</span></span><span class=line><span class=cl>Eg:-
</span></span><span class=line><span class=cl>$ sudo docker build -t ansilh/demo-webapp .</span></span></code></pre></div><ul><li>Login to Docker Hub using your credentials</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker login</span></span></code></pre></div><ul><li>Push image to Docker hub</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker push &lt;docker login name&gt;/demo-webapp
</span></span><span class=line><span class=cl>Eg:-
</span></span><span class=line><span class=cl>$ docker push ansilh/demo-webapp</span></span></code></pre></div><p>Congratulations ! . Now the image you built is available in Docker Hub and we can use this image to run containers in upcoming sessions</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=docker---container-management>Docker - Container management</h1><h4 id=start-a-container>Start a Container</h4><ul><li>Here we map port 80 of host to port 9090 of cotainer</li><li>Verify application from browser</li><li>Press Ctrl+c to exit container</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker run -p 80:9090 ansilh/demo-webapp</span></span></code></pre></div><ul><li>Start a Container in detach mode</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker run -d -p 80:9090 ansilh/demo-webapp</span></span></code></pre></div><ul><li>List Container</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker ps
</span></span><span class=line><span class=cl>CONTAINER ID        IMAGE                COMMAND             CREATED             STATUS              PORTS                  NAMES
</span></span><span class=line><span class=cl>4c8364e0d031        ansilh/demo-webapp   <span class=s2>&#34;/demo-webapp&#34;</span>      <span class=m>11</span> seconds ago      Up <span class=m>10</span> seconds       0.0.0.0:80-&gt;9090/tcp   zen_gauss</span></span></code></pre></div><ul><li>List all containers including stopped containers</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker ps -a
</span></span><span class=line><span class=cl>CONTAINER ID        IMAGE                COMMAND             CREATED             STATUS                     PORTS                  NAMES
</span></span><span class=line><span class=cl>4c8364e0d031        ansilh/demo-webapp   <span class=s2>&#34;/demo-webapp&#34;</span>      <span class=m>2</span> minutes ago       Up <span class=m>2</span> minutes               0.0.0.0:80-&gt;9090/tcp   zen_gauss
</span></span><span class=line><span class=cl>acb01851c20a        ansilh/demo-webapp   <span class=s2>&#34;/demo-webapp&#34;</span>      <span class=m>2</span> minutes ago       Exited <span class=o>(</span>2<span class=o>)</span> <span class=m>2</span> minutes ago                          condescending_antonelli</span></span></code></pre></div><ul><li>List resource usage (Press Ctrl+c to exit)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker stats zen_gauss</span></span></code></pre></div><ul><li>Stop Container</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker stop zen_gauss</span></span></code></pre></div><ul><li>List images</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker images
</span></span><span class=line><span class=cl>REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE
</span></span><span class=line><span class=cl>ansilh/demo-webapp   latest              b7c5e17ae85e        <span class=m>8</span> minutes ago       4.81MB</span></span></code></pre></div><ul><li>Remove containers</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker rm zen_gauss</span></span></code></pre></div><ul><li>Delete images</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker rmi ansilh/demo-webapp</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=install-kubeadm>Install kubeadm</h1><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>Verify the MAC address and product_uuid are unique for every node
(<code>ip link</code> or <code>ifconfig -a</code> and <code>sudo cat /sys/class/dmi/id/product_uuid</code>)</p></div></div><ul><li>Download pre-requisites</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-get update <span class=o>&amp;&amp;</span> sudo apt-get install -y apt-transport-https curl</span></span></code></pre></div><ul><li>Add gpg key for apt</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg <span class=p>|</span>sudo apt-key add -</span></span></code></pre></div><ul><li>Add apt repository</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF |sudo tee -a /etc/apt/sources.list.d/kubernetes.list
</span></span></span><span class=line><span class=cl><span class=s>deb https://apt.kubernetes.io/ kubernetes-xenial main
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Install kubelet , kubeadm and kubectl</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo apt-get update
</span></span><span class=line><span class=cl>$ sudo apt-get install -y kubelet kubeadm kubectl
</span></span><span class=line><span class=cl>$ sudo apt-mark hold kubelet kubeadm kubectl</span></span></code></pre></div><p>Repeat the same steps on worker node</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=deploy-master-node>Deploy master Node</h1><ul><li>Initialize kubeadm with pod IP range</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo kubeadm init --apiserver-advertise-address<span class=o>=</span>192.168.56.201 --pod-network-cidr<span class=o>=</span>10.10.0.0/16  --service-cidr<span class=o>=</span>192.168.10.0/24</span></span></code></pre></div><ul><li>Configure <code>kubectl</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>$ sudo cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>$ sudo chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config</span></span></code></pre></div><ul><li>Verify master node status</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl cluster-info</span></span></code></pre></div><ul><li>Output will be like below</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Kubernetes master is running at https://192.168.56.201:6443
</span></span></span><span class=line><span class=cl><span class=go>KubeDNS is running at https://192.168.56.201:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>To further debug and diagnose cluster problems, use &#39;kubectl cluster-info dump&#39;.
</span></span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>Move to next session to deploy network plugin.</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=deploy-network-plugin---calico>Deploy Network Plugin - Calico</h1><ul><li>Apply RBAC rules (More about RBAC will discuss later)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml</span></span></code></pre></div><ul><li>Download Calico deployment YAML</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget https://docs.projectcalico.org/v3.3/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml</span></span></code></pre></div><ul><li>Edit <code>CALICO_IPV4POOL_CIDR</code> value to <code>10.10.0.0/16</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CALICO_IPV4POOL_CIDR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.10.0.0/16&#34;</span></span></span></code></pre></div><ul><li>Add <code>name: IP_AUTODETECTION_METHOD</code> & <code>value: "can-reach=192.168.56.1"</code> (This IP should be the host only network ip on your laptop)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/calico/node:v3.3.2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>IP_AUTODETECTION_METHOD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;can-reach=192.168.56.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span></span></span></code></pre></div><ul><li>Apply Deployment</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f calico.yaml</span></span></code></pre></div><ul><li>Make sure the <code>READY</code> status should show same value on left and right side of <code>/</code> and <code>Pod</code> <code>STATUS</code> should be <code>Running</code></li></ul><div class="wrap-code highlight"><pre tabindex=0><code class=language-shel data-lang=shel>$ kubectl get pods -n kube-system |nl</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=m>1</span><span class=w>  </span><span class=l>NAME                                    READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>2</span><span class=w>  </span><span class=l>calico-node-2pwv9                       2/2     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>3</span><span class=w>  </span><span class=l>coredns-86c58d9df4-d9q2l                1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>4</span><span class=w>  </span><span class=l>coredns-86c58d9df4-rwv7r                1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>5</span><span class=w>  </span><span class=l>etcd-k8s-master-01                      1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>6</span><span class=w>  </span><span class=l>kube-apiserver-k8s-master-01            1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>7</span><span class=w>  </span><span class=l>kube-controller-manager-k8s-master-01   1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>8</span><span class=w>  </span><span class=l>kube-proxy-m6m9n                        1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>9</span><span class=w>  </span><span class=l>kube-scheduler-k8s-master-01            1/1     Running   0          20m</span></span></span></code></pre></div><div class="box notices cstyle tip"><div class=box-label><i class="fa-fw fas fa-lightbulb"></i> Tip</div><div class=box-content><p>Contact the Trainer if the output is not the expected one after few minutes (~3-4mins).</p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=add-worker-node-to-cluster>Add worker node to cluster</h1><ul><li>Get discovery secret from Master node.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> sha256:<span class=k>$(</span>openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -pubkey <span class=p>|</span> openssl rsa -pubin -outform DER 2&gt;/dev/null <span class=p>|</span> sha256sum <span class=p>|</span> cut -d<span class=s1>&#39; &#39;</span> -f1<span class=k>)</span></span></span></code></pre></div><ul><li>Get node join token from Master node.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubeadm token list <span class=p>|</span>grep bootstra <span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span></span></span></code></pre></div><ul><li>Execute kubeadm command to add the Worker to cluster</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo kubeadm join 192.168.56.201:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash &lt;discovery hash&gt;</span></span></code></pre></div><ul><li>Verify system Pod status</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -n kube-system <span class=p>|</span>nl</span></span></code></pre></div><ul><li>Output</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w> </span><span class=m>1</span><span class=w>  </span><span class=l>NAME                                    READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=l>calico-node-2pwv9                       2/2     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>3</span><span class=w>  </span><span class=l>calico-node-hwnfh                       2/2     Running   0          19m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>4</span><span class=w>  </span><span class=l>coredns-86c58d9df4-d9q2l                1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>5</span><span class=w>  </span><span class=l>coredns-86c58d9df4-rwv7r                1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>6</span><span class=w>  </span><span class=l>etcd-k8s-master-01                      1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>7</span><span class=w>  </span><span class=l>kube-apiserver-k8s-master-01            1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>8</span><span class=w>  </span><span class=l>kube-controller-manager-k8s-master-01   1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=m>9</span><span class=w>  </span><span class=l>kube-proxy-m6m9n                        1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>10</span><span class=w>  </span><span class=l>kube-proxy-shwgp                        1/1     Running   0          19m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>11</span><span class=w>  </span><span class=l>kube-scheduler-k8s-master-01            1/1     Running   0          20m</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 3</div><h1 id=pods--nodes>Pods & Nodes</h1><p>In this session , we will explore Pods and Nodes.</p><p>We will also create a <code>Coffee</code> application <code>Pod</code></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Pods & Nodes</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><h2 id=what-is-a-pod->What is a Pod ?</h2><p><a href=#R-image-69e099137f74c595b3eae72cf4f56c4c class=lightbox-link><img src="./03-pods/01-what-is-pod/pods_overview.svg?classes=shadow&amp;width=60pc" alt="Pod Overview" class="figure-image bg-white border lightbox shadow" style=height:auto;width:60pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-69e099137f74c595b3eae72cf4f56c4c><img src="./03-pods/01-what-is-pod/pods_overview.svg?classes=shadow&amp;width=60pc" alt="Pod Overview" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
A Pod is the basic building block of Kubernetes–the smallest and simplest unit in the Kubernetes object model that you create or deploy. A Pod represents a running process on your cluster</p><p>The “one-container-per-Pod” model is the most common Kubernetes use case; in this case, you can think of a Pod as a wrapper around a single container, and Kubernetes manages the Pods rather than the containers directly.</p><p><a href=#R-image-d7d3c7228e686f553677f4973ccd4c2f class=lightbox-link><img src="./03-pods/01-what-is-pod/pod.svg?classes=shadow&amp;width=50pc" alt=Pod class="figure-image bg-white border lightbox shadow" style=height:auto;width:50pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d7d3c7228e686f553677f4973ccd4c2f><img src="./03-pods/01-what-is-pod/pod.svg?classes=shadow&amp;width=50pc" alt=Pod class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>A Pod might encapsulate an application composed of multiple co-located containers that are tightly coupled and need to share resources. These co-located containers might form a single cohesive unit of service–one container serving files from a shared volume to the public, while a separate “sidecar” container refreshes or updates those files. The Pod wraps these containers and storage resources together as a single manageable entity.</p><h2 id=what-is-a-node>What is a Node?</h2><p><a href=#R-image-1a9a370d3c91cdb7775b4e477261527c class=lightbox-link><img src="./03-pods/01-what-is-pod/nodes.svg?classes=shadow&amp;width=60pc" alt=Node class="figure-image bg-white border lightbox shadow" style=height:auto;width:60pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1a9a370d3c91cdb7775b4e477261527c><img src="./03-pods/01-what-is-pod/nodes.svg?classes=shadow&amp;width=60pc" alt=Node class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
A Pod always runs on a Node. A Node is a worker machine in Kubernetes and may be either a virtual or a physical machine, depending on the cluster. Each Node is managed by the Master. A Node can have multiple pods, and the Kubernetes master automatically handles scheduling the pods across the Nodes in the cluster. The Master&rsquo;s automatic scheduling takes into account the available resources on each Node.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=create-a-pod---declarative>Create a Pod - Declarative</h1><p>After completing this session , you will be able to create Pod declaratively and will be able to login to check services running on other pods.</p><p>So lets get started.</p><h4 id=lets-check-the-running-pods>Lets Check the running Pods</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods
</span></span><span class=line><span class=cl>No resources found.
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>Nothing <i class="fa fa-frown"></i></p><h4 id=lets-create-one-using-a-yaml-file>Lets create one using a <code>YAML</code> file</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span></span></span></code></pre></div><h4 id=apply-yaml-using-kubectl-command>Apply YAML using <code>kubectl</code> command</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f pod.yaml</span></span></code></pre></div><h4 id=view-status-of-pod>View status of Pod</h4><p>Pod status is <code>ContainerCreating</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME         READY   STATUS              RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>coffee-app   0/1     ContainerCreating   0          4s
</span></span></span></code></pre></div><h4 id=execute-kubectl-get-pods-after-some-time>Execute <code>kubectl get pods</code> after some time</h4><p>Now <code>Pod</code> status will change to <code>Running</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME         READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>coffee-app   1/1     Running   0          27s
</span></span></span></code></pre></div><p>Now we can see our first Pod <i class="fa fa-smile-beam"></i></p><h4 id=get-the-ip-address-of-pod>Get the IP address of <code>Pod</code></h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -o wide</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME         READY   STATUS    RESTARTS   AGE    IP            NODE            NOMINATED NODE   READINESS GATES
</span></span></span><span class=line><span class=cl><span class=go>coffee-app   1/1     Running   0          2m8s   192.168.1.7   k8s-worker-01   &lt;none&gt;           &lt;none&gt;
</span></span></span></code></pre></div><h4 id=create-a-new-centos-container>Create a new CentOS container</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi centos-pod.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>centos-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>tutum/centos</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>centos</span></span></span></code></pre></div><h4 id=apply-the-yaml-spec>Apply the Yaml spec</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f centos-pod.yaml</span></span></code></pre></div><h4 id=verify-the-status-of-pod>Verify the status of Pod</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME         READY   STATUS              RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>centos-pod   0/1     ContainerCreating   0          12s
</span></span></span><span class=line><span class=cl><span class=go>coffee-app   1/1     Running             0          5m31s
</span></span></span></code></pre></div><h4 id=after-some-time-status-will-change-to-running>After some time status will change to Running</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>centos-pod   1/1     Running   <span class=m>0</span>          59s
</span></span><span class=line><span class=cl>coffee-app   1/1     Running   <span class=m>0</span>          6m18s</span></span></code></pre></div><h4 id=login-to-centos-pod>Login to CentOS Pod</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it centos-pod -- /bin/bash</span></span></code></pre></div><h4 id=verify-coffee-app-using-curl>Verify Coffee app using curl</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -s 192.168.1.13:9090  <span class=p>|</span>grep <span class=s1>&#39;Serving&#39;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;title&gt;&lt;/title&gt;&lt;body&gt;&lt;div&gt; &lt;h2&gt;Serving Coffee from&lt;/h2&gt;&lt;h3&gt;Pod:coffee-app&lt;/h3&gt;&lt;h3&gt;IP:192.168.1.13&lt;/h3&gt;&lt;h3&gt;Node:172.16.0.1&lt;/h3&gt;&lt;img src=&#34;data:image/png;base64,
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>[root@centos-pod /]#</span>
</span></span></code></pre></div><h4 id=delete-pod>Delete pod</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod coffee-app centos-pod</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>pod &#34;coffee-app&#34; deleted
</span></span></span><span class=line><span class=cl><span class=go>pod &#34;centos-pod&#34; deleted
</span></span></span></code></pre></div><h4 id=make-sure-not-pod-is-running>Make sure not pod is running</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=create-a-pod---imperative>Create a Pod - Imperative</h1><h4 id=execute-kubectl-command-to-create-a-pod>Execute <code>kubectl</code> command to create a Pod.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run coffee --image<span class=o>=</span>ansilh/demo-coffee --restart<span class=o>=</span>Never
</span></span><span class=line><span class=cl>pod/coffee created</span></span></code></pre></div><h4 id=verify-pod-status>Verify <code>Pod</code> status</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -o wide
</span></span><span class=line><span class=cl>NAME     READY   STATUS              RESTARTS   AGE   IP       NODE            NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>coffee   0/1     ContainerCreating   <span class=m>0</span>          6s    &lt;none&gt;   k8s-worker-01   &lt;none&gt;           &lt;none&gt;
</span></span><span class=line><span class=cl>$ kubectl get pods -o wide
</span></span><span class=line><span class=cl>NAME     READY   STATUS    RESTARTS   AGE   IP             NODE            NOMINATED NODE   READINESS GATES
</span></span><span class=line><span class=cl>coffee   1/1     Running   <span class=m>0</span>          19s   192.168.1.15   k8s-worker-01   &lt;none&gt;           &lt;none&gt;</span></span></code></pre></div><h4 id=start-a-centos-container>Start a CentOS container</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run centos-pod --image<span class=o>=</span>tutum/centos --restart<span class=o>=</span>Never
</span></span><span class=line><span class=cl>pod/centos-pod created</span></span></code></pre></div><h4 id=verify-status-of-the-pod--it-should-be-in-running>verify status of the Pod ; it should be in Running</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>centos-pod   1/1     Running   <span class=m>0</span>          25s
</span></span><span class=line><span class=cl>coffee       1/1     Running   <span class=m>0</span>          2m10s</span></span></code></pre></div><h4 id=logon-to-centos-pod>Logon to CentOS Pod</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it centos-pod -- /bin/bash
</span></span><span class=line><span class=cl><span class=o>[</span>root@centos-pod /<span class=o>]</span><span class=c1>#</span></span></span></code></pre></div><h4 id=verify-coffee-app-status>Verify <code>Coffee</code> App status</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>root@centos-pod /<span class=o>]</span><span class=c1># curl -s 192.168.1.15:9090 |grep &#39;Serving Coffee&#39;</span>
</span></span><span class=line><span class=cl>&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;title&gt;&lt;/title&gt;&lt;body&gt;&lt;div&gt; &lt;h2&gt;Serving Coffee from&lt;/h2&gt;&lt;h3&gt;Pod:coffee&lt;/h3&gt;&lt;h3&gt;IP:192.168.1.15&lt;/h3&gt;&lt;h3&gt;Node:172.16.0.1&lt;/h3&gt;&lt;img <span class=nv>src</span><span class=o>=</span><span class=s2>&#34;data:image/png;base64,
</span></span></span><span class=line><span class=cl><span class=s2>[root@centos-pod /]# exit</span></span></span></code></pre></div><h4 id=delete-pod>Delete pod</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl delete pod coffee centos-pod
</span></span><span class=line><span class=cl>pod <span class=s2>&#34;coffee&#34;</span> deleted
</span></span><span class=line><span class=cl>pod <span class=s2>&#34;centos-pod&#34;</span> deleted
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods
</span></span><span class=line><span class=cl>No resources found.
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=nodes>Nodes</h1><p>In this session , we will explore the node details</p><h4 id=list-nodes>List nodes</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ k8s@k8s-master-01:~$ kubectl get nodes</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME            STATUS   ROLES    AGE   VERSION
</span></span></span><span class=line><span class=cl><span class=go>k8s-master-01   Ready    master   38h   v1.13.1
</span></span></span><span class=line><span class=cl><span class=go>k8s-worker-01   Ready    &lt;none&gt;   38h   v1.13.1
</span></span></span></code></pre></div><h4 id=extended-listing>Extended listing</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get nodes -o wide</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0><code>NAME            STATUS   ROLES    AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
k8s-master-01   Ready    master   38h   v1.13.1   192.168.56.201   &lt;none&gt;        Ubuntu 16.04.5 LTS   4.4.0-131-generic   docker://18.9.0
k8s-worker-01   Ready    &lt;none&gt;   38h   v1.13.1   192.168.56.202   &lt;none&gt;        Ubuntu 16.04.5 LTS   4.4.0-131-generic   docker://18.9.0
k8s@k8s-master-01:~$</code></pre></div><h4 id=details-on-a-node>Details on a node</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl describe node k8s-master-01</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0><code>Name:               k8s-master-01
Roles:              master
Labels:             beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/os=linux
                    kubernetes.io/hostname=k8s-master-01
                    node-role.kubernetes.io/master=
Annotations:        kubeadm.alpha.kubernetes.io/cri-socket: /var/run/dockershim.sock
                    node.alpha.kubernetes.io/ttl: 0
                    projectcalico.org/IPv4Address: 192.168.56.201/24
                    volumes.kubernetes.io/controller-managed-attach-detach: true
CreationTimestamp:  Mon, 31 Dec 2018 02:10:05 +0530
Taints:             node-role.kubernetes.io/master:NoSchedule
Unschedulable:      false
Conditions:
  Type             Status  LastHeartbeatTime                 LastTransitionTime                Reason                       Message
  ----             ------  -----------------                 ------------------                ------                       -------
  MemoryPressure   False   Tue, 01 Jan 2019 17:01:28 +0530   Mon, 31 Dec 2018 02:10:02 +0530   KubeletHasSufficientMemory   kubelet has sufficient memory available
  DiskPressure     False   Tue, 01 Jan 2019 17:01:28 +0530   Mon, 31 Dec 2018 02:10:02 +0530   KubeletHasNoDiskPressure     kubelet has no disk pressure
  PIDPressure      False   Tue, 01 Jan 2019 17:01:28 +0530   Mon, 31 Dec 2018 02:10:02 +0530   KubeletHasSufficientPID      kubelet has sufficient PID available
  Ready            True    Tue, 01 Jan 2019 17:01:28 +0530   Mon, 31 Dec 2018 22:59:35 +0530   KubeletReady                 kubelet is posting ready status. AppArmor enabled
Addresses:
  InternalIP:  192.168.56.201
  Hostname:    k8s-master-01
Capacity:
 cpu:                1
 ephemeral-storage:  49732324Ki
 hugepages-2Mi:      0
 memory:             2048168Ki
 pods:               110
Allocatable:
 cpu:                1
 ephemeral-storage:  45833309723
 hugepages-2Mi:      0
 memory:             1945768Ki
 pods:               110
System Info:
 Machine ID:                 96cedf74a821722b0df5ee775c291ea2
 System UUID:                90E04905-218D-4673-A911-9676A65B07C5
 Boot ID:                    14201246-ab82-421e-94f6-ff0d8ad3ba54
 Kernel Version:             4.4.0-131-generic
 OS Image:                   Ubuntu 16.04.5 LTS
 Operating System:           linux
 Architecture:               amd64
 Container Runtime Version:  docker://18.9.0
 Kubelet Version:            v1.13.1
 Kube-Proxy Version:         v1.13.1
PodCIDR:                     192.168.0.0/24
Non-terminated Pods:         (6 in total)
  Namespace                  Name                                     CPU Requests  CPU Limits  Memory Requests  Memory Limits  AGE
  ---------                  ----                                     ------------  ----------  ---------------  -------------  ---
  kube-system                calico-node-nkcrd                        250m (25%)    0 (0%)      0 (0%)           0 (0%)         38h
  kube-system                etcd-k8s-master-01                       0 (0%)        0 (0%)      0 (0%)           0 (0%)         38h
  kube-system                kube-apiserver-k8s-master-01             250m (25%)    0 (0%)      0 (0%)           0 (0%)         38h
  kube-system                kube-controller-manager-k8s-master-01    200m (20%)    0 (0%)      0 (0%)           0 (0%)         38h
  kube-system                kube-proxy-tzznm                         0 (0%)        0 (0%)      0 (0%)           0 (0%)         38h
  kube-system                kube-scheduler-k8s-master-01             100m (10%)    0 (0%)      0 (0%)           0 (0%)         38h
Allocated resources:
  (Total limits may be over 100 percent, i.e., overcommitted.)
  Resource           Requests    Limits
  --------           --------    ------
  cpu                800m (80%)  0 (0%)
  memory             0 (0%)      0 (0%)
  ephemeral-storage  0 (0%)      0 (0%)
Events:              &lt;none&gt;</code></pre></div><p>We will discuss more about each of the fields on upcoming sessions.
For now lets discuss about <code>Non-terminated Pods</code> field;</p><h4 id=non-terminated-pods-field>Non-terminated Pods field</h4><ul><li>Namespace : The namespace which the Pods were running .
The pods that we create will by default go to <code>default</code> namespace.</li><li>Name : Name of the Pod</li><li>CPU Request : How much CPU resource requested by Pod during startup.</li><li>CPU Limits : How much CPU the Pod can use.</li><li>Memory Request : How much memory requested by Pod during startup.</li><li>Memory Limits : How much memory the Pod can use.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=namespaces>Namespaces</h1><h4 id=what-is-a-namespace>What is a namespace</h4><p>We have see namespaces in Linux , which ideally isolates objects and here also the concept is same but serves a different purpose.
Suppose you have two departments in you organization and both departments have application which needs more fine grained control.
We can use namespaces to separate the workload of each departments.</p><p>By default kubernetes will have three namespace</p><h4 id=list-namespace>List namespace</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get ns
</span></span><span class=line><span class=cl>NAME          STATUS   AGE
</span></span><span class=line><span class=cl>default       Active   39h
</span></span><span class=line><span class=cl>kube-public   Active   39h
</span></span><span class=line><span class=cl>kube-system   Active   39h</span></span></code></pre></div><p>default : All Pods that we manually create will go to this namespace (There are ways to change it , but for now that is what it is).
kube-public : All common workloads can be assigned to this namespace . Most of the time no-one use it.
kube-system : Kubernetes specific Pods will be running on this namespace</p><h4 id=list-pods-in-kube-system-namespace>List Pods in kube-system namespace</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods --namespace<span class=o>=</span>kube-system
</span></span><span class=line><span class=cl>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>calico-node-n99tb                       2/2     Running   <span class=m>0</span>          38h
</span></span><span class=line><span class=cl>calico-node-nkcrd                       2/2     Running   <span class=m>0</span>          38h
</span></span><span class=line><span class=cl>coredns-86c58d9df4-4c22l                1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>coredns-86c58d9df4-b49c2                1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>etcd-k8s-master-01                      1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>kube-apiserver-k8s-master-01            1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>kube-controller-manager-k8s-master-01   1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>kube-proxy-s6hc4                        1/1     Running   <span class=m>0</span>          38h
</span></span><span class=line><span class=cl>kube-proxy-tzznm                        1/1     Running   <span class=m>0</span>          39h
</span></span><span class=line><span class=cl>kube-scheduler-k8s-master-01            1/1     Running   <span class=m>0</span>          39h</span></span></code></pre></div><p>As you can see , there are many Pods running in <code>kube-system</code> namespace
All these Pods were running with one or mode containers
If you see the <code>calico-node-n99tb</code> pod , the <code>READY</code> says 2/2 , which means two containers were running fine in this Pod</p><h4 id=list-all-resources-in-a-namespace>List all resources in a namespace</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get all -n kube-system
</span></span><span class=line><span class=cl>NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>pod/calico-node-kr5xg                       2/2     Running   <span class=m>0</span>          13m
</span></span><span class=line><span class=cl>pod/calico-node-lcpbw                       2/2     Running   <span class=m>0</span>          13m
</span></span><span class=line><span class=cl>pod/coredns-86c58d9df4-h8pjr                1/1     Running   <span class=m>6</span>          26m
</span></span><span class=line><span class=cl>pod/coredns-86c58d9df4-xj24c                1/1     Running   <span class=m>6</span>          26m
</span></span><span class=line><span class=cl>pod/etcd-k8s-master-01                      1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>pod/kube-apiserver-k8s-master-01            1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>pod/kube-controller-manager-k8s-master-01   1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>pod/kube-proxy-fl7rj                        1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>pod/kube-proxy-q6w9l                        1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>pod/kube-scheduler-k8s-master-01            1/1     Running   <span class=m>0</span>          26m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>         AGE
</span></span><span class=line><span class=cl>service/calico-typha   ClusterIP   172.16.244.140   &lt;none&gt;        5473/TCP        13m
</span></span><span class=line><span class=cl>service/kube-dns       ClusterIP   172.16.0.10      &lt;none&gt;        53/UDP,53/TCP   27m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                 AGE
</span></span><span class=line><span class=cl>daemonset.apps/calico-node   <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>       <span class=m>2</span>            <span class=m>2</span>           beta.kubernetes.io/os<span class=o>=</span>linux   13m
</span></span><span class=line><span class=cl>daemonset.apps/kube-proxy    <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>       <span class=m>2</span>            <span class=m>2</span>           &lt;none&gt;                        27m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>deployment.apps/calico-typha   0/0     <span class=m>0</span>            <span class=m>0</span>           13m
</span></span><span class=line><span class=cl>deployment.apps/coredns        2/2     <span class=m>2</span>            <span class=m>2</span>           27m
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                      DESIRED   CURRENT   READY   AGE
</span></span><span class=line><span class=cl>replicaset.apps/calico-typha-5fc4874c76   <span class=m>0</span>         <span class=m>0</span>         <span class=m>0</span>       13m
</span></span><span class=line><span class=cl>replicaset.apps/coredns-86c58d9df4        <span class=m>2</span>         <span class=m>2</span>         <span class=m>2</span>       26m
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=self-healing---readiness>Self Healing - Readiness</h1><h3 id=readiness-probe>Readiness Probe</h3><p>We have seen that our coffee application was listening on port 9090.
Lets assume that the application is not coming up but Pod status showing running.
Everyone will think that application is up.
You entire application stack might get affected because of this.</p><p>So here comes the question , &ldquo;How can I make sure my application is started, not just the Pod ?&rdquo;</p><p>Here we can use Pod spec, <code>Readiness probe</code>.</p><p>Official detention of readinessProbe is , &ldquo;Periodic probe of container service readiness&rdquo;.</p><p>Lets rewrite the Pod specification of Coffee App and add a readiness Probe.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod-readiness.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span></span></span></code></pre></div><h4 id=apply-yaml>Apply Yaml</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f pod-readiness.yaml
</span></span><span class=line><span class=cl>pod/coffee-app created</span></span></code></pre></div><h4 id=verify-pod-status>Verify Pod status</h4><p>Try to identify the difference.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS              RESTARTS   AGE
</span></span><span class=line><span class=cl>coffee-app   0/1     ContainerCreating   <span class=m>0</span>          3s
</span></span><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>coffee-app   0/1     Running   <span class=m>0</span>          25s
</span></span><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>coffee-app   1/1     Running   <span class=m>0</span>          32s</span></span></code></pre></div><h4 id=delete-the-pod>Delete the Pod</h4><p>Yes ,we can delete the objects using the same yaml which we used to create/apply it</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete -f pod-readiness.yaml
</span></span><span class=line><span class=cl>pod <span class=s2>&#34;coffee-app&#34;</span> deleted
</span></span><span class=line><span class=cl>$</span></span></code></pre></div><h4 id=probe-tuning>Probe Tuning.</h4><div class="wrap-code highlight"><pre tabindex=0><code>failureThreshold     &lt;integer&gt;
  Minimum consecutive failures for the probe to be considered failed after
  having succeeded. Defaults to 3. Minimum value is 1.

initialDelaySeconds  &lt;integer&gt;
  Number of seconds after the container has started before liveness probes
  are initiated. More info:
  https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes

periodSeconds        &lt;integer&gt;
  How often (in seconds) to perform the probe. Default to 10 seconds. Minimum
  value is 1.

timeoutSeconds       &lt;integer&gt;
  Number of seconds after which the probe times out. Defaults to 1 second.
  Minimum value is 1. More info:
  https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=self-healing---liveness>Self Healing - Liveness</h1><h3 id=liveness-probe>Liveness Probe</h3><p>Lets assume the application failed after readiness probe execution completes
Again we are back to service unavailability</p><p>To avoid this , we need a liveness check which will do a periodic health check after Pod start running or readiness probe completes.</p><p>Lets rewrite the Pod specification of Coffee App and add a liveness Probe.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod-liveiness.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span></span></span></code></pre></div><h4 id=create-pod>Create <code>Pod</code></h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-liveness.yaml</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=resource-allocation>Resource Allocation</h1><h3 id=limits>Limits</h3><p>We can limit the CPU and Memory usage of a container so that one</p><p>Lets create the coffee Pod again with CPU and Memory limits</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-limits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>123Mi</span></span></span></code></pre></div><p>Resulting container will be allowed to use 100 millicores and 123 mebibyte (<code>~128</code> Megabytes)</p><h4 id=cpu>CPU</h4><p>One CPU core is equivalent to <code>1000m</code> (one thousand millicpu or one thousand millicores)
CPU is always expressed as an absolute quantity, never as a relative quantity; 0.1 is the same amount of <code>CPU</code> on a single-core, dual-core, or 48-core machine</p><h4 id=memory>Memory</h4><p>You can express memory as a plain integer or as a fixed-point integer using one of these suffixes: <code>E, P, T, G, M, K</code>. You can also use the power-of-two equivalents: <code>Ei, Pi, Ti, Gi, Mi, Ki</code>. For example, the following represent roughly the same value:</p><div class="wrap-code highlight"><pre tabindex=0><code class=language-cosole data-lang=cosole>128974848, 129e6, 129M, 123Mi</code></pre></div><h4 id=mebibyte-vs-megabyte>Mebibyte vs Megabyte</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>1 Megabyte (MB) = (1000)^2 bytes = 1000000 bytes.
</span></span></span><span class=line><span class=cl><span class=go>1 Mebibyte (MiB) = (1024)^2 bytes = 1048576 bytes.
</span></span></span></code></pre></div><h3 id=requests>Requests</h3><p>We can request a specific amount of CPU and Memory when the container starts up.</p><p>Suppose if the Java application need at least <code>128MB</code> of memory during startup , we can use resource request in Pod spec.</p><p>This will help the scheduler to select a node with enough memory.</p><p>Request also can be made of <code>CPU</code> as well.</p><p>Lets modify the <code>Pod</code> spec and add <code>request</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-limits</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>123Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>CPU</span><span class=p>:</span><span class=w> </span><span class=l>200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>Memory</span><span class=p>:</span><span class=w> </span><span class=l>244Mi</span></span></span></code></pre></div><h3 id=extra>Extra</h3><p>Once you complete the training , you can visit below URLs to understand storage and network limits.</p><p><a href=https://kubernetes.io/docs/tasks/administer-cluster/limit-storage-consumption/ target=_blank>Storage Limit</a></p><p><a href=https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/#support-traffic-shaping target=_blank>Network bandwidth usage</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 4</div><h1 id=labels--annotations>Labels & Annotations</h1><p>In this session , we will discuss the role of Labels and Annotations , also its role in fundamental k8s design.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Labels & Annotations</h1><article class=default><header class=headline></header><h1 id=annotations>Annotations</h1><h3 id=why-we-need-annotations->Why we need annotations ?</h3><p>We can use either labels or annotations to attach metadata to Kubernetes objects. Labels can be used to select objects and to find collections of objects that satisfy certain conditions. In contrast, annotations are not used to identify and select objects. The metadata in an annotation can be small or large, structured or unstructured, and can include characters not permitted by labels.</p><p>Its just a place to store more metadata which is not used for any selection , grouping or operations.</p><h4 id=annotate-pod>Annotate Pod</h4><p>Lets say , if you want to add a download URL to pod.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl annotate pod coffee-app <span class=nv>url</span><span class=o>=</span>https://hub.docker.com/r/ansilh/demo-webapp
</span></span><span class=line><span class=cl>pod/coffee-app annotated</span></span></code></pre></div><h4 id=view-annotations>View annotations</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>k8s@k8s-master-01:~$ kubectl describe pod coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Name</span><span class=p>:</span><span class=w>               </span><span class=l>coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>          </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Priority</span><span class=p>:</span><span class=w>           </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>PriorityClassName</span><span class=p>:</span><span class=w>  </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Node</span><span class=p>:</span><span class=w>               </span><span class=l>k8s-worker-01/192.168.56.202</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Start Time</span><span class=p>:</span><span class=w>         </span><span class=l>Fri, 04 Jan 2019 00:47:10 +0530</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>             </span><span class=l>app=frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=l>run=coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations:        cni.projectcalico.org/podIP</span><span class=p>:</span><span class=w> </span><span class=m>10.10.1.11</span><span class=l>/32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://hub.docker.com/r/ansilh/demo-webapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Status</span><span class=p>:</span><span class=w>             </span><span class=l>Running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>IP</span><span class=p>:</span><span class=w>                 </span><span class=m>10.10.1.11</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span></span></span></code></pre></div><p><code>Annotations</code> filed containe two entries</p><p><code>cni.projectcalico.org/podIP: 10.10.1.11/32</code></p><p><code>url: https://hub.docker.com/r/ansilh/demo-webapp</code></p><h4 id=remove-annotation>Remove annotation</h4><p>Use same annotate command and mention only key with a dash (-) at the end of the key .
Below command will remove the annotation <code>url: https://hub.docker.com/r/ansilh/demo-webapp</code> from Pod.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl annotate pod coffee-app url-
</span></span><span class=line><span class=cl>pod/coffee-app annotated
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p><code>Annotation</code> after removal.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>k8s@k8s-master-01:~$ kubectl describe pod coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Name</span><span class=p>:</span><span class=w>               </span><span class=l>coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>          </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Priority</span><span class=p>:</span><span class=w>           </span><span class=m>0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>PriorityClassName</span><span class=p>:</span><span class=w>  </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Node</span><span class=p>:</span><span class=w>               </span><span class=l>k8s-worker-01/192.168.56.202</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Start Time</span><span class=p>:</span><span class=w>         </span><span class=l>Fri, 04 Jan 2019 00:47:10 +0530</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>             </span><span class=l>app=frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=l>run=coffee-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations:        cni.projectcalico.org/podIP</span><span class=p>:</span><span class=w> </span><span class=m>10.10.1.11</span><span class=l>/32</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Status</span><span class=p>:</span><span class=w>             </span><span class=l>Running</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>IP</span><span class=p>:</span><span class=w>                 </span><span class=m>10.10.1.11</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=labels>Labels</h1><h3 id=why-we-need-labels->Why we need labels ?</h3><p>If you have a bucket of white dominos and you want to group it based on the number of dots.</p><p>Lets say we want all dominos with 10 dots; we will take domino one by one and if its having 10 dots ,we will put it aside and continue the same operation until all dominos were checked.</p><p>Likewise , suppose if you have 100 pods and few of them are nginx and few of them are centos , how we can see only nginx pods ?</p><p>We need a label on each pod so that we can tell <code>kubectl</code> command to show the pods with that label.</p><p>In kubernetes , label is a key value pair and it provides &lsquo;identifying metadata&rsquo; for objects.
These are fundamental qualities of objects that will be used for grouping , viewing and operating.</p><p>For now we will se how we can view them (Will discuss about grouping and operation on pod groups later)</p><h4 id=pod-labels>Pod labels</h4><p>Lets run a Coffee app Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl run coffee-app --image<span class=o>=</span>ansilh/demo-coffee --restart<span class=o>=</span>Never
</span></span><span class=line><span class=cl>pod/coffee-app created
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>coffee-app   1/1     Running   <span class=m>0</span>          4s
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><h4 id=see-the-labels-of-a-pods>See the labels of a Pods</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods --show-labels
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class=line><span class=cl>coffee-app   1/1     Running   <span class=m>0</span>          37s   <span class=nv>run</span><span class=o>=</span>coffee-app
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>As you can see above , the lables is <code>run=coffee-app</code> which is a key value pair - <code>key</code> is <code>run</code> <code>value</code> is <code>coffee-app</code>.
When we run Pod imperatively , <code>kubectl</code> ass this label to Pod.</p><h4 id=add-custom-label-to-pod>Add custom label to Pod</h4><p>We can add label to Pod using <code>kubectl label</code> command.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl label pod coffee-app <span class=nv>app</span><span class=o>=</span>frontend
</span></span><span class=line><span class=cl>pod/coffee-app labeled
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>Here we have add a label <code>app=frontend</code> to pod <code>coffee-app</code>.</p><h4 id=use-label-selectors>Use label selectors</h4><p>Lets start another coffee application pod with name coffee-app02.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl run coffee-app02 --image<span class=o>=</span>ansilh/demo-coffee --restart<span class=o>=</span>Never
</span></span><span class=line><span class=cl>pod/coffee-app02 created
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>Now we have two Pods.</p><div class="wrap-code highlight"><pre tabindex=0><code>k8s@k8s-master-01:~$ kubectl get pods --show-labels
NAME           READY   STATUS    RESTARTS   AGE    LABELS
coffee-app     1/1     Running   0          5m5s   app=frontend,run=coffee-app
coffee-app02   1/1     Running   0          20s    run=coffee-app02
k8s@k8s-master-01:~$</code></pre></div><p>Lets see how can I select the Pods with label app=frontend.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods --selector<span class=o>=</span><span class=nv>app</span><span class=o>=</span>frontend
</span></span><span class=line><span class=cl>NAME         READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>coffee-app   1/1     Running   <span class=m>0</span>          6m52s
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>You can add as many as label you want.</p><p>We can add a prefix like <code>app</code> ( eg: <code>app/dev=true</code> ) which is also a valid label.</p><table><thead><tr><th>Limitations</th><th></th></tr></thead><tbody><tr><td>Prefix</td><td>DNS subdomain with 256 characters</td></tr><tr><td>Key</td><td>63 characters</td></tr><tr><td>Value</td><td>63 characters</td></tr></tbody></table><h4 id=remove-labels>Remove labels</h4><p>See the labels of coffee-app</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods --show-labels
</span></span><span class=line><span class=cl>NAME           READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class=line><span class=cl>coffee-app     1/1     Running   <span class=m>0</span>          28m   <span class=nv>app</span><span class=o>=</span>frontend,run<span class=o>=</span>coffee-app
</span></span><span class=line><span class=cl>coffee-app02   1/1     Running   <span class=m>0</span>          24m   <span class=nv>run</span><span class=o>=</span>coffee-app02</span></span></code></pre></div><p>Remove the <code>app</code> label</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl label pod coffee-app app-
</span></span><span class=line><span class=cl>pod/coffee-app labeled</span></span></code></pre></div><p>Resulting output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods --show-labels
</span></span><span class=line><span class=cl>NAME           READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span class=line><span class=cl>coffee-app     1/1     Running   <span class=m>0</span>          29m   <span class=nv>run</span><span class=o>=</span>coffee-app
</span></span><span class=line><span class=cl>coffee-app02   1/1     Running   <span class=m>0</span>          24m   <span class=nv>run</span><span class=o>=</span>coffee-app02
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 5</div><h1 id=taints-and-tolerations>Taints and Tolerations</h1><p>Taints and tolerations work together to ensure that pods are not scheduled onto inappropriate nodes.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Taints and Tolerations</h1><article class=default><header class=headline></header><h1 id=taints>Taints</h1><h3 id=why-we-need-taints->Why we need Taints ?</h3><p>Just like labels , one or more taints can be applied to a node; this marks that the node should not accept any pods that do not tolerate the taints</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl taint node k8s-master-ah-01 node-role.kubernetes.io/master<span class=o>=</span><span class=s2>&#34;&#34;</span>:NoSchedule</span></span></code></pre></div><p>Format key=value:Effect</p><h3 id=effects>Effects</h3><p><code>NoSchedule</code> - Pods will not be schedules</p><p><code>PreferNoSchedule</code>- This is a “preference” or “soft” version of <code>NoSchedule</code> – the system will try to avoid placing a pod that does not tolerate the taint on the node, but it is not required.</p><p><code>NoExecute</code> - pod will be evicted from the node (if it is already running on the node), and will not be scheduled onto the node (if it is not yet running on the node)</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tolerations>Tolerations</h1><h3 id=why-we-need-tolerations->Why we need Tolerations ?</h3><p>Tolerations can be specified on Pods
Based on the taints on the nodes , Pods will scheduler will allow to run the Pod on the node.</p><p>Toleration syntax in Pod spec.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 6</div><h1 id=yaml-crash-course>YAML Crash course</h1><p>In this session we will learn k8s YAML specification and object types.
We will cover only k8s dependent YAML specification</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of YAML Crash course</h1><article class=default><header class=headline></header><h1 id=exploring-object-specs>Exploring Object Specs</h1><p>So lets discuss about a new command <code>kubectl explain</code> so that we don&rsquo;t have to remember all YAML specs of kubernetes objects.</p><p>With <code>kubectl explain</code> subcommand , you can see the specification of each objects and can use that as a reference to write your <code>YAML</code> files.</p><h4 id=fist-level-spec>Fist level spec</h4><p>We will use <code>kubectl explain Pod</code> command to see the specifications of a Pod YAML.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl explain Pod</code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0><code>ubuntu@k8s-master-01:~$ kubectl explain pod
KIND:     Pod
VERSION:  v1

DESCRIPTION:
     Pod is a collection of containers that can run on a host. This resource is
     created by clients and scheduled onto hosts.

FIELDS:
   apiVersion	&lt;string&gt;
     APIVersion defines the versioned schema of this representation of an
     object. Servers should convert recognized schemas to the latest internal
     value, and may reject unrecognized values. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md#resources

   kind	&lt;string&gt;
     Kind is a string value representing the REST resource this object
     represents. Servers may infer this from the endpoint the client submits
     requests to. Cannot be updated. In CamelCase. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md#types-kinds

   metadata	&lt;Object&gt;
     Standard object&#39;s metadata. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md#metadata

   spec	&lt;Object&gt;
     Specification of the desired behavior of the pod. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status

   status	&lt;Object&gt;
     Most recently observed status of the pod. This data may not be up to date.
     Populated by the system. Read-only. More info:
     https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status

ubuntu@k8s-master-01:~$</code></pre></div><p>As we discussed earlier , the specification is very familiar.</p><p>Filed <code>status</code> is readonly and its system populated , so we don&rsquo;t have to write anything for <code>status</code>.</p><h4 id=exploring-inner-fields>Exploring inner fields</h4><p>If we want to see the fields available in <code>spec</code> , then execute below command.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl explain pod.spec</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>KIND</span><span class=p>:</span><span class=w>     </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>VERSION</span><span class=p>:</span><span class=w>  </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCE</span><span class=p>:</span><span class=w> </span><span class=l>spec &lt;Object&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>DESCRIPTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>Specification of the desired behavior of the pod. More info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>PodSpec is a description of a pod.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FIELDS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>containers	&lt;[]Object&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>List of containers belonging to the pod. Containers cannot currently be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>added or removed. There must be at least one container in a Pod. Cannot be</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>updated.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>...</span></span></span></code></pre></div><p>How easy is that.</p><p>As you can see in spec the <code>containers</code> filed is <code>-required-</code> which indicates that this filed is mandatory.</p><p><code>&lt;[]Object></code> indicates that its an array of objects , which means , you can put more than one element under <code>containers</code></p><p>That make sense , because the <code>Pod</code> may contain more than one container.</p><p>In YAML we can use <code>-</code> infront of a filed to mark it as an array element.</p><p>Lets take a look at the YAML that we wrote earlier</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span></span></span></code></pre></div><p>There is a <code>-</code> under the fist filed of the <code>containers</code>.
If we say that in words ; &ldquo;containers is an array object which contains one array element with filed <code>name</code> and <code>image</code>&rdquo;</p><p>If you want to add one more container in Pod , we will add one more array element with needed values.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-tea</span></span></span></code></pre></div><p>Now the Pod have two containers .</p><p>How I know the containers array element need <code>name</code> and <code>image</code> ?</p><p>We will use explain command to get those details.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl explain pod.spec.containers</span></span></code></pre></div><p>Snipped Output</p><div class="wrap-code highlight"><pre tabindex=0><code>...
name	&lt;string&gt; -required-
  Name of the container specified as a DNS_LABEL. Each container in a pod
  must have a unique name (DNS_LABEL). Cannot be updated.

image	&lt;string&gt;
  Docker image name
...</code></pre></div><p>As you can see , <code>name</code> and <code>image</code> are of type <code>string</code> which means , you have to provide a string value to it.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=k8s-yaml-structure>K8S YAML structure</h1><h3 id=what-is-yaml->What is YAML ?</h3><p>Yet Another Markup Language</p><p>Kubernetes YAML have below structure</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>spec:</span></span></span></code></pre></div><h4 id=apiversion>apiVersion:</h4><p>Kubernetes have different versions of API for each objects.
We discuss about API in detail in upcoming sessions.
For now , lets keep it simple as possible.</p><p>Pod is one of the <code>kind</code> of object which is part of core v1 API
So for a Pod, we usually see <code>apiVersion: v1</code></p><h4 id=kind>kind:</h4><p>As explained above we specify the <code>kind</code> of API object with <code>kind:</code> field.</p><h4 id=metadata>metadata:</h4><p>We have seen the use of metadata earlier.</p><p>As the name implies , we usually store name of object and labels in metadata field.</p><h4 id=spec>spec:</h4><p>Object specification will go hear.
The specification will depend on the <code>kind</code> and <code>apiVersion</code> we use</p><h4 id=exploring-pod-spec>Exploring <code>Pod</code> spec</h4><p>Lets write a Pod specification YAML</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee-app01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span></span></span></code></pre></div><p>In above specification , you can see that we have specified <code>name</code> and <code>labels</code> in matadata field.</p><p>The <code>spec</code> starts with <code>cotainer</code> field and we have added a container specification under it.</p><p>You might be wondering , how can we memories all these options.
In reality , you don&rsquo;t have to.</p><p>We will discuss about it in next session.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 7</div><h1 id=services>Services</h1><p>In this session we will solve the maze
<a href=#R-image-0dd60d9955acb9b9160c09f4011bd44f class=lightbox-link><img src="./07-services/services.png?classes=shadow" alt=maze class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0dd60d9955acb9b9160c09f4011bd44f><img src="./07-services/services.png?classes=shadow" alt=maze class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Services</h1><article class=default><header class=headline></header><h1 id=expose-services-in-pod>Expose services in Pod</h1><h3 id=service>Service</h3><p>A Coffee Pod running in cluster and its listening on port 9090 on Pod&rsquo;s IP.
How can we expose that service to external world so that users can access it ?</p><p><a href=#R-image-a50328e5b128b431327ecf4064f5776f class=lightbox-link><img src="./07-services/01-expose-pod/pod-service.png?classess=shadow" alt=Pod class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a50328e5b128b431327ecf4064f5776f><img src="./07-services/01-expose-pod/pod-service.png?classess=shadow" alt=Pod class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>We need to <code>expose</code> the service.</p><p>As we know , the Pod IP is not routable outside of the cluster.
So we need a mechanism to reach the host&rsquo;s port and then that traffic should be diverted to Pod&rsquo;s port.</p><p>Lets create a Pod Yaml first.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi coffe.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span></span></span></code></pre></div><p>Create Yaml</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl create -f coffe.yaml</code></pre></div><p>Expose the Pod with below command</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl expose pod coffee --port=80 --target-port=9090  --type=NodePort</code></pre></div><p>This will create a <code>Service</code> object in kubernetes , which will map the Node&rsquo;s port 30836 to <code>Service</code> IP/Port 192.168.10.86:80</p><p>We can see the derails using <code>kubectl get service</code> command</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get service
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
coffee       NodePort    192.168.10.86    &lt;none&gt;        80:30391/TCP   6s
kubernetes   ClusterIP   192.168.10.1     &lt;none&gt;        443/TCP        26h</code></pre></div><p>We can also see that the port is listening and kube-proxy is the one listening on that port.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ sudo netstat -tnlup |grep 30836
tcp6       0      0 :::30391                :::*                    LISTEN      2785/kube-proxy</code></pre></div><p>Now you can open browser and access the <code>Coffee</code> app using URL <code>http://192.168.56.201:30391</code></p><h2 id=ports-in-service-objects>Ports in Service Objects</h2><h3 id=nodeport>nodePort</h3><p>This setting makes the service visible outside the Kubernetes cluster by the node’s IP address and the port number declared in this property. The service also has to be of type NodePort (if this field isn’t specified, Kubernetes will allocate a node port automatically).</p><h3 id=port>port</h3><p>Expose the service on the specified port internally within the cluster. That is, the service becomes visible on this port, and will send requests made to this port to the pods selected by the service.</p><h3 id=targetport>targetPort</h3><p>This is the port on the pod that the request gets sent to. Your application needs to be listening for network requests on this port for the service to work.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=nodeport>NodePort</h1><p>NodePort Exposes the service on each Node’s IP at a static port (the NodePort). A ClusterIP service, to which the NodePort service will route, is automatically created. You’ll be able to contact the NodePort service, from outside the cluster, by requesting <nodeip>:<nodeport>.</p><h4 id=how-nodeport-works>How <code>nodePort</code> works</h4><p><a href=#R-image-67f9f9b43b552c225dd37bbd091e6563 class=lightbox-link><img src="./07-services/02-nodeport/pod-service-nodeport.png?classes=shadow" alt=NodePort class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-67f9f9b43b552c225dd37bbd091e6563><img src="./07-services/02-nodeport/pod-service-nodeport.png?classes=shadow" alt=NodePort class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>kube-proxy watches the Kubernetes master for the addition and removal of Service and Endpoints objects.</p><p>(We will discuss about <code>Endpoints</code> later in this session.)</p><p>For each <code>Service</code>, it opens a port (randomly chosen) on the local node. Any connections to this “proxy port” will be proxied to one of the Service’s backend Pods (as reported in Endpoints). Lastly, it installs iptables rules which capture traffic to the Service’s <code>clusterIP</code> (which is virtual) and Port and redirects that traffic to the proxy port which proxies the backend Pod.</p><h4 id=nodeport-workflow><code>nodePort</code> workflow.</h4><ol><li><p><code>nodePort</code> -> <code>30391</code></p></li><li><p><code>port</code> -> <code>80</code></p></li><li><p><code>targetPort</code> -> <code>9090</code></p></li></ol><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=clusterip>ClusterIP</h1><p>It exposes the service on a cluster-internal IP.</p><p>When we expose a pod using <code>kubectl expose</code> command , we are creating a service object in API.</p><p>Choosing this value makes the service only reachable from within the cluster. <strong>This is the default ServiceType</strong>.</p><p>We can see the <code>Service</code> spec using <code>--dry-run</code> & <code>--output=yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl expose pod coffee --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>9090</span>  --type<span class=o>=</span>ClusterIP --dry-run --output<span class=o>=</span>yaml
</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Cluster IP service is useful when you don&rsquo;t want to expose the service to external world. eg:- database service.</p><p>With service names , a frontend tier can access the database backend without knowing the IPs of the Pods.</p><p>CoreDNS (kube-dns) will dynamically create a service DNS entry and that will be resolvable from Pods.</p><h4 id=verify-service-dns>Verify Service DNS</h4><p>Start debug-tools container which is an alpine linux image with network related binaries</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run debugger --image<span class=o>=</span>ansilh/debug-tools --restart<span class=o>=</span>Never</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it debugger -- /bin/sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1># nslookup coffee</span>
</span></span><span class=line><span class=cl>Server:         192.168.10.10
</span></span><span class=line><span class=cl>Address:        192.168.10.10#53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:   coffee.default.svc.cluster.local
</span></span><span class=line><span class=cl>Address: 192.168.10.86
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1># nslookup 192.168.10.86</span>
</span></span><span class=line><span class=cl>86.10.168.192.in-addr.arpa      <span class=nv>name</span> <span class=o>=</span> coffee.default.svc.cluster.local.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1>#</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=err>coffee.default.svc.cluster.local</span>
</span></span><span class=line><span class=cl>  <span class=na>^</span>      <span class=s>^      ^    k8s domain</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>|      |  |-----------|</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>|      +--------------- Indicates that its a service</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>+---------------------- Namespace</span>
</span></span><span class=line><span class=cl>  <span class=na>+-----------------------------</span> <span class=s>Service Name</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=loadbalancer>LoadBalancer</h1><p>Exposes the service externally using a cloud provider’s load balancer. NodePort and ClusterIP services, to which the external load balancer will route, are automatically created.</p><p>We will discuss more about this topic later in this training.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=endpoints>Endpoints</h1><h3 id=pods-behind-a-service>Pods behind a service.</h3><p><a href=#R-image-8846a5e7a8905e57246e5590756c5673 class=lightbox-link><img src="./07-services/05-endpoints/nodeport.png?classes=shadow" alt=NodePod class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8846a5e7a8905e57246e5590756c5673><img src="./07-services/05-endpoints/nodeport.png?classes=shadow" alt=NodePod class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
Lets <code>describe</code> the service to see how the mapping of Pods works in a service object.</p><p>(Yes , we are slowly moving from general wordings to pure kubernetes terms)</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl describe service coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Name</span><span class=p>:</span><span class=w>                     </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>                </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>                   </span><span class=l>run=coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations</span><span class=p>:</span><span class=w>              </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Selector</span><span class=p>:</span><span class=w>                 </span><span class=l>run=coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Type</span><span class=p>:</span><span class=w>                     </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>IP</span><span class=p>:</span><span class=w>                       </span><span class=m>192.168.10.86</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Port</span><span class=p>:</span><span class=w>                     </span><span class=l>&lt;unset&gt;  80/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>TargetPort</span><span class=p>:</span><span class=w>               </span><span class=m>9090</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NodePort</span><span class=p>:</span><span class=w>                 </span><span class=l>&lt;unset&gt;  30391/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Endpoints</span><span class=p>:</span><span class=w>                </span><span class=m>10.10.1.13</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Session Affinity</span><span class=p>:</span><span class=w>         </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>External Traffic Policy</span><span class=p>:</span><span class=w>  </span><span class=l>Cluster</span></span></span></code></pre></div><p>Here the label <code>run=coffee</code> is the one which creates the mapping from service to Pod.</p><p>Any pod with label <code>run=coffee</code> will be mapped under this service.</p><p>Those mappings are called <code>Endpoints</code>.</p><p>Lets see the <code>endpoints</code> of <code>service</code> <code>coffee</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get endpoints  coffee
</span></span><span class=line><span class=cl>NAME     ENDPOINTS         AGE
</span></span><span class=line><span class=cl>coffee   10.10.1.13:9090   3h48m</span></span></code></pre></div><p>As of now only one pod endpoint is mapped under this service.</p><p>lets create one more Pod with same label and see how it affects endpoints.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl run coffee01 --image=ansilh/demo-coffee --restart=Never --labels=run=coffee</code></pre></div><p>Now we have one more Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods
NAME       READY   STATUS    RESTARTS   AGE
coffee     1/1     Running   0          15h
coffee01   1/1     Running   0          6s</code></pre></div><p>Lets check the endpoint</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get endpoints  coffee
NAME     ENDPOINTS                         AGE
coffee   10.10.1.13:9090,10.10.1.19:9090   3h51m</code></pre></div><p>Now we have two Pod endpoints mapped to this service.
So the requests comes to coffee service will be served from these pods in a round robin fashion.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 8</div><h1 id=multi-container-pods>Multi-Container Pods</h1><p>In this session we will create Pods with more than one containers and few additional features in k8s.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Multi-Container Pods</h1><article class=default><header class=headline></header><h1 id=initcontainer>InitContainer</h1><p><a href=#R-image-7c0c8bac49ea5574b34d968200e37c2f class=lightbox-link><img src="./08-multi_container_pod/03-init-container/initcontainer.png?classes=shadow&amp;width=30pc" alt=InitContainer class="figure-image bg-white border lightbox shadow" style=height:auto;width:30pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7c0c8bac49ea5574b34d968200e37c2f><img src="./08-multi_container_pod/03-init-container/initcontainer.png?classes=shadow&amp;width=30pc" alt=InitContainer class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
In this session , we will discuss about InitContainer</p><h3 id=non-persistent-web-server>Non-persistent web server</h3><p>As we already know ,containers are ephemeral and the modifications will be lost when container is destroyed.</p><p>In this example , we will download webpages from Github repository and store it in a <code>emptyDir</code> volume.</p><p>From this emptyDir volume , we will serve the HTML pages using an Nginx Pod</p><p><code>emptyDir</code> is a volume type , just like hostPath , but the contents of <code>emptyDir</code> will be destroyed when Pod is stopped.</p><p>So lets write a Pod specification for Nginx container and add InitContainer to download HTML page</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-pull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>clone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://github.com/ansilh/k8s-demo-web.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/html/.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/html/</span></span></span></code></pre></div><p>Problem with this design is , no way to pull the changes once Pod is up.
InitContainer run only once during the startup of the Pod.</p><p>Incase of InitContainer failure , Pod startup will fail and never start other containers.</p><p>We can specify more than one initcontainer if needed.
Startup of initcontainer will be sequential and the order will be selected based on the order in yaml spec.</p><p>In next session , we will discuss about other design patterns for Pod.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=inject-data-to-pod>Inject data to Pod</h1><h3 id=inject-data-to-pod-via-environmental-variable>Inject data to pod via Environmental variable</h3><p>We will create a Coffee Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run tea --image<span class=o>=</span>ansilh/demo-tea --env<span class=o>=</span><span class=nv>MY_NODE_NAME</span><span class=o>=</span>scratch --restart<span class=o>=</span>Never --dry-run -o yaml &gt;pod-with-env.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>scratch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Lets run this Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-with-env.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS              RESTARTS   AGE
</span></span><span class=line><span class=cl>tea          1/1     Running   <span class=m>0</span>          7s</span></span></code></pre></div><p>Lets expose the pod as <code>NodePort</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl expose pod tea --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>8080</span> --type<span class=o>=</span>NodePort</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get svc tea
</span></span><span class=line><span class=cl>NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
</span></span><span class=line><span class=cl>tea    NodePort   192.168.10.37   &lt;none&gt;        80:32258/TCP   42s</span></span></code></pre></div><p>Access the service using browser uisng node IP and port <code>32258</code></p><p>You will see below in Page
<code>Node:scratch</code></p><h3 id=expose-pod-fields-to-containers>Expose Pod fields to containers</h3><p>Lets extract the <code>nodeName</code> from spec ( Excuse me ? yeah we will see that in a moment )</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.nodeName}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>k8s-worker-01
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.hostIP}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>192.168.56.202
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.podIP}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>10.10.1.23
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>To get the JSON path , first we need to get the entire object output in JSON.
We have used output in <code>YAML</code> so far because its easy . But internally <code>kubectl</code> convers <code>YAML</code> to <code>JSON</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pod tea -o json</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;apiVersion&#34;: </span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;kind&#34;: </span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;metadata&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;annotations&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;cni.projectcalico.org/podIP&#34;: </span><span class=s2>&#34;10.10.1.23/32&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;creationTimestamp&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;labels&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;run&#34;: </span><span class=s2>&#34;tea&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;namespace&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;resourceVersion&#34;: </span><span class=s2>&#34;218696&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;selfLink&#34;: </span><span class=s2>&#34;/api/v1/namespaces/default/pods/tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;uid&#34;: </span><span class=s2>&#34;14c1715b-11c5-11e9-9f0f-0800276a1bd2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;spec&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;containers&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;env&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;MY_NODE_NAME&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;value&#34;: </span><span class=s2>&#34;scratch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;image&#34;: </span><span class=s2>&#34;ansilh/demo-tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;imagePullPolicy&#34;: </span><span class=s2>&#34;Always&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;coffee-new&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;resources&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;terminationMessagePath&#34;: </span><span class=s2>&#34;/dev/termination-log&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;terminationMessagePolicy&#34;: </span><span class=s2>&#34;File&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;volumeMounts&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;mountPath&#34;: </span><span class=s2>&#34;/var/run/secrets/kubernetes.io/serviceaccount&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;readOnly&#34;: </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;dnsPolicy&#34;: </span><span class=s2>&#34;ClusterFirst&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;enableServiceLinks&#34;: </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;nodeName&#34;: </span><span class=s2>&#34;k8s-worker-01&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;priority&#34;: </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;restartPolicy&#34;: </span><span class=s2>&#34;Never&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;schedulerName&#34;: </span><span class=s2>&#34;default-scheduler&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;securityContext&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;serviceAccount&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;serviceAccountName&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;terminationGracePeriodSeconds&#34;: </span><span class=m>30</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;tolerations&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;effect&#34;: </span><span class=s2>&#34;NoExecute&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;node.kubernetes.io/not-ready&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;operator&#34;: </span><span class=s2>&#34;Exists&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;tolerationSeconds&#34;: </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;effect&#34;: </span><span class=s2>&#34;NoExecute&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;operator&#34;: </span><span class=s2>&#34;Exists&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;tolerationSeconds&#34;: </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;volumes&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;secret&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;defaultMode&#34;: </span><span class=m>420</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;secretName&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;status&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;conditions&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;Initialized&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;Ready&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;ContainersReady&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;PodScheduled&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;containerStatuses&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;containerID&#34;: </span><span class=s2>&#34;docker://291a72e7fdab6a9f7afc47c640126cf596f5e071903b6a9055b44ef5bcb1c104&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;image&#34;: </span><span class=s2>&#34;ansilh/demo-tea:latest&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;imageID&#34;: </span><span class=s2>&#34;docker-pullable://ansilh/demo-tea@sha256:998d07a15151235132dae9781f587ea4d2822c62165778570145b0f659dda7bb&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastState&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;coffee-new&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;ready&#34;: </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;restartCount&#34;: </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;state&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;running&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;startedAt&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;hostIP&#34;: </span><span class=s2>&#34;192.168.56.202&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;phase&#34;: </span><span class=s2>&#34;Running&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;podIP&#34;: </span><span class=s2>&#34;10.10.1.23&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;qosClass&#34;: </span><span class=s2>&#34;BestEffort&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;startTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}</span></span></code></pre></div><p>Remove below from <code>pod-with-env.yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>scratch</span></span></span></code></pre></div><p>Add below Pod spec</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>spec.nodeName</span></span></span></code></pre></div><p>Resulting Pod Yaml</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>spec.nodeName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Delete the running pod files</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod tea</span></span></code></pre></div><p>Create the pod with modified yaml file</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-with-env.yaml</span></span></code></pre></div><p>Make sure <code>endpoint</code> is up in <code>service</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get ep tea
</span></span><span class=line><span class=cl>NAME   ENDPOINTS         AGE
</span></span><span class=line><span class=cl>tea    10.10.1.26:8080   31m</span></span></code></pre></div><p>Refresh the browser page. This time you will see <code>Node:k8s-worker-01</code></p><p>Lets do a cleanup on <code>default</code> namespace.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete --all pods
</span></span><span class=line><span class=cl>$ kubectl delete --all services</span></span></code></pre></div><p>Now you know</p><ul><li>How to use export Objects in Yaml and Json format</li><li>How to access each fields using <code>jsonpath</code></li><li>How to inject environmental variables to <code>Pod</code></li><li>How to inject system generated fields to <code>Pod</code> using environmental variables</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=introduction-to-volumes>Introduction to Volumes</h1><h3 id=persistent-volumes>Persistent volumes</h3><p>When a Pod dies , all container&rsquo;s contents will be destroyed and never preserved by default.
Sometimes you need to store the contents persistently (for eg:- etcd pod)</p><p>Kubernetes have a <code>Volumes</code> filed in Pod spec , which can be used to mount a volume inside container.</p><p><a href=#R-image-957c6f83f4b906747bc56e0ddf7800e6 class=lightbox-link><img src="./08-multi_container_pod/02-volumes/volumes.png?classes=shadow" alt=volumes class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-957c6f83f4b906747bc56e0ddf7800e6><img src="./08-multi_container_pod/02-volumes/volumes.png?classes=shadow" alt=volumes class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>Lets explain the volume specs</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl explain pod.spec.volumes</span></span></code></pre></div><p>So when you write Yaml , you have to put <code>volumes</code> object in <code>spec</code>. As we have seen , <code>volumes</code> type is <code>&lt;[]Object></code> ; means its an array</p><p>So the contents below volumes should start with a dash &ldquo;-&rdquo;.
Name is a mandatory field , so lets write those.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span></span></span></code></pre></div><p>We will use <code>hostPath</code> for now</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl explain pod.spec.volumes.hostPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>KIND</span><span class=p>:</span><span class=w>     </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>VERSION</span><span class=p>:</span><span class=w>  </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCE</span><span class=p>:</span><span class=w> </span><span class=l>hostPath &lt;Object&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>DESCRIPTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>HostPath represents a pre-existing file or directory on the host machine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>that is directly exposed to the container. This is generally used for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>system agents or other privileged things that are allowed to see the host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>machine. Most containers will NOT need this. More info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Represents a host path mapped into a pod. Host path volumes do not support</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>ownership management or SELinux relabeling.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FIELDS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>path &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path of the directory on the host. If the path is a symlink, it will follow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>the link to the real path. More info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>type &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Type for HostPath Volume Defaults to &#34;&#34; More info:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>k8s@k8s-master-01:~$</span></span></span></code></pre></div><p>Host path needs a path on the host , so lets add that as well to the <code>spec</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span></span></span></code></pre></div><p>This will add a volume to <code>Pod</code></p><p>Now we have to tell the pods to use it.</p><p>In <code>containers</code> specification, we have <code>volumeMounts</code> field which can be used to <code>mount</code> the <code>volume</code>.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl explain pod.spec.containers.volumeMounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>KIND</span><span class=p>:</span><span class=w>     </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>VERSION</span><span class=p>:</span><span class=w>  </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCE</span><span class=p>:</span><span class=w> </span><span class=l>volumeMounts &lt;[]Object&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>DESCRIPTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Pod volumes to mount into the container&#39;s filesystem. Cannot be updated.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>VolumeMount describes a mounting of a Volume within a container.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FIELDS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>mountPath    &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path within the container at which the volume should be mounted. Must not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>contain &#39;:&#39;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>mountPropagation     &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>mountPropagation determines how mounts are propagated from the host to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>container and the other way around. When not set, MountPropagationNone is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>used. This field is beta in 1.10.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>name &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>This must match the Name of a Volume.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>readOnly     &lt;boolean&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Mounted read-only if true, read-write otherwise (false or unspecified).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Defaults to false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>subPath      &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path within the volume from which the container&#39;s volume should be mounted.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Defaults to &#34;&#34; (volume&#39;s root).</span></span></span></code></pre></div><p><code>volumeMounts</code> is <code>&lt;[]Object></code> . <code>mountPath</code> is required and <code>name</code></p><p><code>name</code> must match the Name of a <code>Volume</code></p><p>Resulting <code>Pod</code> <code>spec</code> will become ;</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/usr/share/nginx/html&#34;</span></span></span></code></pre></div><p>Lets add the basic fields to complete the Yaml and save the file as <code>nginx.yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/usr/share/nginx/html&#34;</span></span></span></code></pre></div><p>Create the <code>Pod</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f nginx.yaml</span></span></code></pre></div><p>Check where its running.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods -o wide
NAME          READY   STATUS    RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES
nginx-pod01   1/1     Running   0          55s   10.10.1.27   k8s-worker-01   &lt;none&gt;           &lt;none&gt;</code></pre></div><p>Lets expose this Pod first.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl expose pod nginx-pod01 --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>error</span><span class=o>:</span> <span class=s>couldn&#39;t retrieve selectors via --selector flag or introspection: the pod has no labels and cannot be exposed</span>
</span></span><span class=line><span class=cl><span class=na>See</span> <span class=s>&#39;kubectl expose -h&#39; for help and examples.</span></span></span></code></pre></div><p>This indicates that we didn&rsquo;t add <code>label</code> , because the <code>service</code> needs a label to map the Pod to <code>endpoint</code></p><p>Lets add a label to the Pod.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl label pod nginx-pod01 run=nginx-pod01</code></pre></div><p>Now we can we can expose the Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl expose pod nginx-pod01 --port=80 --target-port=80 --type=NodePort</code></pre></div><p>Get the node port which service is listening to</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get svc nginx-pod01
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
nginx-pod01   NodePort   192.168.10.51   &lt;none&gt;        80:31538/TCP   26s</code></pre></div><p>You will get <code>403 Forbidden</code> page , because there is no html page to load.</p><p>Now we can go to the node where the Pod is running and check the path <code>/var/data</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:~$ ls -ld /var/data
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 root root 4096 Jan  7 00:52 /var/data
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:~$ cd /var/data
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$ ls -lrt
</span></span></span><span class=line><span class=cl><span class=go>total 0
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$
</span></span></span></code></pre></div><p>Nothing is there.The directory is owned by root , so you have to create the file <code>index.html</code> with root.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$ sudo -i
</span></span></span><span class=line><span class=cl><span class=go>[sudo] password for k8s:
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:~# cd /var/data
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data#
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data# echo &#34;This is a test page&#34; &gt;index.html
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data#
</span></span></span></code></pre></div><p>Reload the web page and you should see &ldquo;This is a test page&rdquo;</p><p>Now you know;</p><ul><li>How to create a volume.</li><li>How to mount a volume.</li><li>How to access the contents of volume from host.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pod---manual-scheduling>Pod - manual scheduling</h1><h3 id=node-selector>Node Selector</h3><p>Suppose you have a Pod which needs to be running on a Pod which is having SSD in it.</p><p>First we need to add a label to the node which is having SSD</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl label node k8s-worker-01 <span class=nv>disktype</span><span class=o>=</span>ssd</span></span></code></pre></div><p>Now we can write a Pod spec with <code>nodeSelector</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span></span></span></code></pre></div><p>Scheduler will look at the node selector and select apropriate node to run the pod</p><h3 id=nodename>nodeName</h3><ul><li>Kube-scheduler will find a suitable pod by evaluating the constraints.</li><li>Scheduler will modify the value of .spec.nodeName of Pod object .</li><li>kubelet will observe the change via API server and will start the pod based on the specification.</li></ul><p>This means , we can manually specify the <code>nodeName</code> in <code>Pod</code> spec and schedule it.</p><p>You can read more about <code>nodeName</code> in below URL
<a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodename target=_blank>https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodename</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pod-design-patterns>Pod design patterns</h1><p>When the containers have the exact same lifecycle, or when the containers must run on the same node. The most common scenario is that you have a helper process that needs to be located and managed on the same node as the primary container.</p><p>Another reason to combine containers into a single pod is for simpler communication between containers in the pod. These containers can communicate through shared volumes (writing to a shared file or directory) and through inter-process communication (semaphores or shared memory).</p><p>There are three common design patterns and use-cases for combining multiple containers into a single pod. We’ll walk through the <code>sidecar</code> pattern, the <code>adapter</code> pattern, and the <code>ambassador</code> pattern.</p><h3 id=example-1-sidecar-containers>Example #1: Sidecar containers</h3><p>Sidecar containers extend and enhance the “main” container, they take existing containers and make them better. As an example, consider a container that runs the Nginx web server. Add a different container that syncs the file system with a git repository, share the file system between the containers and you have built Git push-to-deploy.</p><p><a href=#R-image-10135bf747b4ddeabb309fcbb0b3a8c4 class=lightbox-link><img src="./08-multi_container_pod/04-pod-patterns/sidecar.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-10135bf747b4ddeabb309fcbb0b3a8c4><img src="./08-multi_container_pod/04-pod-patterns/sidecar.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-pull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;while true ; do [ ! -d /html/.git ] &amp;&amp; git  clone https://github.com/ansilh/k8s-demo-web.git /html/ || { cd /html; git pull; } ; date; sleep 5 ; done&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/html/</span></span></span></code></pre></div><p>Lets do a tail on the <code>logs</code> and see how the <code>git-pull</code> works</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl logs demo-web git-pull -f
</span></span><span class=line><span class=cl>Cloning into <span class=s1>&#39;/html&#39;</span>...
</span></span><span class=line><span class=cl>Fri Jan <span class=m>11</span> 20:39:25 UTC <span class=m>2019</span>
</span></span><span class=line><span class=cl>Already up to date.
</span></span><span class=line><span class=cl>Fri Jan <span class=m>11</span> 20:39:31 UTC <span class=m>2019</span></span></span></code></pre></div><p>Lets modify the WebPage and push the changes to Github</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Already up to date.
</span></span></span><span class=line><span class=cl><span class=go>Fri Jan 11 20:44:04 UTC 2019
</span></span></span><span class=line><span class=cl><span class=go>From https://github.com/ansilh/k8s-demo-web
</span></span></span><span class=line><span class=cl><span class=go>   e2df24f..1791ee1  master     -&gt; origin/master
</span></span></span><span class=line><span class=cl><span class=go>Updating e2df24f..1791ee1
</span></span></span><span class=line><span class=cl><span class=go>Fast-forward
</span></span></span><span class=line><span class=cl><span class=go> images/pic-k8s.jpg | Bin 0 -&gt; 14645 bytes
</span></span></span><span class=line><span class=cl><span class=go> index.html         |   4 ++--
</span></span></span><span class=line><span class=cl><span class=go> 2 files changed, 2 insertions(+), 2 deletions(-)
</span></span></span><span class=line><span class=cl><span class=go> create mode 100644 images/pic-k8s.jpg
</span></span></span><span class=line><span class=cl><span class=go>Fri Jan 11 20:44:10 UTC 2019
</span></span></span><span class=line><span class=cl><span class=go>Already up to date.
</span></span></span></code></pre></div><h3 id=example-2-ambassador-containers>Example #2: Ambassador containers</h3><p>Ambassador containers proxy a local connection to the world. As an example, consider a Redis cluster with read-replicas and a single write master. You can create a Pod that groups your main application with a Redis ambassador container. The ambassador is a proxy is responsible for splitting reads and writes and sending them on to the appropriate servers. Because these two containers share a network namespace, they share an IP address and your application can open a connection on “localhost” and find the proxy without any service discovery. As far as your main application is concerned, it is simply connecting to a Redis server on localhost. This is powerful, not just because of separation of concerns and the fact that different teams can easily own the components, but also because in the development environment, you can simply skip the proxy and connect directly to a Redis server that is running on localhost.</p><p><a href=#R-image-82fde8dc25aa5eaa7c8e3ead31e625f2 class=lightbox-link><img src="./08-multi_container_pod/04-pod-patterns/ambassador.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-82fde8dc25aa5eaa7c8e3ead31e625f2><img src="./08-multi_container_pod/04-pod-patterns/ambassador.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h3 id=example-3-adapter-containers>Example #3: Adapter containers</h3><p>Adapter containers standardize and normalize output. Consider the task of monitoring N different applications. Each application may be built with a different way of exporting monitoring data. (e.g. JMX, StatsD, application specific statistics) but every monitoring system expects a consistent and uniform data model for the monitoring data it collects. By using the adapter pattern of composite containers, you can transform the heterogeneous monitoring data from different systems into a single unified representation by creating Pods that groups the application containers with adapters that know how to do the transformation. Again because these Pods share namespaces and file systems, the coordination of these two containers is simple and straightforward.</p><p><a href=#R-image-332d83fecf1e4431e1757da2a38702ce class=lightbox-link><img src="./08-multi_container_pod/04-pod-patterns/adapter.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-332d83fecf1e4431e1757da2a38702ce><img src="./08-multi_container_pod/04-pod-patterns/adapter.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=taints-and-tolerations>Taints and Tolerations</h1><p>You add a taint to a node using kubectl taint. For example,</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl taint nodes k8s-worker-02 <span class=nv>key</span><span class=o>=</span>value:NoSchedule</span></span></code></pre></div><p>places a taint on node node1. The taint has key key, value value, and taint effect <code>NoSchedule</code>. This means that no pod will be able to schedule onto node1 unless it has a matching toleration.</p><p>To remove the taint added by the command above, you can run:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl taint nodes k8s-worker-02 key:NoSchedule-</span></span></code></pre></div><p>You specify a toleration for a pod in the <code>PodSpec</code>. Both of the following tolerations “match” the taint created by the <code>kubectl</code> taint line above, and thus a pod with either toleration would be able to schedule onto node1:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>tolerations:
- key: &#34;key&#34;
  operator: &#34;Exists&#34;
  effect: &#34;NoSchedule&#34;</code></pre></div><p>A toleration “matches” a taint if the keys are the same and the effects are the same, and:</p><ul><li>the operator is Exists (in which case no value should be specified), or</li><li>the operator is Equal and the values are equal
Operator defaults to Equal if not specified.</li></ul><p>The above example used effect of <code>NoSchedule</code>. Alternatively, you can use effect of <code>PreferNoSchedule</code>. This is a “preference” or “soft” version of <code>NoSchedule</code> – the system will try to avoid placing a pod that does not tolerate the taint on the node, but it is not required. The third kind of effect is NoExecute</p><p>Normally, if a taint with effect <code>NoExecute</code> is added to a node, then any pods that do not tolerate the taint will be evicted immediately, and any pods that do tolerate the taint will never be evicted. However, a toleration with <code>NoExecute</code> effect can specify an optional <code>tolerationSeconds</code> field that dictates how long the pod will stay bound to the node after the taint is added. For example,</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 9</div><h1 id=api-reference>API reference</h1><p>In this session we will explore k8s API , Objects and Versioning</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of API reference</h1><article class=default><header class=headline></header><h1 id=api-access>API Access</h1><p>Lets explore how API defines and organizes objects</p><h2 id=api-organization>API organization</h2><p>API is organized to two groups , one is <code>Core</code> group and second on is <code>Named Groups</code></p><h3 id=core-group>Core Group</h3><p>Contains all stable and core API objects</p><h4 id=api-apiversions><code>/api</code> (APIVersions)</h4><p>This endpoint will return core API version & API address itself</p><p>Execute below commands if you are using Vagrant based setup
If you are using <code>kubeadm</code> based setup , then skip this.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p /etc/kubernetes/pki/
</span></span><span class=line><span class=cl>$ sudo cp /home/vagrant/PKI/ca.pem /etc/kubernetes/pki/ca.crt
</span></span><span class=line><span class=cl>$ sudo cp /home/vagrant/PKI/k8s-master-01.pem /etc/kubernetes/pki/apiserver-kubelet-client.crt
</span></span><span class=line><span class=cl>$ sudo cp /home/vagrant/PKI/k8s-master-01-key.pem /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -s  --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key -XGET <span class=s1>&#39;https://192.168.56.201:6443/api?timeout=32s&#39;</span> <span class=p>|</span>python3 -m json.tool
</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;APIVersions&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;versions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;serverAddressByClientCIDRs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;clientCIDR&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;serverAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.56.201:6443&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=apiv1-apiresourcelist><code>/api/v1</code> (APIResourceList)</h4><p>This endpoint will return objects/resources in core group <code>v1</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -s  --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key -XGET <span class=s1>&#39;https://192.168.56.201:6443/api/v1?timeout=32s&#39;</span> <span class=p>|</span>python3 -m json.tool
</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;APIResourceList&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;bindings&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;Binding&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;create&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;componentstatuses&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;ComponentStatus&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;list&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;shortNames&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;cs&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;configmaps&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;ConfigMap&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;create&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;delete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;deletecollection&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;patch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;watch&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;shortNames&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;cm&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;services/status&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;Service&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;patch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;update&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=named-groups>Named Groups</h3><h4 id=apis-apigrouplist><code>/apis</code> (APIGroupList)</h4><p>This endpoint will return all named groups</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -s  --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key -XGET <span class=s1>&#39;https://192.168.56.201:6443/apis?timeout=32s&#39;</span> <span class=p>|</span>python3 -m json.tool
</span></span></code></pre></div><h4 id=apiapps-apigroup><code>/api/apps</code> (APIGroup)</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -s  --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key -XGET <span class=s1>&#39;https://192.168.56.201:6443/apis/apps?timeout=32s&#39;</span> <span class=p>|</span>python3 -m json.tool
</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;APIGroup&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;apps&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;versions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;apps/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;apps/v1beta2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;v1beta2&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;apps/v1beta1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;v1beta1&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;preferredVersion&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;apps/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h4 id=apiappsv1-apiresourcelist><code>/api/apps/v1</code> (APIResourceList)</h4><p>Will return objects / resources under apps/v1</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -s  --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt --key /etc/kubernetes/pki/apiserver-kubelet-client.key -XGET <span class=s1>&#39;https://192.168.56.201:6443/apis/apps/v1?timeout=32s&#39;</span> <span class=p>|</span>python3 -m json.tool
</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;APIResourceList&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;groupVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;apps/v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;controllerrevisions&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;ControllerRevision&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;create&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;delete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;deletecollection&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;patch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;watch&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;daemonsets&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;DaemonSet&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;create&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;delete&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;deletecollection&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;patch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;update&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;watch&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;shortNames&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;ds&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;categories&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;all&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl><span class=err>...</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;statefulsets/status&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;singularName&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;namespaced&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;StatefulSet&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;verbs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;get&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;patch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;update&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><h3 id=api-versions>API versions</h3><p>Different API versions imply different levels of stability and support</p><h4 id=alpha-level>Alpha level:</h4><ul><li>The version names contain alpha (e.g. v1alpha1).</li><li>May be buggy. Enabling the feature may expose bugs. Disabled by default.</li><li>Support for feature may be dropped at any time without notice.</li><li>The API may change in incompatible ways in a later software release without notice.</li><li>Recommended for use only in short-lived testing clusters, due to increased risk of bugs and lack of long-term support.</li></ul><h4 id=beta-level>Beta level:</h4><ul><li>The version names contain beta (e.g. v2beta3).</li><li>Code is well tested. Enabling the feature is considered safe. Enabled by default.</li><li>Support for the overall feature will not be dropped, though details may change.</li><li>The schema and/or semantics of objects may change in incompatible ways in a subsequent beta or stable release. When this happens, k8s developers will provide instructions for migrating to the next version. This may require deleting, editing, and re-creating API objects. The editing process may require some thought. This may require downtime for applications that rely on the feature.</li><li>Recommended for only non-business-critical uses because of potential for incompatible changes in subsequent releases. If you have multiple clusters which can be upgraded independently, you may be able to relax this restriction.</li><li>Please do try our beta features and give feedback on them! Once they exit beta, it may not be practical for us to make more changes.</li></ul><h4 id=stable-level>Stable level:</h4><p>The version name is vX where X is an integer.
Stable versions of features will appear in released software for many subsequent versions</p><h3 id=list-api-version-using-kubectl>List API version using <code>kubectl</code></h3><h4 id=api-versions-1>API Versions</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl api-versions
</span></span><span class=line><span class=cl><span class=go>admissionregistration.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>apiextensions.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>apiregistration.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>apiregistration.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>apps/v1
</span></span></span><span class=line><span class=cl><span class=go>apps/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>apps/v1beta2
</span></span></span><span class=line><span class=cl><span class=go>authentication.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>authentication.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>autoscaling/v1
</span></span></span><span class=line><span class=cl><span class=go>autoscaling/v2beta1
</span></span></span><span class=line><span class=cl><span class=go>autoscaling/v2beta2
</span></span></span><span class=line><span class=cl><span class=go>batch/v1
</span></span></span><span class=line><span class=cl><span class=go>batch/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>certificates.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>coordination.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>crd.projectcalico.org/v1
</span></span></span><span class=line><span class=cl><span class=go>events.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>extensions/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>networking.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>policy/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>rbac.authorization.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>rbac.authorization.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>scheduling.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>storage.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=go>storage.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=go>v1
</span></span></span></code></pre></div><h4 id=api-resources>API resources</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl api-resources
</span></span><span class=line><span class=cl><span class=go>NAME                              SHORTNAMES   APIGROUP                       NAMESPACED   KIND
</span></span></span><span class=line><span class=cl><span class=go>bindings                                                                      true         Binding
</span></span></span><span class=line><span class=cl><span class=go>componentstatuses                 cs                                          false        ComponentStatus
</span></span></span><span class=line><span class=cl><span class=go>configmaps                        cm                                          true         ConfigMap
</span></span></span><span class=line><span class=cl><span class=go>endpoints                         ep                                          true         Endpoints
</span></span></span><span class=line><span class=cl><span class=go>events                            ev                                          true         Event
</span></span></span><span class=line><span class=cl><span class=go>limitranges                       limits                                      true         LimitRange
</span></span></span><span class=line><span class=cl><span class=go>namespaces                        ns                                          false        Namespace
</span></span></span><span class=line><span class=cl><span class=go>nodes                             no                                          false        Node
</span></span></span><span class=line><span class=cl><span class=go>persistentvolumeclaims            pvc                                         true         PersistentVolumeClaim
</span></span></span><span class=line><span class=cl><span class=go>persistentvolumes                 pv                                          false        PersistentVolume
</span></span></span><span class=line><span class=cl><span class=go>pods                              po                                          true         Pod
</span></span></span><span class=line><span class=cl><span class=go>podtemplates                                                                  true         PodTemplate
</span></span></span><span class=line><span class=cl><span class=go>replicationcontrollers            rc                                          true         ReplicationController
</span></span></span><span class=line><span class=cl><span class=go>resourcequotas                    quota                                       true         ResourceQuota
</span></span></span><span class=line><span class=cl><span class=go>secrets                                                                       true         Secret
</span></span></span><span class=line><span class=cl><span class=go>serviceaccounts                   sa                                          true         ServiceAccount
</span></span></span><span class=line><span class=cl><span class=go>services                          svc                                         true         Service
</span></span></span><span class=line><span class=cl><span class=go>mutatingwebhookconfigurations                  admissionregistration.k8s.io   false        MutatingWebhookConfiguration
</span></span></span><span class=line><span class=cl><span class=go>validatingwebhookconfigurations                admissionregistration.k8s.io   false        ValidatingWebhookConfiguration
</span></span></span><span class=line><span class=cl><span class=go>customresourcedefinitions         crd,crds     apiextensions.k8s.io           false        CustomResourceDefinition
</span></span></span><span class=line><span class=cl><span class=go>apiservices                                    apiregistration.k8s.io         false        APIService
</span></span></span><span class=line><span class=cl><span class=go>controllerrevisions                            apps                           true         ControllerRevision
</span></span></span><span class=line><span class=cl><span class=go>daemonsets                        ds           apps                           true         DaemonSet
</span></span></span><span class=line><span class=cl><span class=go>deployments                       deploy       apps                           true         Deployment
</span></span></span><span class=line><span class=cl><span class=go>replicasets                       rs           apps                           true         ReplicaSet
</span></span></span><span class=line><span class=cl><span class=go>statefulsets                      sts          apps                           true         StatefulSet
</span></span></span><span class=line><span class=cl><span class=go>tokenreviews                                   authentication.k8s.io          false        TokenReview
</span></span></span><span class=line><span class=cl><span class=go>localsubjectaccessreviews                      authorization.k8s.io           true         LocalSubjectAccessReview
</span></span></span><span class=line><span class=cl><span class=go>selfsubjectaccessreviews                       authorization.k8s.io           false        SelfSubjectAccessReview
</span></span></span><span class=line><span class=cl><span class=go>selfsubjectrulesreviews                        authorization.k8s.io           false        SelfSubjectRulesReview
</span></span></span><span class=line><span class=cl><span class=go>subjectaccessreviews                           authorization.k8s.io           false        SubjectAccessReview
</span></span></span><span class=line><span class=cl><span class=go>horizontalpodautoscalers          hpa          autoscaling                    true         HorizontalPodAutoscaler
</span></span></span><span class=line><span class=cl><span class=go>cronjobs                          cj           batch                          true         CronJob
</span></span></span><span class=line><span class=cl><span class=go>jobs                                           batch                          true         Job
</span></span></span><span class=line><span class=cl><span class=go>certificatesigningrequests        csr          certificates.k8s.io            false        CertificateSigningRequest
</span></span></span><span class=line><span class=cl><span class=go>leases                                         coordination.k8s.io            true         Lease
</span></span></span><span class=line><span class=cl><span class=go>bgpconfigurations                              crd.projectcalico.org          false        BGPConfiguration
</span></span></span><span class=line><span class=cl><span class=go>bgppeers                                       crd.projectcalico.org          false        BGPPeer
</span></span></span><span class=line><span class=cl><span class=go>clusterinformations                            crd.projectcalico.org          false        ClusterInformation
</span></span></span><span class=line><span class=cl><span class=go>felixconfigurations                            crd.projectcalico.org          false        FelixConfiguration
</span></span></span><span class=line><span class=cl><span class=go>globalnetworkpolicies                          crd.projectcalico.org          false        GlobalNetworkPolicy
</span></span></span><span class=line><span class=cl><span class=go>globalnetworksets                              crd.projectcalico.org          false        GlobalNetworkSet
</span></span></span><span class=line><span class=cl><span class=go>hostendpoints                                  crd.projectcalico.org          false        HostEndpoint
</span></span></span><span class=line><span class=cl><span class=go>ippools                                        crd.projectcalico.org          false        IPPool
</span></span></span><span class=line><span class=cl><span class=go>networkpolicies                                crd.projectcalico.org          true         NetworkPolicy
</span></span></span><span class=line><span class=cl><span class=go>events                            ev           events.k8s.io                  true         Event
</span></span></span><span class=line><span class=cl><span class=go>daemonsets                        ds           extensions                     true         DaemonSet
</span></span></span><span class=line><span class=cl><span class=go>deployments                       deploy       extensions                     true         Deployment
</span></span></span><span class=line><span class=cl><span class=go>ingresses                         ing          extensions                     true         Ingress
</span></span></span><span class=line><span class=cl><span class=go>networkpolicies                   netpol       extensions                     true         NetworkPolicy
</span></span></span><span class=line><span class=cl><span class=go>podsecuritypolicies               psp          extensions                     false        PodSecurityPolicy
</span></span></span><span class=line><span class=cl><span class=go>replicasets                       rs           extensions                     true         ReplicaSet
</span></span></span><span class=line><span class=cl><span class=go>networkpolicies                   netpol       networking.k8s.io              true         NetworkPolicy
</span></span></span><span class=line><span class=cl><span class=go>poddisruptionbudgets              pdb          policy                         true         PodDisruptionBudget
</span></span></span><span class=line><span class=cl><span class=go>podsecuritypolicies               psp          policy                         false        PodSecurityPolicy
</span></span></span><span class=line><span class=cl><span class=go>clusterrolebindings                            rbac.authorization.k8s.io      false        ClusterRoleBinding
</span></span></span><span class=line><span class=cl><span class=go>clusterroles                                   rbac.authorization.k8s.io      false        ClusterRole
</span></span></span><span class=line><span class=cl><span class=go>rolebindings                                   rbac.authorization.k8s.io      true         RoleBinding
</span></span></span><span class=line><span class=cl><span class=go>roles                                          rbac.authorization.k8s.io      true         Role
</span></span></span><span class=line><span class=cl><span class=go>priorityclasses                   pc           scheduling.k8s.io              false        PriorityClass
</span></span></span><span class=line><span class=cl><span class=go>storageclasses                    sc           storage.k8s.io                 false        StorageClass
</span></span></span><span class=line><span class=cl><span class=go>volumeattachments                              storage.k8s.io                 false        VolumeAttachment
</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=swagger---ui>Swagger - UI</h1><h3 id=enable-swagger>Enable swagger</h3><p>We can enable swagger UI in API Server</p><ul><li>Added &ndash;enable-swagger-ui=true to API manifest file /etc/kubernetes/manifests/kube-apiserver.yaml (only applicable to kubeadm deployments )</li><li>Save the file</li><li>API pod will restart itself</li><li>Make sure API server pod is up</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl get pods -n kube-system  <span class=p>|</span>grep kube-apiserver
</span></span><span class=line><span class=cl><span class=go>kube-apiserver-k8s-master-01            1/1     Running   0          55s
</span></span></span></code></pre></div><ul><li>Enable API proxy access</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl proxy --port<span class=o>=</span><span class=m>8080</span>
</span></span></code></pre></div><ul><li>Open an SSH tunnel from local system to server port 8080</li><li>Access API swagger UI using webbrowser using URL <code>http://localhost:8080/swagger-ui/</code>
<a href=#R-image-50d7e89f106449a9c3c6eefee4b10728 class=lightbox-link><img src="./09-api_reference/02-swagger-ui/swagger-ui.png?classes=shadow&amp;width=60pc" alt="Swagger UI" class="figure-image bg-white border lightbox shadow" style=height:auto;width:60pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-50d7e89f106449a9c3c6eefee4b10728><img src="./09-api_reference/02-swagger-ui/swagger-ui.png?classes=shadow&amp;width=60pc" alt="Swagger UI" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
<a href=#R-image-1ccbb2f898b829cec1f57004dbbb4f98 class=lightbox-link><img src="./09-api_reference/02-swagger-ui/swagger-ui-1.png?classes=shadow&amp;width=60pc" alt="Swagger UI" class="figure-image bg-white border lightbox shadow" style=height:auto;width:60pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1ccbb2f898b829cec1f57004dbbb4f98><img src="./09-api_reference/02-swagger-ui/swagger-ui-1.png?classes=shadow&amp;width=60pc" alt="Swagger UI" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></li></ul><p>Note: Swagger UI is very slow because of the design of Swagger itself.
Kubernetes may drop Swagger UI from API server.
<a href=https://github.com/kubernetes/kubernetes/issues/65346 target=_blank>Github Issue</a></p><p>You can read more about API <a href=https://kubernetes.io/docs/reference/ target=_blank>here</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 10</div><h1 id=configmaps-and-secrets>ConfigMaps and Secrets</h1><p>In this session we will explore the need of <code>ConfigMaps</code> and <code>Secrets</code> and its usage.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of ConfigMaps and Secrets</h1><article class=default><header class=headline></header><h1 id=configmaps>ConfigMaps</h1><p>In this session , we will explore the use of <code>ConfigMaps</code>.</p><p>If you want to customize the configuration of an application inside a Pod , you have to change the configuration files inside the container and then we have to wait for the application to re-read the updated configuration file.</p><p>When Pod lifecycle ends , the changes we made will be lost and we have to redo the same changes when the Pod comes-up.</p><p>This is not convenient and we need a better way to manage these configuration related operations.</p><p>To achieve a persistent configuration regardless of the Pod state , k8s introduced ConfigMaps.</p><p>We can store environmental variables or a file content or both using ConfigMaps in k8s.</p><p>Use the <code>kubectl create configmap</code> command to create configmaps from directories, files, or literal values:</p><p>where <map-name>is the name you want to assign to the ConfigMap and <data-source>is the directory, file, or literal value to draw the data from.</p><p>The data source corresponds to a key-value pair in the ConfigMap, where</p><p>key = the file name or the key you provided on the command line, and
value = the file contents or the literal value you provided on the command line.
You can use kubectl describe or kubectl get to retrieve information about a ConfigMap</p><h4 id=create-configmap-from-literals---declarative>Create ConfigMap from literals - Declarative</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>VAR1</span><span class=p>:</span><span class=w> </span><span class=l>val1</span></span></span></code></pre></div><h4 id=create-configmap-from-literals---imperative>Create ConfigMap from literals - Imperative</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create configmap myconfig --from-literal<span class=o>=</span><span class=nv>VAR1</span><span class=o>=</span>val1</span></span></code></pre></div><h4 id=create-configmap-from-file---declarative>Create ConfigMap from file - Declarative</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myconfig</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>configFile</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    This content is coming from a file
</span></span></span><span class=line><span class=cl><span class=sd>    Also this file have multiple lines</span><span class=w>    </span></span></span></code></pre></div><h4 id=create-configmap-from-file---imperative>Create ConfigMap from file - Imperative</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt;configFile
</span></span></span><span class=line><span class=cl><span class=s>This content is coming from a file
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat configFile</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create configmap myconfig --from-file<span class=o>=</span>configFile</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=use-configmaps-in-pods>Use ConfigMaps in Pods</h1><h3 id=define-a-container-environment-variable-with-data-from-a-single-configmap>Define a container environment variable with data from a single ConfigMap</h3><ul><li>Define an environment variable as a key-value pair in a ConfigMap:</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create configmap special-config --from-literal<span class=o>=</span>special.how<span class=o>=</span>very</span></span></code></pre></div><ul><li>Assign the special.how value defined in the ConfigMap to the SPECIAL_LEVEL_KEY environment variable in the Pod specification.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># Define the environment variable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=c># Specify the key associated with the value</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>special.how</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span></span></span></code></pre></div><h3 id=configure-all-key-value-pairs-in-a-configmap-as-container-environment-variables>Configure all key-value pairs in a ConfigMap as container environment variables</h3><ul><li>Create a ConfigMap containing multiple key-value pairs.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_LEVEL</span><span class=p>:</span><span class=w> </span><span class=l>very</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>SPECIAL_TYPE</span><span class=p>:</span><span class=w> </span><span class=l>charm</span></span></span></code></pre></div><ul><li>Use envFrom to define all of the ConfigMap’s data as container environment variables. The key from the ConfigMap becomes the environment variable name in the Pod.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dapi-test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-container</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>configMapRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>special-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span></span></span></code></pre></div><p>More about configmap can bre read from below link.
<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank>https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=create-secret>Create Secret</h1><p>A Secret is an object that contains a small amount of sensitive data</p><p>To use a secret, a pod needs to reference the secret. A secret can be used with a pod in two ways: as files in a volume mounted on one or more of its containers, or used by kubelet when pulling images for the pod</p><p>Secrets will be stored as base64 encoded values and it will be used mostly during creation of an object</p><h3 id=creating-secrets>Creating Secrets</h3><h5 id=from-variables>From variables</h5><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create secret generic my-secret --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span>mypassword --dry-run -o yaml</span></span></code></pre></div><h5 id=from-files>From files</h5><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create secret generic my-secret --from-file<span class=o>=</span><span class=nv>user</span><span class=o>=</span>user.txt --from-file<span class=o>=</span>password.txt --dry-run -o yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> root &gt;user.txt
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> password &gt;password.txt</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create secret generic my-secret --from-file<span class=o>=</span><span class=nv>user</span><span class=o>=</span>user.txt --from-file<span class=o>=</span><span class=nv>password</span><span class=o>=</span>password.txt --dry-run -o yaml</span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=use-secret-in-pods>Use Secret in Pods</h1><h3 id=using-secrets>Using secrets</h3><p>We can use secrets as environmental variable as well as mounts inside a Pod</p><h5 id=injecting-as-environmental-variable>Injecting as environmental variable</h5><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod-secret.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1       </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>debugger    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger     </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools   </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger   </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>USER     </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-secret         </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>user    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-secret         </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-secret.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl get pods      
</span></span><span class=line><span class=cl><span class=go>NAME       READY   STATUS    RESTARTS   AGE   
</span></span></span><span class=line><span class=cl><span class=go>debugger   1/1     Running   0          17s   
</span></span></span></code></pre></div><p>Logon to container and verify the environmental variables</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it debugger -- /bin/sh</span></span></code></pre></div><p>Verify environment variables inside Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>/ # echo $USER        
</span></span></span><span class=line><span class=cl><span class=go>root       
</span></span></span><span class=line><span class=cl><span class=go>/ # echo $PASSWORD    
</span></span></span><span class=line><span class=cl><span class=go>mypassword
</span></span></span><span class=line><span class=cl><span class=go>/ #        
</span></span></span></code></pre></div><p>Delete the Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod debugger</span></span></code></pre></div><h5 id=mounting-as-files-using-volumes>Mounting as files using volumes</h5><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod-secret.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>my-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-secret.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it debugger -- /bin/sh</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>/ # cd /data        
</span></span></span><span class=line><span class=cl><span class=go>/data #             
</span></span></span><span class=line><span class=cl><span class=go>/data # cat user    
</span></span></span><span class=line><span class=cl><span class=go>root                
</span></span></span><span class=line><span class=cl><span class=go>/data # cat password
</span></span></span><span class=line><span class=cl><span class=go>mypassword          
</span></span></span><span class=line><span class=cl><span class=go>/data #             
</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 11</div><h1 id=deployments>Deployments</h1><p>We will not run individual Pods in K8S cluster for running the workload. Instead , we will use more abstract objects like Deployments.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Deployments</h1><article class=default><header class=headline></header><h1 id=nginx-deployment>Nginx Deployment</h1><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run nginx --image<span class=o>=</span>nginx</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>deployment.apps/nginx created
</span></span></span></code></pre></div><p>Verify the Pods running</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                     READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-9xsms   1/1     Running   0          27s
</span></span></span></code></pre></div><p>Here we can see that the Pod name is not like the usual one.</p><p>Lets delete the Pod and see what will happen.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod nginx-7cdbd8cdc9-9xsms</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>pod &#34;nginx-7cdbd8cdc9-9xsms&#34; deleted
</span></span></span></code></pre></div><p>Verify Pod status</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                     READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-vfbn8   1/1     Running   0          81s
</span></span></span></code></pre></div><p>A new Pod has been created again !!!</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=expose-nginx-deployment>Expose Nginx Deployment</h1><p>We know how to expose a Pod using a service.</p><p>The endpoints will be created based on the label of the Pod.</p><p>Here how we can create a service which can be used to access Nginx from outside</p><p>First we will check the label of the Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pod nginx-7cdbd8cdc9-vfbn8 --show-labels</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                     READY   STATUS    RESTARTS   AGE     LABELS
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-vfbn8   1/1     Running   0          7m19s   pod-template-hash=7cdbd8cdc9,run=nginx
</span></span></span></code></pre></div><p>As you can see , one of the label is <code>run=nginx</code></p><p>Next write a Service spec and use selector as <code>run: nginx</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi nginx-svc.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-svc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span></span></span></code></pre></div><p>This service will look for Pods with label &ldquo;run=nginx&rdquo;</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl apply -f nginx-svc.yaml</span></span></code></pre></div><p>Verify the service details</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get svc</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME         TYPE           CLUSTER-IP       EXTERNAL-IP      PORT(S)        AGE
</span></span></span><span class=line><span class=cl><span class=go>kubernetes   ClusterIP      172.168.0.1      &lt;none&gt;           443/TCP        103m
</span></span></span><span class=line><span class=cl><span class=go>nginx-svc    LoadBalancer   172.168.47.182   192.168.31.201   80:32369/TCP   3s
</span></span></span></code></pre></div><p>Now we will be able to see the default nginx page with IP <code>192.168.31.201</code></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=scaling>Scaling</h1><p>When load increases , we can scale the pods using deployment scaling</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl scale deployment --replicas<span class=o>=</span><span class=m>3</span> nginx</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME                     READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-4lhh4   1/1     Running   0          6s
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-mxhnl   1/1     Running   0          6s
</span></span></span><span class=line><span class=cl><span class=go>nginx-7cdbd8cdc9-vfbn8   1/1     Running   0          14m
</span></span></span></code></pre></div><p>Lets see the endpoints of service</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get ep nginx-svc</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME        ENDPOINTS                                         AGE
</span></span></span><span class=line><span class=cl><span class=go>nginx-svc   10.10.36.201:80,10.10.36.202:80,10.10.36.203:80   5m40s
</span></span></span></code></pre></div><p>Endpoints will be automatically mapped , because when we scale the deployment , the newly created pod will have same label which matches the Service selector.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 12</div><h1 id=daemonsets>DaemonSets</h1><p>With DaemonSets , we can run one pod on each nodes or minions. This kind of pods will act more or less like an agent.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of DaemonSets</h1><article class=default><header class=headline></header><h1 id=daemonset>DaemonSet</h1><p>A DaemonSet ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected. Deleting a DaemonSet will clean up the Pods it created.</p><p>Lets imagine that we need an agent deployed on all nodes which reads the system logs and sent to a log analysis database</p><p>Here we are mimicking the agent using a simple pod.
A pod that mounts /var/log inside the pod and do tail of syslog file</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi logger.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>log-tailer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>syslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span>- <span class=l>tail -f /data/logs/syslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>syslog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data/logs/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f logger.yaml</span></span></code></pre></div><p>Now we can execute a <code>logs</code> command to see the system log</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl logs log-tailer -f</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod log-tailer</span></span></code></pre></div><p>Now we need the same kind of Pod to be running on all nodes.
If we add a node in future , the same pod should start on that node as well.</p><p>To accomplish this goal , we can use <code>DaemonSet</code>.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi logger.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1                               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet                                   </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>                                         
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>log-tailer                                 </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>                                             
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>                                       
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>                                  
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>log-tailer                            </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>                                       
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>                                     
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>                                     
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>log-tailer                          </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>                                         
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>                                
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master      </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule                       </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>                                    
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>syslog                             </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>                                
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log                          </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>                                 
</span></span></span><span class=line><span class=cl><span class=w>       </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>logger                             </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools                </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>args</span><span class=p>:</span><span class=w>                                    
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>/bin/sh                               </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- -<span class=l>c                                    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=l>tail -f /data/logs/syslog             </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>                            
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>syslog                          </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data/logs/                </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>                         
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>                        </span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f logger.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -o wide</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME               READY   STATUS    RESTARTS   AGE   IP              NODE            NOMINATED NODE   READINESS GATES
</span></span></span><span class=line><span class=cl><span class=go>log-tailer-hzjzx   1/1     Running   0          22s   10.10.36.242    k8s-worker-01   &lt;none&gt;           &lt;none&gt;
</span></span></span><span class=line><span class=cl><span class=go>log-tailer-rqgrf   1/1     Running   0          22s   10.10.151.153   k8s-master-01   &lt;none&gt;           &lt;none&gt;
</span></span></span></code></pre></div><p>Important notes at the end of the page in this URL : <a href=https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/ target=_blank>https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 13</div><h1 id=jobs-and-cronjobs>Jobs and CronJobs</h1><p>With Jobs and CronJobs we can run a process once or schedule a Pod to run periodically.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Jobs and CronJobs</h1><article class=default><header class=headline></header><h1 id=jobs>Jobs</h1><p>A job creates one or more pods and ensures that a specified number of them successfully terminate.
As pods successfully complete, the job tracks the successful completions.</p><p>When a specified number of successful completions is reached, the job itself is complete.</p><p>Deleting a Job will cleanup the pods it created.</p><ul><li>Start a Job to print date</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run date-print --image<span class=o>=</span>ansilh/debug-tools  --restart<span class=o>=</span>OnFailure  -- /bin/sh -c date</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get jobs</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME         COMPLETIONS   DURATION   AGE
date-print   0/1           3s         3s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME               READY   STATUS      RESTARTS   AGE
date-print-psxw6   0/1     Completed   0          8s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get jobs</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME         COMPLETIONS   DURATION   AGE
date-print   1/1           4s         10s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl logs date-print-psxw6</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>Sun Feb  3 18:10:45 UTC 2019</code></pre></div><p>To control the number of failure and restart , we can use <code>spec.backoffLimit</code></p><p>To start n number of pods that will run in sequential order , we can use ``.spec.completions`</p><p>To start multiple pods in parallel , we can use <code>.spec.parallelism</code></p><p>To cleanup the completed Jobs automatically , we can use <code>ttlSecondsAfterFinished</code> (1.12 alpha feature)</p><p><a href=https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/ target=_blank>https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion/</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cronjob>CronJob</h1><p>CronJob is another abstraction of Job , which will create Job objects periodically based on the mentioned schedule.
The schedule notation is taken from Linux cron scheduler</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run date-print --image<span class=o>=</span>ansilh/debug-tools  --restart<span class=o>=</span>OnFailure  --schedule<span class=o>=</span><span class=s2>&#34;* * * * *&#34;</span> -- /bin/sh -c date</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get cronjobs.batch</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>NAME         SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
date-print   * * * * *   False     0        &lt;none&gt;          7s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>No resources found.</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get cronjobs.batch</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>NAME         SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
date-print   * * * * *   False     0        22s             60s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods
NAME                          READY   STATUS      RESTARTS   AGE
date-print-1549217580-qmjxt   0/1     Completed   0          36s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl logs date-print-1549217580-qmjxt</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>Sun Feb  3 18:13:08 UTC 2019</code></pre></div><h4 id=concurrency-policy>Concurrency Policy</h4><p>The ``.spec.concurrencyPolicy` field is also optional.</p><p>It specifies how to treat concurrent executions of a job that is created by this cron job. the spec may specify only one of the following concurrency policies:</p><p><code>Allow</code> (default): The cron job allows concurrently running jobs</p><p><code>Forbid</code>: The cron job does not allow concurrent runs; if it is time for a new job run and the previous job run hasn’t finished yet, the cron job skips the new job run</p><p><code>Replace</code>: If it is time for a new job run and the previous job run hasn’t finished yet, the cron job replaces the currently running job run with a new job run</p><p>Note that concurrency policy only applies to the jobs created by the same cron job.</p><p><a href=https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/ target=_blank>https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 14</div><h1 id=deployment-rollouts>Deployment Rollouts</h1><p>In this session we will see how to do deployment rollouts and rollbacks</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Deployment Rollouts</h1><article class=default><header class=headline></header><h1 id=deployment--replicaset>Deployment & Replicaset</h1><p>The following are typical use cases for Deployments:</p><ul><li>Create a Deployment to rollout a ReplicaSet. The ReplicaSet creates Pods in the background. Check the status of the rollout to see if it succeeds or not.</li><li>Declare the new state of the Pods by updating the PodTemplateSpec of the Deployment. A new ReplicaSet is created and the Deployment manages moving the Pods from the old ReplicaSet to the new one at a controlled rate. - Each new ReplicaSet updates the revision of the Deployment.</li><li>Rollback to an earlier Deployment revision if the current state of the Deployment is not stable. Each rollback updates the revision of the Deployment.</li><li>Scale up the Deployment to facilitate more load.</li><li>Pause the Deployment to apply multiple fixes to its PodTemplateSpec and then resume it to start a new rollout.</li><li>Use the status of the Deployment as an indicator that a rollout has stuck.</li><li>Clean up older ReplicaSets that you don’t need anymore.</li></ul><p><a href=#R-image-d9b394027aad2413c28b1df4c6e1fb6b class=lightbox-link><img src=./14-deployment-rollouts/01-introduction/deployment.png alt=Deployment class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d9b394027aad2413c28b1df4c6e1fb6b><img src=./14-deployment-rollouts/01-introduction/deployment.png alt=Deployment class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=rollout-demo>Rollout Demo</h1><h3 id=creating-a-deployment>Creating a Deployment</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi nginx-deployment.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.7.9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f nginx-deployment.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>deployment.apps/nginx-deployment created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get all</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                                    READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-c7jrz   1/1     Running   0          38s --+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-gl5cv   1/1     Running   0          38s   |-----&gt; These Pods are spawned by ReplicaSet nginx-deployment-76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-kgmx9   1/1     Running   0          38s --+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubernetes   ClusterIP   172.168.0.1      &lt;none&gt;        443/TCP        3d23h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/nginx-deployment   3/3     3            3           38s ---------&gt; Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                          DESIRED   CURRENT   READY   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/nginx-deployment-76bf4969df   3         3         3       38s ---&gt; ReplicaSet</span></span></span></code></pre></div><p>As we already know , Deployment controller uses labels to select the Pods
In Yaml spec , you can see below selector fields.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span></span></span></code></pre></div><p>Lets examine the Pods.
We can see that there are two labels.
The pod-template-hash label is added by the Deployment controller to every ReplicaSet that a Deployment creates or adopts.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods --show-labels</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                                READY   STATUS    RESTARTS   AGE     LABELS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-76bf4969df-hm5hf   1/1     Running   0          3m44s   app=nginx,pod-template-hash=76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-76bf4969df-tqn2k   1/1     Running   0          3m44s   app=nginx,pod-template-hash=76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-76bf4969df-wjmqp   1/1     Running   0          3m44s   app=nginx,pod-template-hash=76bf4969df</span></span></span></code></pre></div><p>You may see the parameters of a replicaset using below command.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get replicasets nginx-deployment-76bf4969df -o yaml --export</span></span></code></pre></div><p>We can update the nginx image to a new version using <code>set image</code>.</p><p>Here we are executing both <code>set image</code> and <code>rollout status</code> together so that we can monitor the status.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>set</span> image deployment nginx-deployment <span class=nv>nginx</span><span class=o>=</span>nginx:1.9.1 <span class=p>;</span> kubectl rollout status deployment nginx-deployment</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>deployment.extensions/nginx-deployment image updated</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 old replicas are pending termination...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 old replicas are pending termination...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment &#34;nginx-deployment&#34; successfully rolled out</span></span></span></code></pre></div><p>To view the history of rollout</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl rollout history deployment nginx-deployment</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>deployment.extensions/nginx-deployment
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         &lt;none&gt;</code></pre></div><p>To see the changes we made on each version, we can use below commands</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout <span class=nb>history</span> deployment nginx-deployment --revision<span class=o>=</span><span class=m>1</span></span></span></code></pre></div><p>First revision have image <code>nginx:1.7.9</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>deployment.extensions/nginx-deployment</span> <span class=s>with revision #1</span>
</span></span><span class=line><span class=cl><span class=na>Pod</span> <span class=s>Template:</span>
</span></span><span class=line><span class=cl>  <span class=na>Labels</span><span class=o>:</span>       <span class=s>app=nginx</span>
</span></span><span class=line><span class=cl>        <span class=na>pod-template-hash</span><span class=o>=</span><span class=s>76bf4969df</span>
</span></span><span class=line><span class=cl>  <span class=na>Containers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=na>nginx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=na>Image</span><span class=o>:</span>      <span class=s>nginx:1.7.9</span>
</span></span><span class=line><span class=cl>    <span class=na>Port</span><span class=o>:</span>       <span class=s>80/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Host</span> <span class=s>Port:  0/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Environment</span><span class=o>:</span>        <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>    <span class=na>Mounts</span><span class=o>:</span>     <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>  <span class=na>Volumes</span><span class=o>:</span>      <span class=s>&lt;none&gt;</span></span></span></code></pre></div><p>First revision have image <code>nginx:1.9.1</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout <span class=nb>history</span> deployment nginx-deployment --revision<span class=o>=</span><span class=m>2</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>deployment.extensions/nginx-deployment</span> <span class=s>with revision #2</span>
</span></span><span class=line><span class=cl><span class=na>Pod</span> <span class=s>Template:</span>
</span></span><span class=line><span class=cl>  <span class=na>Labels</span><span class=o>:</span>       <span class=s>app=nginx</span>
</span></span><span class=line><span class=cl>        <span class=na>pod-template-hash</span><span class=o>=</span><span class=s>779fcd779f</span>
</span></span><span class=line><span class=cl>  <span class=na>Containers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=na>nginx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=na>Image</span><span class=o>:</span>      <span class=s>nginx:1.9.1</span>
</span></span><span class=line><span class=cl>    <span class=na>Port</span><span class=o>:</span>       <span class=s>80/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Host</span> <span class=s>Port:  0/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Environment</span><span class=o>:</span>        <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>    <span class=na>Mounts</span><span class=o>:</span>     <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>  <span class=na>Volumes</span><span class=o>:</span>      <span class=s>&lt;none&gt;</span></span></span></code></pre></div><p>Now lets rollback the update.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout undo deployment nginx-deployment <span class=p>;</span>kubectl rollout status deployment nginx-deployment</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>deployment.extensions/nginx-deployment rolled back</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 2 out of 3 new replicas have been updated...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 old replicas are pending termination...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Waiting for deployment &#34;nginx-deployment&#34; rollout to finish: 1 old replicas are pending termination...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment &#34;nginx-deployment&#34; successfully rolled out</span></span></span></code></pre></div><p>Now we have revision 2 and 3.</p><p>When we rollback version 1 become 3 .
In this way the latest active one and the previous revision will be the highest and second highest revisions respectively.
This logic will allow quick rollbacks.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl rollout history deployment nginx-deployment</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>deployment.extensions/nginx-deployment
</span></span><span class=line><span class=cl>REVISION  CHANGE-CAUSE
</span></span><span class=line><span class=cl><span class=m>2</span>         &lt;none&gt;
</span></span><span class=line><span class=cl><span class=m>3</span>         &lt;none&gt;</span></span></code></pre></div><p>Check each revision changes</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout <span class=nb>history</span> deployment nginx-deployment --revision<span class=o>=</span><span class=m>2</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>deployment.extensions/nginx-deployment</span> <span class=s>with revision #2</span>
</span></span><span class=line><span class=cl><span class=na>Pod</span> <span class=s>Template:</span>
</span></span><span class=line><span class=cl>  <span class=na>Labels</span><span class=o>:</span>       <span class=s>app=nginx</span>
</span></span><span class=line><span class=cl>        <span class=na>pod-template-hash</span><span class=o>=</span><span class=s>779fcd779f</span>
</span></span><span class=line><span class=cl>  <span class=na>Containers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=na>nginx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=na>Image</span><span class=o>:</span>      <span class=s>nginx:1.9.1</span>
</span></span><span class=line><span class=cl>    <span class=na>Port</span><span class=o>:</span>       <span class=s>80/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Host</span> <span class=s>Port:  0/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Environment</span><span class=o>:</span>        <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>    <span class=na>Mounts</span><span class=o>:</span>     <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>  <span class=na>Volumes</span><span class=o>:</span>      <span class=s>&lt;none&gt;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout <span class=nb>history</span> deployment nginx-deployment --revision<span class=o>=</span><span class=m>3</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>deployment.extensions/nginx-deployment</span> <span class=s>with revision #3</span>
</span></span><span class=line><span class=cl><span class=na>Pod</span> <span class=s>Template:</span>
</span></span><span class=line><span class=cl>  <span class=na>Labels</span><span class=o>:</span>       <span class=s>app=nginx</span>
</span></span><span class=line><span class=cl>        <span class=na>pod-template-hash</span><span class=o>=</span><span class=s>76bf4969df</span>
</span></span><span class=line><span class=cl>  <span class=na>Containers</span><span class=o>:</span>
</span></span><span class=line><span class=cl>   <span class=na>nginx</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=na>Image</span><span class=o>:</span>      <span class=s>nginx:1.7.9</span>
</span></span><span class=line><span class=cl>    <span class=na>Port</span><span class=o>:</span>       <span class=s>80/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Host</span> <span class=s>Port:  0/TCP</span>
</span></span><span class=line><span class=cl>    <span class=na>Environment</span><span class=o>:</span>        <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>    <span class=na>Mounts</span><span class=o>:</span>     <span class=s>&lt;none&gt;</span>
</span></span><span class=line><span class=cl>  <span class=na>Volumes</span><span class=o>:</span>      <span class=s>&lt;none&gt;</span></span></span></code></pre></div><p>Lets check the status of replicaset</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get rs</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-76bf4969df   3         3         3       145m
nginx-deployment-779fcd779f   0         0         0       69m</code></pre></div><p>Here we can see two replicaset</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl describe rs nginx-deployment-76bf4969df</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Name</span><span class=p>:</span><span class=w>           </span><span class=l>nginx-deployment-76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>      </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Selector</span><span class=p>:</span><span class=w>       </span><span class=l>app=nginx,pod-template-hash=76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>         </span><span class=l>app=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>pod-template-hash=76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations:    deployment.kubernetes.io/desired-replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>deployment.kubernetes.io/max-replicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>deployment.kubernetes.io/revision</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>deployment.kubernetes.io/revision-history</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Controlled By</span><span class=p>:</span><span class=w>  </span><span class=l>Deployment/nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Replicas</span><span class=p>:</span><span class=w>       </span><span class=m>3</span><span class=w> </span><span class=l>current / 3 desired  &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Pods Status</span><span class=p>:</span><span class=w>    </span><span class=m>3</span><span class=w> </span><span class=l>Running / 0 Waiting / 0 Succeeded / 0 Failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Pod Template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Labels</span><span class=p>:</span><span class=w>  </span><span class=l>app=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=l>pod-template-hash=76bf4969df</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Image</span><span class=p>:</span><span class=w>        </span><span class=l>nginx:1.7.9 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Port</span><span class=p>:</span><span class=w>         </span><span class=m>80</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Host Port</span><span class=p>:</span><span class=w>    </span><span class=m>0</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Environment</span><span class=p>:</span><span class=w>  </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Mounts</span><span class=p>:</span><span class=w>       </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Volumes</span><span class=p>:</span><span class=w>        </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Events</span><span class=p>:</span><span class=w>           </span><span class=l>&lt;none&gt;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl describe rs nginx-deployment-779fcd779f</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Name</span><span class=p>:</span><span class=w>           </span><span class=l>nginx-deployment-779fcd779f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>      </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Selector</span><span class=p>:</span><span class=w>       </span><span class=l>app=nginx,pod-template-hash=779fcd779f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>         </span><span class=l>app=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=l>pod-template-hash=779fcd779f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations:    deployment.kubernetes.io/desired-replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>deployment.kubernetes.io/max-replicas</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>deployment.kubernetes.io/revision</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Controlled By</span><span class=p>:</span><span class=w>  </span><span class=l>Deployment/nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Replicas</span><span class=p>:</span><span class=w>       </span><span class=m>0</span><span class=w> </span><span class=l>current / 0 desired &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Pods Status</span><span class=p>:</span><span class=w>    </span><span class=m>0</span><span class=w> </span><span class=l>Running / 0 Waiting / 0 Succeeded / 0 Failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Pod Template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Labels</span><span class=p>:</span><span class=w>  </span><span class=l>app=nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=l>pod-template-hash=779fcd779f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>nginx</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Image</span><span class=p>:</span><span class=w>        </span><span class=l>nginx:1.9.1 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;-------------------------</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Port</span><span class=p>:</span><span class=w>         </span><span class=m>80</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Host Port</span><span class=p>:</span><span class=w>    </span><span class=m>0</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Environment</span><span class=p>:</span><span class=w>  </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>Mounts</span><span class=p>:</span><span class=w>       </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Volumes</span><span class=p>:</span><span class=w>        </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Events</span><span class=p>:</span><span class=w>           </span><span class=l>&lt;none&gt;</span></span></span></code></pre></div><p>We can pause and resume a rollout using below commands</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout pause deployment nginx-deployment</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl rollout resume deployment nginx-deployment</span></span></code></pre></div><p>We can use <code>revisionHistoryLimit</code> field in a Deployment to specify how many old ReplicaSets for this Deployment you want to retain. The rest will be garbage-collected in the background. By default, it is 10</p><p>We can read more about <code>strategy</code> <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy target=_blank>here</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 15</div><h1 id=accounts-and-rbacs>Accounts and RBACs</h1><p>In this chapter we will discuss about how k8s uses accounts and how to control resource access using RBAC.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Accounts and RBACs</h1><article class=default><header class=headline></header><h1 id=mutual-ssl-authentication>Mutual SSL Authentication</h1><p><a href=#R-image-a93ade5800661956e42f74ac86e48dc5 class=lightbox-link><img src="./15-accounts_and_rbacs/01-authentication/mutualssl.png?class=shadow?width=80pc" alt="Mutual SSL" class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a93ade5800661956e42f74ac86e48dc5><img src="./15-accounts_and_rbacs/01-authentication/mutualssl.png?class=shadow?width=80pc" alt="Mutual SSL" class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=authorization-with-certificates>Authorization with Certificates</h1><p><a href=#R-image-5da04feae7c1c97207737b47ff26bfa5 class=lightbox-link><img src="./15-accounts_and_rbacs/02-authorization/auth.jpg?classes=shadow" alt="Authentication &amp;amp; Authorization" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-5da04feae7c1c97207737b47ff26bfa5><img src="./15-accounts_and_rbacs/02-authorization/auth.jpg?classes=shadow" alt="Authentication &amp;amp; Authorization" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=rbac>RBAC</h1><h3 id=rbac-in-action>RBAC in Action</h3><h3 id=role>Role</h3><p>In the RBAC API, a role contains rules that represent a set of permissions. Permissions are purely additive (there are no “deny” rules). A role can be defined within a namespace with a Role, or cluster-wide with a ClusterRole</p><h3 id=clusterrole>ClusterRole</h3><p>A ClusterRole can be used to grant the same permissions as a Role, but because they are cluster-scoped, they can also be used to grant access to:</p><ul><li>cluster-scoped resources (like nodes)</li><li>non-resource endpoints (like “/healthz”)</li><li>namespaced resources (like pods) across all namespaces (needed to run kubectl get pods &ndash;all-namespaces, for example)</li></ul><h3 id=role-binding>Role Binding</h3><p>A role binding grants the permissions defined in a role to a user or set of users. It holds a list of subjects (users, groups, or service accounts), and a reference to the role being granted. Permissions can be granted within a namespace with a RoleBinding</p><h3 id=cluster-role-binding>Cluster Role Binding</h3><p>A ClusterRoleBinding may be used to grant permission at the cluster level and in all namespaces</p><p>A RoleBinding may also reference a ClusterRole to grant the permissions to namespaced resources defined in the ClusterRole within the RoleBinding’s namespace. This allows administrators to define a set of common roles for the entire cluster, then reuse them within multiple namespaces.</p><p>We can read more about RBAC , Role , RoleBindings , ClusterRoles and ClusterRole Bindings <a href=https://kubernetes.io/docs/reference/access-authn-authz/rbac target=_blank>here</a></p><h4 id=scenario-provide-read-only-access-to-pods-running-in-namespace-monitoring>Scenario: Provide <em>read-only</em> access to <em>Pods</em> running in namespace <em>monitoring</em></h4><div class="wrap-code highlight"><pre tabindex=0><code>User Name: podview
Namespace: monitoring</code></pre></div><ul><li>Lets create a namespace first</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create ns monitoring</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get ns</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME          STATUS   AGE
default       Active   19h
kube-public   Active   19h
kube-system   Active   19h
monitoring    Active   9s</code></pre></div><ul><li>Lets create a CSR JSON and get it signed by the CA</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>cat</span> <span class=err>&lt;&lt;EOF</span> <span class=err>&gt;podview-csr.json</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;CN&#34;</span><span class=p>:</span> <span class=s2>&#34;podview&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;key&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;algo&#34;</span><span class=p>:</span> <span class=s2>&#34;rsa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>2048</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;names&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;C&#34;</span><span class=p>:</span> <span class=s2>&#34;IN&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;L&#34;</span><span class=p>:</span> <span class=s2>&#34;Bangalore&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;OU&#34;</span><span class=p>:</span> <span class=s2>&#34;Kubernetes from Scratch&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ST&#34;</span><span class=p>:</span> <span class=s2>&#34;Karnataka&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=err>EOF</span></span></span></code></pre></div><ul><li>Create CSR Certificate and Sign it using cfssl.
We moved the ca.pem and ca-key.pem from the home directory while configuring control plane . Lets copy it back to home.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cp -p /var/lib/kubernetes/ca.pem /var/lib/kubernetes/ca-key.pem ~/</span></span></code></pre></div><p>Generate Certificates</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca-key<span class=o>=</span>ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  podview-csr.json <span class=p>|</span> cfssljson -bare podview</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt podview*
-rw-rw-r-- 1 k8s k8s  235 Feb  3 15:42 podview-csr.json
-rw-rw-r-- 1 k8s k8s 1428 Feb  3 15:48 podview.pem
-rw------- 1 k8s k8s 1675 Feb  3 15:48 podview-key.pem
-rw-r--r-- 1 k8s k8s 1037 Feb  3 15:48 podview.csr</code></pre></div><p>Now we can use this certificate to configure <code>kubectl</code>.
<code>kubectl</code> will read .kube/config .
So you can either modify it manually or use the <code>kubectl</code> command to modify it</p><p>Lets do a <code>cat</code> on existing config.(snipped certificate data)</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ cat ~/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>SWUZNY2UxeDZkOWtDMWlKQ1puc0VRL3lnMXBobXYxdkxvWkJqTGlBWkRvCjVJYVd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://127.0.0.1:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-the-hard-way</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-the-hard-way</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-certificate-data</span><span class=p>:</span><span class=w> </span><span class=l>iUUsyU1hLT0lWQXYzR3hNMVRXTUhqVzcvSy9scEtSTFd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-key-data</span><span class=p>:</span><span class=w> </span><span class=l>BTCtwb29ic1oxbHJYcXFzTTdaQVN6bUJucldRUTRIU1VFYV</span></span></span></code></pre></div><ul><li>Add new credentials to kubectl configuration</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-credentials podview --client-certificate<span class=o>=</span>podview.pem  --client-key<span class=o>=</span>podview-key.pem</span></span></code></pre></div><ul><li>Lets see what modifications happened with above command.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ cat ~/.kube/config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>SWUZNY2UxeDZkOWtDMWlKQ1puc0VRL3lnMXBobXYxdkxvWkJqTGlBWkRvCjVJYVd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://127.0.0.1:6443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-the-hard-way</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-the-hard-way</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-certificate-data</span><span class=p>:</span><span class=w> </span><span class=l>iUUsyU1hLT0lWQXYzR3hNMVRXTUhqVzcvSy9scEtSTFd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-key-data</span><span class=p>:</span><span class=w> </span><span class=l>BTCtwb29ic1oxbHJYcXFzTTdaQVN6bUJucldRUTRIU1VFYV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-certificate</span><span class=p>:</span><span class=w> </span><span class=l>/home/k8s/podview.pem</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>client-key</span><span class=p>:</span><span class=w> </span><span class=l>/home/k8s/podview-key.pem    </span></span></span></code></pre></div><p>As we all know , kubectl by deafult will act on default namespace.
But here we can change that to <code>monitoring</code> namespace.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-context podview-context --cluster<span class=o>=</span>kubernetes-the-hard-way --namespace<span class=o>=</span>monitoring --user<span class=o>=</span>podview</span></span></code></pre></div><ul><li>Lets see if we can see the Pods</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods --context<span class=o>=</span>podview-context</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>Error</span> <span class=n>from</span> <span class=n>server</span> <span class=p>(</span><span class=no>Forbidden</span><span class=p>):</span> <span class=n>pods</span> <span class=n>is</span> <span class=ss>forbidden</span><span class=p>:</span> <span class=no>User</span> <span class=s2>&#34;podview&#34;</span> <span class=n>cannot</span> <span class=n>list</span> <span class=n>resource</span> <span class=s2>&#34;pods&#34;</span> <span class=k>in</span> <span class=no>API</span> <span class=n>group</span> <span class=s2>&#34;&#34;</span> <span class=k>in</span> <span class=n>the</span> <span class=n>namespace</span> <span class=s2>&#34;monitoring&#34;</span></span></span></code></pre></div><ul><li>Lets create a Role to view Pods</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi podview-role.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f podview-role.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>role.rbac.authorization.k8s.io/podview-role created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi podview-role-binding.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>monitoring</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f podview-role-binding.yaml
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/podview-role-binding created</span></span></code></pre></div><ul><li>Verify Role Binding in Action</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods --context<span class=o>=</span>podview-context</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>No resources found.</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=service-accounts>Service Accounts</h1><p>When you (a human) access the cluster (for example, using kubectl), you are authenticated by the apiserver as a particular User Account (currently this is usually admin, unless your cluster administrator has customized your cluster).
Processes in containers inside pods can also contact the apiserver. When they do, they are authenticated as a particular Service Account (for example, default).</p><p>When you create a pod, it is automatically assigns the default service account in the same namespace.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods nginx --output<span class=o>=</span><span class=nv>jsonpath</span><span class=o>={</span>.spec.serviceAccount<span class=o>}</span> <span class=o>&amp;&amp;</span> echo</span></span></code></pre></div><p>You can access the API from inside a pod using automatically mounted service account credentials.</p><p>Lets start a Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl run debugger --image=ansilh/debug-tools --restart=Never</code></pre></div><p>Login to the Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl exec -it debugger -- /bin/sh</code></pre></div><p>Kubernetes will inject KUBERNETES_SERVICE_HOST & KUBERNETES_SERVICE_PORT_HTTPS variables to the Pod during object creation.
We can use these variables to formulate the API URL</p><p>Also , there is a bearer token which kubernetes mounts to the pod via path /run/secrets/kubernetes.io/serviceaccount/token
We can use this bearer token and pass it as part of HTTP header.</p><div class="wrap-code highlight"><pre tabindex=0><code>APISERVER=https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
TOKEN=$(cat /run/secrets/kubernetes.io/serviceaccount/token)</code></pre></div><p>Use curl command to access the API details</p><div class="wrap-code highlight"><pre tabindex=0><code>curl $APISERVER/api  --header &#34;Authorization: Bearer $TOKEN&#34; --cacert /run/secrets/kubernetes.io/serviceaccount/ca.crt</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;APIVersions&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;versions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;v1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;serverAddressByClientCIDRs&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;clientCIDR&#34;</span><span class=p>:</span> <span class=s2>&#34;0.0.0.0/0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;serverAddress&#34;</span><span class=p>:</span> <span class=s2>&#34;10.136.102.232:6443&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>From where we get this Token and how kubernetes know this token is for which user or group ?</p><p><strong>Kubernetes uses <em>service accounts</em> and <em>tokens</em> to pass authentication and authorization data to objects</strong></p><p>When you create a Pod object , kubernetes will use <code>default</code> service account and inject the token corresponding to the default user.</p><p>Lets see the service accounts in default namespace.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get serviceaccounts</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME      SECRETS   AGE
default   1         24h</code></pre></div><p>Who creates this service account ?</p><p>The <code>default</code> service account will be created by kubernetes during namespace creation.
Which means , when ever you create a namespace , a default service account will also be created.</p><p>In RBAC scheme , the service account will have below naming convention</p><p>system:serviceaccount:<namespace>:<user></p><p>Lets try to access another API endpoint</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl <span class=nv>$APISERVER</span>/api/v1/pods  --header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span> --cacert /run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;Status&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Failure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;pods is forbidden: User \&#34;system:serviceaccount:default:default\&#34; cannot list resource \&#34;pods\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Forbidden&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;pods&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>403</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>This indicates that the <code>default</code> account have no view access to objects in that namespace</p><p>How can give access in this case ?</p><ul><li>Create a new service account</li><li>Create a Role</li><li>Map the Role to the service account using RoleMapping</li><li>Finally , use the newly created service account to access objects</li></ul><p>We already discussed about Roles and RoleMappings in previous <a href=./15-accounts_and_rbacs/03-user-accounts/index.html>session</a>
But we didn&rsquo;t discuss about service accounts or using the service accounts.</p><p>Lets demonstrate that then.</p><ul><li>Create a service account called podview</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create serviceaccount podview</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get serviceaccounts podview -o yaml</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-02-03T16:53:32Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;131763&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selfLink</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/namespaces/default/serviceaccounts/podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>3d601276-27d4-11e9-aa2d-506b8db54343</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>secrets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-token-4blzv</span></span></span></code></pre></div><p>Here we can see a secret named <strong>podview-token-4blzv</strong></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get secrets podview-token-4blzv -o yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ca.crt</span><span class=p>:</span><span class=w> </span><span class=l>LS0tLS1CRUdJTiBDRVJUSUZJQ0FUR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>ZGVmYXVsdA==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/service-account.name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/service-account.uid</span><span class=p>:</span><span class=w> </span><span class=l>3d601276-27d4-11e9-aa2d-506b8db54343</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2019-02-03T16:53:32Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-token-4blzv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceVersion</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;131762&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selfLink</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/namespaces/default/secrets/podview-token-4blzv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>uid</span><span class=p>:</span><span class=w> </span><span class=l>3d61d6ce-27d4-11e9-aa2d-506b8db54343</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/service-account-token</span></span></span></code></pre></div><p>(keys were snipped to fit screen)</p><p>The type is kubernetes.io/service-account-token and we can see ca.crt , namespace (base64 encoded) and a token
These fields will be injected to the Pod if we use the service account <code>podview</code> to create the Pod.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi pod-token.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>podview</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-token.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it debugger -- /bin/sh</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>APISERVER</span><span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_SERVICE_HOST</span><span class=si>}</span>:<span class=si>${</span><span class=nv>KUBERNETES_SERVICE_PORT_HTTPS</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>cat /run/secrets/kubernetes.io/serviceaccount/token<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl <span class=nv>$APISERVER</span>/api/v1/pods  --header <span class=s2>&#34;Authorization: Bearer </span><span class=nv>$TOKEN</span><span class=s2>&#34;</span> --cacert /run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;Status&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;metadata&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;Failure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;pods is forbidden: User \&#34;system:serviceaccount:default:podview\&#34; cannot list resource \&#34;pods\&#34; in API group \&#34;\&#34; at the cluster scope&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;reason&#34;</span><span class=p>:</span> <span class=s2>&#34;Forbidden&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;details&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;kind&#34;</span><span class=p>:</span> <span class=s2>&#34;pods&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=mi>403</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div><p>We got the same message as the one we got while using default account.
Message says that the service account don&rsquo;t have access to Pod object.</p><p>So we will create a ClusterRole first , which will allow this user to access all Pods</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create clusterrole podview-role --verb<span class=o>=</span>get,list,watch --resource<span class=o>=</span>pods --dry-run -o yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create clusterrole podview-role --verb<span class=o>=</span>list,watch --resource<span class=o>=</span>pods</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>clusterrole.rbac.authorization.k8s.io/podview-role created</code></pre></div><p>Now we will bind this role to the user podview</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create clusterrolebinding podview-role-binding --clusterrole<span class=o>=</span>podview-role --serviceaccount<span class=o>=</span>default:podview  --dry-run -o yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create clusterrolebinding podview-role-binding --clusterrole<span class=o>=</span>podview-role --serviceaccount<span class=o>=</span>default:podview</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>clusterrolebinding.rbac.authorization.k8s.io/podview-role-binding created</code></pre></div><p>Lets try to access the API from pod again</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>k8s@k8s-master-ah-01:~$ kubectl exec -it debugger -- /bin/sh
</span></span></span><span class=line><span class=cl><span class=go>/ # APISERVER=https://${KUBERNETES_SERVICE_HOST}:${KUBERNETES_SERVICE_PORT_HTTPS}
</span></span></span><span class=line><span class=cl><span class=go>/ # TOKEN=$(cat /run/secrets/kubernetes.io/serviceaccount/token)
</span></span></span><span class=line><span class=cl><span class=go>/ #
</span></span></span><span class=line><span class=cl><span class=go>/ # curl $APISERVER/api/v1/pods  --header &#34;Authorization: Bearer $TOKEN&#34; --cacert /run/secrets/kubernetes.io/serviceaccount/ca.crt
</span></span></span></code></pre></div><p>(If not working , then delete the service account and recreate it. Need to verify this step)</p><p>You can also create a single yaml file for ServiceAccount , ClusterRole and ClusterRoleBinding</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>podview</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 16</div><h1 id=k8s-from-scratch>K8S From Scratch</h1><p>We will build a kubernetes cluster from scratch</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of K8S From Scratch</h1><article class=default><header class=headline></header><h1 id=api-access-control>API Access Control</h1><p>Users access the API using kubectl, client libraries, or by making REST requests. Both human users and Kubernetes service accounts can be authorized for API access. When a request reaches the API, it goes through several stages, illustrated in the following diagram:</p><p><a href=#R-image-0256f6c28c5132a9b72147f14ef41566 class=lightbox-link><img src="./16-k8s_from_sratch/01-api-access-controll/auth.jpg?class=shadow&amp;width=80pc" alt=Auth class="figure-image bg-white border lightbox noshadow" style=height:auto;width:80pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0256f6c28c5132a9b72147f14ef41566><img src="./16-k8s_from_sratch/01-api-access-controll/auth.jpg?class=shadow&amp;width=80pc" alt=Auth class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><h3 id=authentication>Authentication</h3><p>Once TLS is established, the HTTP request moves to the Authentication step. This is shown as step 1 in the diagram.</p><p>We use X509 Client Certs for authentication.</p><p>When a client certificate is presented and verified, the common name (CN) of the subject is used as the user name for the request.</p><p>Client certificates can also indicate a user’s group memberships using the certificate’s organization fields (O).
To include multiple group memberships for a user, include multiple organization fields in the certificate.</p><p>While Kubernetes uses <code>usernames</code> for access control decisions and in request logging, it does not have a user object nor does it store usernames or other information about users in its object store.</p><h3 id=authorization>Authorization</h3><p>After the request is authenticated as coming from a specific user, the request must be authorized. This is shown as step 2 in the diagram.</p><p>A request must include the username of the requester, the requested action, and the object affected by the action. The request is authorized if an <strong><code>existing role and role mapping</code></strong> declares that the user has permissions to complete the requested action.</p><h3 id=admission-control>Admission Control</h3><p>Admission Control Modules are software modules that can modify or reject requests. This is shown as step 3 in the diagram.
In addition to rejecting objects, admission controllers can also set complex defaults for fields.
Once a request passes all admission controllers, it is validated using the validation routines for the corresponding API object, and then written to the object store (shown as step 4).</p><p>Example of an <a href=https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#alwayspullimages target=_blank>Admission Controller is here</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pre-requisites>Pre-requisites</h1><ul><li>Install an Ubuntu 16.04 VM and create 4 clones from it.</li><li>Make sure to create a user called <code>k8s</code> which will be used in upcoming steps.</li><li>Names should contain your initials for identification purpose if you are using a shared environment.</li><li>Do not change any VM parameters except name while cloning.</li><li>Once cloning completes , start all VMs.</li><li>Make sure to give the hostname with prefix <code>k8s-master-</code> for Master and <code>k8s-worker-</code> for worker
If you miss this , then the scripts/command may fail down the line.</li><li>Create a shell script <code>init.sh</code> on each VM and execute it as mentioned below.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt;init.sh
</span></span></span><span class=line><span class=cl><span class=s>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=s>disable_ipv6(){
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;[INFO] Disabling IPv6&#34;
</span></span></span><span class=line><span class=cl><span class=s> sysctl -w net.ipv6.conf.all.disable_ipv6=1
</span></span></span><span class=line><span class=cl><span class=s> sysctl -w net.ipv6.conf.default.disable_ipv6=1
</span></span></span><span class=line><span class=cl><span class=s> sysctl -w net.ipv6.conf.lo.disable_ipv6=1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s> cat &lt;&lt;EOF</span> &gt;&gt;/etc/sysctl.conf
</span></span><span class=line><span class=cl>net.ipv6.conf.all.disable_ipv6 <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv6.conf.default.disable_ipv6 <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>net.ipv6.conf.lo.disable_ipv6 <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>regenerate_uuid<span class=o>(){</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[INFO] Regenerating machine UUID&#34;</span>
</span></span><span class=line><span class=cl> rm /etc/machine-id /var/lib/dbus/machine-id
</span></span><span class=line><span class=cl> systemd-machine-id-setup
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>regenerate_ssh_keys<span class=o>(){</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[INFO] Regenerating SSH Keys&#34;</span>
</span></span><span class=line><span class=cl> /bin/rm -v /etc/ssh/ssh_host_*
</span></span><span class=line><span class=cl> dpkg-reconfigure openssh-server
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>regenerate_iscsi_iqn<span class=o>(){</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[INFO] Changing iSCSI InitiatorName&#34;</span>
</span></span><span class=line><span class=cl> <span class=nb>echo</span> <span class=s2>&#34;InitiatorName=iqn.1993-08.org.debian:01:</span><span class=k>$(</span>openssl rand -hex 4<span class=k>)</span><span class=s2>&#34;</span> &gt;/etc/iscsi/initiatorname.iscsi
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>disable_ipv6
</span></span><span class=line><span class=cl>regenerate_uuid
</span></span><span class=line><span class=cl>regenerate_ssh_keys
</span></span><span class=line><span class=cl>regenerate_iscsi_iqn
</span></span><span class=line><span class=cl>EOF</span></span></code></pre></div><ul><li>Give execution permission and execute it using <code>sudo</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ chmod <span class=m>755</span> init.sh
</span></span><span class=line><span class=cl>$ sudo ./init.sh</span></span></code></pre></div><ul><li>Set hostname on each VMs
eg:- For master</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ hostnamectl set-hostname k8s-master-ah-01 --static --transient</span></span></code></pre></div><ul><li>Reboot all VMs once host names were set.</li><li>Note down IP each VMs from Prism</li><li>Create /etc/hosts entries on each VM for all VMs.</li></ul><p>eg:-</p><div class="wrap-code highlight"><pre tabindex=0><code>10.136.102.232 k8s-master-ah-01
10.136.102.116 k8s-worker-ah-01
10.136.102.24  k8s-worker-ah-02
10.136.102.253 k8s-worker-ah-03</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tools>Tools</h1><p>Logon to master node and follow below steps</p><h4 id=1-install-cfssl-to-generate-certificates>1. Install cfssl to generate certificates</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget -q --show-progress --https-only --timestamping <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ chmod +x cfssl_linux-amd64 cfssljson_linux-amd64</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span></code></pre></div><ul><li>Verification</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cfssl version</span></span></code></pre></div><ul><li>Output</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Version: 1.2.0
</span></span></span><span class=line><span class=cl><span class=go>Revision: dev
</span></span></span><span class=line><span class=cl><span class=go>Runtime: go1.6
</span></span></span></code></pre></div><h4 id=2-install-kubectl>2. Install kubectl</h4><ul><li>Download <code>kubectl</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubectl</span></span></code></pre></div><ul><li>Make it executable and move to one of the shell <code>$PATH</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ chmod +x kubectl
</span></span><span class=line><span class=cl>$ sudo mv kubectl /usr/local/bin/</span></span></code></pre></div><ul><li>Verification</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl version --client</span></span></code></pre></div><ul><li>Output</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Client Version: version.Info{Major:&#34;1&#34;, Minor:&#34;12&#34;, GitVersion:&#34;v1.12.0&#34;, GitCommit:&#34;0ed33881dc4355495f623c6f22e7dd0b7632b7c0&#34;, GitTreeState:&#34;clean&#34;, BuildDate:&#34;2018-09-27T17:05:32Z&#34;, GoVersion:&#34;go1.10.4&#34;, Compiler:&#34;gc&#34;, Platform:&#34;linux/amd64&#34;}
</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=ca-configuration>CA Configuration</h1><h3 id=pki-infrastructure>PKI Infrastructure</h3><p>We will provision a PKI Infrastructure using CloudFlare&rsquo;s PKI toolkit, cfssl, then use it to bootstrap a Certificate Authority,
and generate TLS certificates for the following components: etcd, kube-apiserver, kube-controller-manager, kube-scheduler, kubelet,
and kube-proxy.</p><h4 id=certificate-authority>Certificate Authority</h4><p><a href=#R-image-9dc822ce3c97ec3c54c7c1f4656c5f6b class=lightbox-link><img src="./16-k8s_from_sratch/04-certificate-ca/ca.jpg?class=shadow&amp;width=70pc" alt=CA class="figure-image bg-white border lightbox noshadow" style=height:auto;width:70pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9dc822ce3c97ec3c54c7c1f4656c5f6b><img src="./16-k8s_from_sratch/04-certificate-ca/ca.jpg?class=shadow&amp;width=70pc" alt=CA class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>In cryptography, a certificate authority or certification authority (CA) is an entity that issues digital certificates.</p><ul><li>Generate CA default files (To understand the structure of CA and CSR json . We will overwrite this configs in next steps)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cfssl print-defaults config &gt; ca-config.json
</span></span><span class=line><span class=cl>$ cfssl print-defaults csr &gt; ca-csr.json</span></span></code></pre></div><ul><li>Modify ca-config and ca-csr to fit your requirement</li></ul><p>OR</p><ul><li>Use below commands to create ca-config and ca-csr JSON files</li></ul><p><strong>CA Configuration</strong></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt;ca-config.json
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>    &#34;signing&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;default&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>            &#34;expiry&#34;: &#34;8760h&#34;
</span></span></span><span class=line><span class=cl><span class=s>        },
</span></span></span><span class=line><span class=cl><span class=s>        &#34;profiles&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>            &#34;kubernetes&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>                &#34;expiry&#34;: &#34;8760h&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                &#34;usages&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>                    &#34;signing&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                    &#34;key encipherment&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                    &#34;server auth&#34;,
</span></span></span><span class=line><span class=cl><span class=s>                    &#34;client auth&#34;
</span></span></span><span class=line><span class=cl><span class=s>                ]
</span></span></span><span class=line><span class=cl><span class=s>            }
</span></span></span><span class=line><span class=cl><span class=s>        }
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><p><strong>CA CSR</strong></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt;ca-csr.json
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>    &#34;CN&#34;: &#34;Kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>        &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>    },
</span></span></span><span class=line><span class=cl><span class=s>    &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>        {
</span></span></span><span class=line><span class=cl><span class=s>            &#34;C&#34;: &#34;IN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;L&#34;: &#34;KL&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;O&#34;: &#34;Kubernetes&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;OU&#34;: &#34;CA&#34;,
</span></span></span><span class=line><span class=cl><span class=s>            &#34;ST&#34;: &#34;Kerala&#34;
</span></span></span><span class=line><span class=cl><span class=s>        }
</span></span></span><span class=line><span class=cl><span class=s>    ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cfssl gencert -initca ca-csr.json <span class=p>|</span>cfssljson -bare ca</span></span></code></pre></div><ul><li>Output</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>generating</span> <span class=n>a</span> <span class=kp>new</span> <span class=no>CA</span> <span class=n>key</span> <span class=ow>and</span> <span class=n>certificate</span> <span class=n>from</span> <span class=no>CSR</span>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>generate</span> <span class=n>received</span> <span class=n>request</span>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>received</span> <span class=no>CSR</span>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>generating</span> <span class=ss>key</span><span class=p>:</span> <span class=n>rsa</span><span class=o>-</span><span class=mi>2048</span>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>encoded</span> <span class=no>CSR</span>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>/</span><span class=mi>10</span><span class=o>/</span><span class=mo>01</span> <span class=mi>22</span><span class=p>:</span><span class=mo>03</span><span class=p>:</span><span class=mi>14</span> <span class=o>[</span><span class=no>INFO</span><span class=o>]</span> <span class=n>signed</span> <span class=n>certificate</span> <span class=n>with</span> <span class=n>serial</span> <span class=n>number</span> <span class=mi>621260968886516247086480084671432552497699065843</span></span></span></code></pre></div><ul><li>ca.pem , ca-key.pem, ca.csr files will be created , but we need only ca.pem and ca-key.pem</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -lrt ca*</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>-rw-rw-r-- 1 k8s k8s  385 Oct  1 21:53 ca-config.json
-rw-rw-r-- 1 k8s k8s  262 Oct  1 21:56 ca-csr.json
-rw-rw-r-- 1 k8s k8s 1350 Oct  1 22:03 ca.pem
-rw------- 1 k8s k8s 1679 Oct  1 22:03 ca-key.pem
-rw-r--r-- 1 k8s k8s  997 Oct  1 22:03 ca.csr</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=client-and-server-certificates>Client and Server Certificates</h1><p>In this section you will generate client and server certificates for each Kubernetes component and a client certificate for
the Kubernetes admin user.</p><h3 id=the-admin-client-certificate-this-will-be-used-for-kubectl-command>The Admin Client Certificate (This will be used for <code>kubectl</code> command)</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; admin-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;IN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Bangalore&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Karnataka&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca-key<span class=o>=</span>ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  admin-csr.json <span class=p>|</span> cfssljson -bare admin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>admin-key.pem
</span></span></span><span class=line><span class=cl><span class=go>admin.pem
</span></span></span></code></pre></div><h3 id=the-kubelet-client-certificates>The Kubelet Client Certificates</h3><p>Kubernetes uses a <a href=https://kubernetes.io/docs/admin/authorization/node/ target=_blank>special-purpose authorization mode</a> called Node Authorizer, that specifically authorizes API requests made by <a href=https://kubernetes.io/docs/concepts/overview/components/#kubelet target=_blank>Kubelets</a>. In order to be authorized by the Node Authorizer, Kubelets must use a credential that identifies them as being in the <code>system:nodes</code> group, with a username of <code>system:node:&lt;nodeName></code>. In this section you will create a certificate for each Kubernetes worker node that meets the Node Authorizer requirements.</p><p>Generate a certificate and private key for each Kubernetes worker node:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>cat /etc/hosts<span class=p>|</span> grep k8s <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>cat &gt; <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>-csr.json <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;CN&#34;: &#34;system:node:${instance}&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;key&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;size&#34;: 2048
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;names&#34;: [
</span></span></span><span class=line><span class=cl><span class=s>    {
</span></span></span><span class=line><span class=cl><span class=s>      &#34;C&#34;: &#34;IN&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;L&#34;: &#34;Bangalore&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
</span></span></span><span class=line><span class=cl><span class=s>      &#34;ST&#34;: &#34;Karnataka&#34;
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>  ]
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cfssl gencert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ca-key<span class=o>=</span>ca-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -config<span class=o>=</span>ca-config.json <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -hostname<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -profile<span class=o>=</span>kubernetes <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>-csr.json <span class=p>|</span> cfssljson -bare <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt k8s*
-rw-rw-r-- 1 k8s k8s  268 Feb  2 16:54 k8s-master-ah-01-csr.json
-rw-rw-r-- 1 k8s k8s  268 Feb  2 16:54 k8s-worker-ah-01-csr.json
-rw-rw-r-- 1 k8s k8s 1513 Feb  2 16:54 k8s-master-ah-01.pem
-rw------- 1 k8s k8s 1679 Feb  2 16:54 k8s-master-ah-01-key.pem
-rw-r--r-- 1 k8s k8s 1082 Feb  2 16:54 k8s-master-ah-01.csr
-rw-rw-r-- 1 k8s k8s 1513 Feb  2 16:54 k8s-worker-ah-01.pem
-rw------- 1 k8s k8s 1679 Feb  2 16:54 k8s-worker-ah-01-key.pem
-rw-r--r-- 1 k8s k8s 1082 Feb  2 16:54 k8s-worker-ah-01.csr
-rw-rw-r-- 1 k8s k8s  268 Feb  2 16:54 k8s-worker-ah-02-csr.json
-rw-rw-r-- 1 k8s k8s  268 Feb  2 16:54 k8s-worker-ah-03-csr.json
-rw-rw-r-- 1 k8s k8s 1513 Feb  2 16:54 k8s-worker-ah-02.pem
-rw------- 1 k8s k8s 1679 Feb  2 16:54 k8s-worker-ah-02-key.pem
-rw-r--r-- 1 k8s k8s 1082 Feb  2 16:54 k8s-worker-ah-02.csr
-rw-rw-r-- 1 k8s k8s 1513 Feb  2 16:54 k8s-worker-ah-03.pem
-rw------- 1 k8s k8s 1675 Feb  2 16:54 k8s-worker-ah-03-key.pem
-rw-r--r-- 1 k8s k8s 1082 Feb  2 16:54 k8s-worker-ah-03.csr</code></pre></div><h3 id=the-controller-manager-client-certificate>The Controller Manager Client Certificate</h3><p>Generate the <code>kube-controller-manager</code> client certificate and private key:</p><div class="wrap-code highlight"><pre tabindex=0><code>{

cat &gt; kube-controller-manager-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-controller-manager&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;IN&#34;,
      &#34;L&#34;: &#34;Bangalore&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
      &#34;ST&#34;: &#34;Karnataka&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager

}</code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt kube-controller*
-rw-rw-r-- 1 k8s k8s  270 Feb  2 16:55 kube-controller-manager-csr.json
-rw-rw-r-- 1 k8s k8s 1472 Feb  2 16:55 kube-controller-manager.pem
-rw------- 1 k8s k8s 1675 Feb  2 16:55 kube-controller-manager-key.pem
-rw-r--r-- 1 k8s k8s 1086 Feb  2 16:55 kube-controller-manager.csr</code></pre></div><h3 id=the-kube-proxy-client-certificate>The Kube Proxy Client Certificate</h3><p>Generate the <code>kube-proxy</code> client certificate and private key:</p><div class="wrap-code highlight"><pre tabindex=0><code>{

cat &gt; kube-proxy-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-proxy&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;IN&#34;,
      &#34;L&#34;: &#34;Bangalore&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
      &#34;ST&#34;: &#34;Karnataka&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-proxy-csr.json | cfssljson -bare kube-proxy

}</code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt kube-proxy*
-rw-rw-r-- 1 k8s k8s  257 Feb  2 16:55 kube-proxy-csr.json
-rw-rw-r-- 1 k8s k8s 1456 Feb  2 16:55 kube-proxy.pem
-rw------- 1 k8s k8s 1675 Feb  2 16:55 kube-proxy-key.pem
-rw-r--r-- 1 k8s k8s 1070 Feb  2 16:55 kube-proxy.csr</code></pre></div><h3 id=the-scheduler-client-certificate>The Scheduler Client Certificate</h3><p>Generate the <code>kube-scheduler</code> client certificate and private key:</p><div class="wrap-code highlight"><pre tabindex=0><code>{

cat &gt; kube-scheduler-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;system:kube-scheduler&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;IN&#34;,
      &#34;L&#34;: &#34;Bangalore&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
      &#34;ST&#34;: &#34;Karnataka&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-scheduler-csr.json | cfssljson -bare kube-scheduler

}</code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt kube-scheduler*
-rw-rw-r-- 1 k8s k8s  261 Feb  2 16:56 kube-scheduler-csr.json
-rw-rw-r-- 1 k8s k8s 1460 Feb  2 16:56 kube-scheduler.pem
-rw------- 1 k8s k8s 1679 Feb  2 16:56 kube-scheduler-key.pem
-rw-r--r-- 1 k8s k8s 1074 Feb  2 16:56 kube-scheduler.csr</code></pre></div><h3 id=the-kubernetes-api-server-certificate>The Kubernetes API Server Certificate</h3><p>IP address will be included in the list of subject alternative names for the Kubernetes API Server certificate. This will ensure the certificate can be validated by remote clients.</p><p>Generate the Kubernetes API Server certificate and private key:</p><div class="wrap-code highlight"><pre tabindex=0><code>{

KUBERNETES_ADDRESS=&#34;$(grep k8s /etc/hosts |awk &#39;{print $1}&#39; | sed &#39;:a;N;$!ba;s/\n/,/g&#39;),172.168.0.1&#34;

cat &gt; kubernetes-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;kubernetes&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;IN&#34;,
      &#34;L&#34;: &#34;Bangalore&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
      &#34;ST&#34;: &#34;Karnataka&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -hostname=${KUBERNETES_ADDRESS},127.0.0.1,kubernetes.default \
  -profile=kubernetes \
  kubernetes-csr.json | cfssljson -bare kubernetes

}</code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt kubernetes*
-rw-rw-r-- 1 k8s k8s  240 Feb  2 17:01 kubernetes-csr.json
-rw-rw-r-- 1 k8s k8s 1501 Feb  2 17:01 kubernetes.pem
-rw------- 1 k8s k8s 1675 Feb  2 17:01 kubernetes-key.pem
-rw-r--r-- 1 k8s k8s 1045 Feb  2 17:01 kubernetes.csr</code></pre></div><h2 id=the-service-account-key-pair>The Service Account Key Pair</h2><p>The Kubernetes Controller Manager leverages a key pair to generate and sign service account tokens as describe in the <a href=https://kubernetes.io/docs/admin/service-accounts-admin/ target=_blank>managing service accounts</a> documentation.</p><p>Generate the <code>service-account</code> certificate and private key:</p><div class="wrap-code highlight"><pre tabindex=0><code>{

cat &gt; service-account-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;service-accounts&#34;,
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;IN&#34;,
      &#34;L&#34;: &#34;Bangalore&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;Kubernetes from Scratch&#34;,
      &#34;ST&#34;: &#34;Karnataka&#34;
    }
  ]
}
EOF

cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  service-account-csr.json | cfssljson -bare service-account

}</code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt service-account*
-rw-rw-r-- 1 k8s k8s  246 Feb  2 17:02 service-account-csr.json
-rw-rw-r-- 1 k8s k8s 1440 Feb  2 17:02 service-account.pem
-rw------- 1 k8s k8s 1679 Feb  2 17:02 service-account-key.pem
-rw-r--r-- 1 k8s k8s 1054 Feb  2 17:02 service-account.csr</code></pre></div><h2 id=distribute-the-client-and-server-certificates>Distribute the Client and Server Certificates</h2><p>Enable SSH key authentication from master node to all worker nodes to transfer files.</p><ul><li>Generate a key</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ssh-keygen</span></span></code></pre></div><ul><li>Copy key to remote systems</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep k8s /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span> <span class=o>(</span>ssh-copy-id <span class=si>${</span><span class=nv>instance</span><span class=si>}</span><span class=o>)</span><span class=p>;</span> <span class=k>done</span></span></span></code></pre></div><ul><li>Copy the appropriate certificates and private keys to each worker instance:</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep k8s /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  scp kubernetes-key.pem kubernetes.pem ca.pem <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>-key.pem <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.pem <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>:~/
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><p>Copy the appropriate certificates and private keys to each controller instance:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep master /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  scp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    service-account-key.pem service-account.pem <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>:~/
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep k8s /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  scp /etc/hosts <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>:~/
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><blockquote><p>The <code>kube-proxy</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code>, and <code>kubelet</code> client certificates will be used to generate client authentication configuration files in the next lab.</p></blockquote><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=configuration-files>Configuration Files</h1><p>In this lab you will generate <a href=https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/ target=_blank>Kubernetes configuration files</a>, also known as kubeconfigs, which enable Kubernetes clients to locate and authenticate to the Kubernetes API Servers.</p><h2 id=client-authentication-configs>Client Authentication Configs</h2><p>In this section you will generate kubeconfig files for the <code>controller manager</code>, <code>kubelet</code>, <code>kube-proxy</code>, and <code>scheduler</code> clients and the <code>admin</code> user.</p><h3 id=kubernetes-public-ip-address>Kubernetes Public IP Address</h3><p>Each kubeconfig requires a Kubernetes API Server to connect to.
Set the KUBERNETES_PUBLIC_ADDRESS with the IP of master.</p><div class="wrap-code highlight"><pre tabindex=0><code>KUBERNETES_PUBLIC_ADDRESS=$(grep master /etc/hosts |awk &#39;{print $1}&#39;)</code></pre></div><h3 id=the-kubelet-kubernetes-configuration-file>The kubelet Kubernetes Configuration File</h3><p>When generating kubeconfig files for Kubelets the client certificate matching the Kubelet&rsquo;s node name must be used. This will ensure Kubelets are properly authorized by the Kubernetes <a href=https://kubernetes.io/docs/admin/authorization/node/ target=_blank>Node Authorizer</a>.</p><p>Generate a kubeconfig file for each worker node:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep k8s /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  kubectl config set-cluster kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-credentials system:node:<span class=si>${</span><span class=nv>instance</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-certificate<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-key<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-context default <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>system:node:<span class=si>${</span><span class=nv>instance</span><span class=si>}</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config use-context default --kubeconfig<span class=o>=</span><span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.kubeconfig
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt *.kubeconfig
-rw------- 1 k8s k8s 6472 Feb  2 17:57 k8s-master-ah-01.kubeconfig
-rw------- 1 k8s k8s 6472 Feb  2 17:57 k8s-worker-ah-01.kubeconfig
-rw------- 1 k8s k8s 6472 Feb  2 17:57 k8s-worker-ah-02.kubeconfig
-rw------- 1 k8s k8s 6468 Feb  2 17:57 k8s-worker-ah-03.kubeconfig</code></pre></div><h3 id=the-kube-proxy-kubernetes-configuration-file>The kube-proxy Kubernetes Configuration File</h3><p>Generate a kubeconfig file for the <code>kube-proxy</code> service:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  kubectl config set-cluster kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-credentials system:kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-certificate<span class=o>=</span>kube-proxy.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-key<span class=o>=</span>kube-proxy-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-context default <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>system:kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config use-context default --kubeconfig<span class=o>=</span>kube-proxy.kubeconfig
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ ls -lrt kube-proxy.kubeconfig
</span></span><span class=line><span class=cl>-rw------- <span class=m>1</span> k8s k8s <span class=m>6370</span> Feb  <span class=m>2</span> 17:58 kube-proxy.kubeconfig</span></span></code></pre></div><h3 id=the-kube-controller-manager-kubernetes-configuration-file>The kube-controller-manager Kubernetes Configuration File</h3><p>Generate a kubeconfig file for the <code>kube-controller-manager</code> service:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  kubectl config set-cluster kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --server<span class=o>=</span>https://127.0.0.1:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-credentials system:kube-controller-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-certificate<span class=o>=</span>kube-controller-manager.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-key<span class=o>=</span>kube-controller-manager-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-context default <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>system:kube-controller-manager <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-controller-manager.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config use-context default --kubeconfig<span class=o>=</span>kube-controller-manager.kubeconfig
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>~$ ls -lrt kube-controller-manager.kubeconfig
</span></span></span><span class=line><span class=cl><span class=go>-rw------- 1 k8s k8s 6411 Feb  2 18:00 kube-controller-manager.kubeconfig
</span></span></span></code></pre></div><h3 id=the-kube-scheduler-kubernetes-configuration-file>The kube-scheduler Kubernetes Configuration File</h3><p>Generate a kubeconfig file for the <code>kube-scheduler</code> service:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  kubectl config set-cluster kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --server<span class=o>=</span>https://127.0.0.1:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-credentials system:kube-scheduler <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-certificate<span class=o>=</span>kube-scheduler.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-key<span class=o>=</span>kube-scheduler-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-context default <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>system:kube-scheduler <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>kube-scheduler.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config use-context default --kubeconfig<span class=o>=</span>kube-scheduler.kubeconfig
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt kube-scheduler.kubeconfig
-rw------- 1 k8s k8s 6381 Feb  2 18:00 kube-scheduler.kubeconfig</code></pre></div><h3 id=the-admin-kubernetes-configuration-file>The admin Kubernetes Configuration File</h3><p>Generate a kubeconfig file for the <code>admin</code> user:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  kubectl config set-cluster kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --server<span class=o>=</span>https://127.0.0.1:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-credentials admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-certificate<span class=o>=</span>admin.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --client-key<span class=o>=</span>admin-key.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config set-context default <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --cluster<span class=o>=</span>kubernetes-the-hard-way <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --user<span class=o>=</span>admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --kubeconfig<span class=o>=</span>admin.kubeconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  kubectl config use-context default --kubeconfig<span class=o>=</span>admin.kubeconfig
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Results:</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ls -lrt admin.kubeconfig
-rw------- 1 k8s k8s 6317 Feb  2 18:01 admin.kubeconfig</code></pre></div><h2 id=distribute-the-kubernetes-configuration-files>Distribute the Kubernetes Configuration Files</h2><p>Copy the appropriate <code>kubelet</code> and <code>kube-proxy</code> kubeconfig files to each worker instance:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep k8s /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  scp <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>.kubeconfig kube-proxy.kubeconfig <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>:~/
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><p>Copy the appropriate <code>kube-controller-manager</code> and <code>kube-scheduler</code> kubeconfig files to each controller instance:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=k>for</span> instance in <span class=k>$(</span>grep master /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2}&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  scp admin.kubeconfig kube-controller-manager.kubeconfig kube-scheduler.kubeconfig <span class=si>${</span><span class=nv>instance</span><span class=si>}</span>:~/
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=etcd-bootstrap>Etcd Bootstrap</h1><h3 id=bootstrapping-the-etcd-cluster>Bootstrapping the etcd Cluster</h3><p>Kubernetes components are stateless and store cluster state in <a href=https://github.com/coreos/etcd target=_blank>etcd</a>.
In this lab you will bootstrap a three node etcd cluster and configure it for high availability and secure remote access.</p><h4 id=prerequisites>Prerequisites</h4><p>The commands in this lab must be run on each worker instance:
Login to each controller instance using the <code>k8s</code> user. Example:</p><div class="wrap-code highlight"><pre tabindex=0><code>ssh k8s-worker-ah-02</code></pre></div><h4 id=running-commands-in-parallel-with-tmux>Running commands in parallel with tmux</h4><p><a href=https://github.com/tmux/tmux/wiki target=_blank>tmux</a> can be used to run commands on multiple compute instances at the same time.</p><h3 id=bootstrapping-an-etcd-cluster-member>Bootstrapping an etcd Cluster Member</h3><h4 id=copy-host-file>Copy host file.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo cp hosts /etc/hosts</span></span></code></pre></div><h4 id=download-and-install-the-etcd-binaries>Download and Install the etcd Binaries.</h4><p>Download the official etcd release binaries from the <a href=https://github.com/coreos/etcd target=_blank>coreos/etcd</a> GitHub project:</p><div class="wrap-code highlight"><pre tabindex=0><code>wget -q --show-progress --https-only --timestamping \
  &#34;https://github.com/coreos/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz&#34;</code></pre></div><p>Extract and install the <code>etcd</code> server and the <code>etcdctl</code> command line utility:</p><div class="wrap-code highlight"><pre tabindex=0><code>{
  tar -xvf etcd-v3.3.9-linux-amd64.tar.gz
  sudo mv etcd-v3.3.9-linux-amd64/etcd* /usr/local/bin/
}</code></pre></div><h4 id=configure-the-etcd-server>Configure the etcd Server</h4><div class="wrap-code highlight"><pre tabindex=0><code>{
  sudo mkdir -p /etc/etcd /var/lib/etcd
  sudo cp ca.pem kubernetes-key.pem kubernetes.pem /etc/etcd/
}</code></pre></div><p>The instance internal IP address will be used to serve client requests and communicate with etcd cluster peers. Retrieve the internal IP address for the current compute instance:</p><div class="wrap-code highlight"><pre tabindex=0><code>INTERNAL_IP=$(grep -w $(hostname) /etc/hosts |awk &#39;{print $1}&#39;)</code></pre></div><p>Each etcd member must have a unique name within an etcd cluster. Set the etcd name to match the hostname of the current compute instance:</p><div class="wrap-code highlight"><pre tabindex=0><code>ETCD_NAME=$(hostname -s)</code></pre></div><p>List of members</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nv>ETCD_MEMBERS</span><span class=o>=</span><span class=k>$(</span>grep worker /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $2&#34;=https://&#34;$1&#34;:2380&#34;}&#39;</span> <span class=p>|</span>sed <span class=s1>&#39;:a;N;$!ba;s/\n/,/g&#39;</span><span class=k>)</span></span></span></code></pre></div><p>Create the <code>etcd.service</code> systemd unit file:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/etcd.service
[Unit]
Description=etcd
Documentation=https://github.com/coreos

[Service]
ExecStart=/usr/local/bin/etcd \\
  --name ${ETCD_NAME} \\
  --cert-file=/etc/etcd/kubernetes.pem \\
  --key-file=/etc/etcd/kubernetes-key.pem \\
  --peer-cert-file=/etc/etcd/kubernetes.pem \\
  --peer-key-file=/etc/etcd/kubernetes-key.pem \\
  --trusted-ca-file=/etc/etcd/ca.pem \\
  --peer-trusted-ca-file=/etc/etcd/ca.pem \\
  --peer-client-cert-auth \\
  --client-cert-auth \\
  --initial-advertise-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-peer-urls https://${INTERNAL_IP}:2380 \\
  --listen-client-urls https://${INTERNAL_IP}:2379,https://127.0.0.1:2379 \\
  --advertise-client-urls https://${INTERNAL_IP}:2379 \\
  --initial-cluster-token etcd-cluster-0 \\
  --initial-cluster ${ETCD_MEMBERS} \\
  --initial-cluster-state new \\
  --data-dir=/var/lib/etcd
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h4 id=start-the-etcd-server>Start the etcd Server</h4><div class="wrap-code highlight"><pre tabindex=0><code>{
  sudo systemctl daemon-reload
  sudo systemctl enable etcd
  sudo systemctl start etcd
}</code></pre></div><blockquote><p>Remember to run the above commands on each controller node: <code>controller-01</code>, <code>controller-02</code>, and <code>controller-03</code>.</p></blockquote><h3 id=verification>Verification</h3><p>List the etcd cluster members:</p><div class="wrap-code highlight"><pre tabindex=0><code>sudo ETCDCTL_API=3 etcdctl member list \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/etcd/ca.pem \
  --cert=/etc/etcd/kubernetes.pem \
  --key=/etc/etcd/kubernetes-key.pem</code></pre></div><blockquote><p>output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>ff3c9dc8bc4ff6e, started, controller-01, https://192.168.78.201:2380, https://192.168.78.201:2379
adfbdba88b62084e, started, controller-02, https://192.168.78.202:2380, https://192.168.78.202:2379
b9a01cb565f3c5e8, started, controller-03, https://192.168.78.203:2380, https://192.168.78.203:2379</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=control-plane-setup>Control Plane Setup</h1><h3 id=bootstrapping-the-kubernetes-control-plane>Bootstrapping the Kubernetes Control Plane</h3><p>In this lab you will bootstrap the Kubernetes control plane across three compute instances and configure it for high availability. You will also create an external load balancer that exposes the Kubernetes API Servers to remote clients. The following components will be installed on each node: Kubernetes API Server, Scheduler, and Controller Manager.</p><h4 id=prerequisites>Prerequisites</h4><p>The commands in this lab must be run only on master node (eg: k8s-master-ah-01)</p><div class="wrap-code highlight"><pre tabindex=0><code>ssh k8s@k8s-master-ah-01</code></pre></div><h3 id=provision-the-kubernetes-control-plane>Provision the Kubernetes Control Plane</h3><p>Create the Kubernetes configuration directory:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p /etc/kubernetes/config</span></span></code></pre></div><h4 id=download-and-install-the-kubernetes-controller-binaries>Download and Install the Kubernetes Controller Binaries</h4><p>Download the official Kubernetes release binaries:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget -q --show-progress --https-only --timestamping <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-apiserver&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-controller-manager&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-scheduler&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  <span class=s2>&#34;https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubectl&#34;</span></span></span></code></pre></div><p>Install the Kubernetes binaries:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  chmod +x kube-apiserver kube-controller-manager kube-scheduler kubectl
</span></span><span class=line><span class=cl>  sudo mv kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h4 id=configure-the-kubernetes-api-server>Configure the Kubernetes API Server</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo mkdir -p /var/lib/kubernetes/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  sudo cp ca.pem ca-key.pem kubernetes-key.pem kubernetes.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    service-account-key.pem service-account.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    /var/lib/kubernetes/
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>The instance IP address will be used to advertise the API Server to members of the cluster.
Retrieve the IP address for the current compute instance:</p><div class="wrap-code highlight"><pre tabindex=0><code>INTERNAL_IP=$(grep -w $(hostname) /etc/hosts |awk &#39;{print $1}&#39;)</code></pre></div><p>Etcd servers</p><div class="wrap-code highlight"><pre tabindex=0><code>$ ETCD_MEMBERS=$(grep worker /etc/hosts |awk &#39;{print &#34;https://&#34;$1&#34;:2379&#34;}&#39; |sed &#39;:a;N;$!ba;s/\n/,/g&#39;)</code></pre></div><p>Create the <code>kube-apiserver.service</code> systemd unit file:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service
[Unit]
Description=Kubernetes API Server
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-apiserver \\
  --advertise-address=${INTERNAL_IP} \\
  --allow-privileged=true \\
  --apiserver-count=3 \\
  --audit-log-maxage=30 \\
  --audit-log-maxbackup=3 \\
  --audit-log-maxsize=100 \\
  --audit-log-path=/var/log/audit.log \\
  --authorization-mode=Node,RBAC \\
  --bind-address=0.0.0.0 \\
  --client-ca-file=/var/lib/kubernetes/ca.pem \\
  --enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
  --enable-swagger-ui=true \\
  --etcd-cafile=/var/lib/kubernetes/ca.pem \\
  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
  --etcd-servers=${ETCD_MEMBERS} \\
  --event-ttl=1h \\
  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
  --kubelet-https=true \\
  --runtime-config=api/all \\
  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
  --service-cluster-ip-range=172.168.0.0/16 \\
  --service-node-port-range=30000-32767 \\
  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
  --requestheader-client-ca-file=/var/lib/kubernetes/ca.pem \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h4 id=configure-the-kubernetes-controller-manager>Configure the Kubernetes Controller Manager</h4><p>Move the <code>kube-controller-manager</code> kubeconfig into place:</p><div class="wrap-code highlight"><pre tabindex=0><code>sudo mv kube-controller-manager.kubeconfig /var/lib/kubernetes/</code></pre></div><p>Create the <code>kube-controller-manager.service</code> systemd unit file:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service
[Unit]
Description=Kubernetes Controller Manager
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-controller-manager \\
  --allocate-node-cidrs=true \\
  --bind-address=0.0.0.0 \\
  --cluster-cidr=10.10.0.0/16 \\
  --cluster-name=kubernetes \\
  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\
  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\
  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\
  --leader-elect=true \\
  --root-ca-file=/var/lib/kubernetes/ca.pem \\
  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\
  --service-cluster-ip-range=172.168.0.0/16 \\
  --use-service-account-credentials=true \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h4 id=configure-the-kubernetes-scheduler>Configure the Kubernetes Scheduler</h4><p>Move the <code>kube-scheduler</code> kubeconfig into place:</p><div class="wrap-code highlight"><pre tabindex=0><code>sudo mv kube-scheduler.kubeconfig /var/lib/kubernetes/</code></pre></div><p>Create the <code>kube-scheduler.yaml</code> configuration file:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | sudo tee /etc/kubernetes/config/kube-scheduler.yaml &gt;/dev/null
apiVersion: kubescheduler.config.k8s.io/v1alpha1
kind: KubeSchedulerConfiguration
clientConnection:
  kubeconfig: &#34;/var/lib/kubernetes/kube-scheduler.kubeconfig&#34;
leaderElection:
  leaderElect: true
EOF</code></pre></div><p>Create the <code>kube-scheduler.service</code> systemd unit file:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kube-scheduler.service
[Unit]
Description=Kubernetes Scheduler
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-scheduler \\
  --config=/etc/kubernetes/config/kube-scheduler.yaml \\
  --v=2
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF</code></pre></div><h4 id=start-the-controller-services>Start the Controller Services</h4><div class="wrap-code highlight"><pre tabindex=0><code>{
  sudo systemctl daemon-reload
  sudo systemctl enable kube-apiserver kube-controller-manager kube-scheduler
  sudo systemctl start kube-apiserver kube-controller-manager kube-scheduler
}</code></pre></div><blockquote><p>Allow up to 10 seconds for the Kubernetes API Server to fully initialize.</p></blockquote><h4 id=verification>Verification</h4><div class="wrap-code highlight"><pre tabindex=0><code>kubectl get componentstatuses --kubeconfig admin.kubeconfig</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>NAME                 STATUS    MESSAGE             ERROR  
controller-manager   Healthy   ok                         
scheduler            Healthy   ok                         
etcd-0               Healthy   {&#34;health&#34;:&#34;true&#34;}          
etcd-2               Healthy   {&#34;health&#34;:&#34;true&#34;}          
etcd-1               Healthy   {&#34;health&#34;:&#34;true&#34;}          </code></pre></div><h3 id=rbac-for-kubelet-authorization>RBAC for Kubelet Authorization</h3><p>In this section you will configure RBAC permissions to allow the Kubernetes API Server to access the Kubelet API on each worker node. Access to the Kubelet API is required for retrieving metrics, logs, and executing commands in pods.</p><blockquote><p>This tutorial sets the Kubelet <code>--authorization-mode</code> flag to <code>Webhook</code>. Webhook mode uses the <a href=https://kubernetes.io/docs/admin/authorization/#checking-api-access target=_blank>SubjectAccessReview</a> API to determine authorization.</p></blockquote><p>Create the <code>system:kube-apiserver-to-kubelet</code> <a href=https://kubernetes.io/docs/admin/authorization/rbac/#role-and-clusterrole target=_blank>ClusterRole</a> with permissions to access the Kubelet API and perform most common tasks associated with managing pods:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - &#34;&#34;
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
    verbs:
      - &#34;*&#34;
EOF</code></pre></div><p>The Kubernetes API Server authenticates to the Kubelet as the <code>kubernetes</code> user using the client certificate as defined by the <code>--kubelet-client-certificate</code> flag.</p><p>Bind the <code>system:kube-apiserver-to-kubelet</code> ClusterRole to the <code>kubernetes</code> user:</p><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: &#34;&#34;
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes
EOF</code></pre></div><h4 id=verification-1>Verification</h4><p>Make a HTTP request for the Kubernetes version info:</p><div class="wrap-code highlight"><pre tabindex=0><code>curl --cacert /var/lib/kubernetes/ca.pem https://$(grep master /etc/hosts |awk &#39;{print $1}&#39;):6443/version</code></pre></div><blockquote><p>output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>{
  &#34;major&#34;: &#34;1&#34;,
  &#34;minor&#34;: &#34;13&#34;,
  &#34;gitVersion&#34;: &#34;v1.13.0&#34;,
  &#34;gitCommit&#34;: &#34;ddf47ac13c1a9483ea035a79cd7c10005ff21a6d&#34;,
  &#34;gitTreeState&#34;: &#34;clean&#34;,
  &#34;buildDate&#34;: &#34;2018-12-03T20:56:12Z&#34;,
  &#34;goVersion&#34;: &#34;go1.11.2&#34;,
  &#34;compiler&#34;: &#34;gc&#34;,
  &#34;platform&#34;: &#34;linux/amd64&#34;
}</code></pre></div><h4 id=configure-kubectl>Configure kubectl</h4><p>Execute this small script to copy the <code>admin.kubeconfig</code> config file to <code>~/.kube/config</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -d ~/.kube <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl> <span class=nb>echo</span> <span class=s2>&#34;Directory .kube exist. Copying config file&#34;</span>
</span></span><span class=line><span class=cl> <span class=k>if</span> <span class=o>[</span> -f ~/.kube/config <span class=o>]</span>
</span></span><span class=line><span class=cl> <span class=k>then</span>
</span></span><span class=line><span class=cl>  cp ~/admin.kubeconfig ~/.kube/config
</span></span><span class=line><span class=cl> <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Directory .kube dosn&#39;t exist, so creating and then copying config file&#34;</span>
</span></span><span class=line><span class=cl>  mkdir ~/.kube
</span></span><span class=line><span class=cl>  cp ~/admin.kubeconfig ~/.kube/config
</span></span><span class=line><span class=cl> <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=worker-plane-setup>Worker Plane Setup</h1><h3 id=bootstrapping-worker-nodes>Bootstrapping worker nodes</h3><p>In this lab , we will bootstrap three worker nodes.
The following components will be installed on each node.</p><ul><li>Docker</li><li>Kubelet</li><li>Kube-proxy</li><li>Calico Network Plugin</li><li>CoreDNS</li></ul><h4 id=docker>Docker</h4><p>Instructions are <a href=./02-installation/04-docker-install/index.html>here</a></p><p>Once docker is installed , execute below steps to make docker ready for <code>kubelet</code> integration.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /lib/systemd/system/docker.service</span></span></code></pre></div><p>Disable iptables, default bridge network and masquerading on docker</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>ExecStart</span><span class=o>=</span><span class=sr>/usr/</span><span class=n>bin</span><span class=o>/</span><span class=n>dockerd</span> <span class=o>-</span><span class=n>H</span> <span class=ss>fd</span><span class=p>:</span><span class=sr>//</span> <span class=o>--</span><span class=n>bridge</span><span class=o>=</span><span class=n>none</span> <span class=o>--</span><span class=n>iptables</span><span class=o>=</span><span class=kp>false</span> <span class=o>--</span><span class=n>ip</span><span class=o>-</span><span class=n>masq</span><span class=o>=</span><span class=kp>false</span></span></span></code></pre></div><p>Cleanup all docker specific networking from worker nodes</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo iptables -t nat -F
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> docker0 down
</span></span><span class=line><span class=cl>$ sudo ip link delete docker0</span></span></code></pre></div><p>Reload and then stop docker (we will start it later)</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl stop docker</span></span></code></pre></div><h4 id=download-and-configure-prerequisites>Download and configure Prerequisites</h4><p>Install few binaries which are needed for proper networking</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo apt-get update
</span></span><span class=line><span class=cl>  sudo apt-get -y install socat conntrack ipset
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Download <code>kuberctl, kube-proxy and kubelet</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget -q --show-progress --https-only --timestamping <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubectl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  https://storage.googleapis.com/kubernetes-release/release/v1.13.0/bin/linux/amd64/kubelet</span></span></code></pre></div><p>Create needed directories</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /var/lib/kubelet <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /var/lib/kube-proxy <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  /var/lib/kubernetes</span></span></code></pre></div><p>Provide execution permission and move to one of the shell $PATH</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ chmod +x kubectl kube-proxy kubelet
</span></span><span class=line><span class=cl>$ sudo mv kubectl kube-proxy kubelet /usr/local/bin/</span></span></code></pre></div><h4 id=kubelet-configuration>Kubelet configuration</h4><p>Move certificates and configuration files to the path created earlier</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo mv <span class=si>${</span><span class=nv>HOSTNAME</span><span class=si>}</span>-key.pem <span class=si>${</span><span class=nv>HOSTNAME</span><span class=si>}</span>.pem /var/lib/kubelet/
</span></span><span class=line><span class=cl>  sudo mv <span class=si>${</span><span class=nv>HOSTNAME</span><span class=si>}</span>.kubeconfig /var/lib/kubelet/kubeconfig
</span></span><span class=line><span class=cl>  sudo mv ca.pem /var/lib/kubernetes/
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><p>Create <code>kubelet</code> configuration</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
</span></span></span><span class=line><span class=cl><span class=s>kind: KubeletConfiguration
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: kubelet.config.k8s.io/v1beta1
</span></span></span><span class=line><span class=cl><span class=s>authentication:
</span></span></span><span class=line><span class=cl><span class=s>  anonymous:
</span></span></span><span class=line><span class=cl><span class=s>    enabled: false
</span></span></span><span class=line><span class=cl><span class=s>  webhook:
</span></span></span><span class=line><span class=cl><span class=s>    enabled: true
</span></span></span><span class=line><span class=cl><span class=s>  x509:
</span></span></span><span class=line><span class=cl><span class=s>    clientCAFile: &#34;/var/lib/kubernetes/ca.pem&#34;
</span></span></span><span class=line><span class=cl><span class=s>authorization:
</span></span></span><span class=line><span class=cl><span class=s>  mode: Webhook
</span></span></span><span class=line><span class=cl><span class=s>clusterDomain: &#34;cluster.local&#34;
</span></span></span><span class=line><span class=cl><span class=s>clusterDNS:
</span></span></span><span class=line><span class=cl><span class=s>  - &#34;172.168.0.2&#34;
</span></span></span><span class=line><span class=cl><span class=s>podCIDR: &#34;${POD_CIDR}&#34;
</span></span></span><span class=line><span class=cl><span class=s>resolvConf: &#34;/run/resolvconf/resolv.conf&#34;
</span></span></span><span class=line><span class=cl><span class=s>runtimeRequestTimeout: &#34;15m&#34;
</span></span></span><span class=line><span class=cl><span class=s>tlsCertFile: &#34;/var/lib/kubelet/${HOSTNAME}.pem&#34;
</span></span></span><span class=line><span class=cl><span class=s>tlsPrivateKeyFile: &#34;/var/lib/kubelet/${HOSTNAME}-key.pem&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><p>Create systemd unit file for <code>kubelet</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \\
</span></span></span><span class=line><span class=cl><span class=s>  --config=/var/lib/kubelet/kubelet-config.yaml \\
</span></span></span><span class=line><span class=cl><span class=s>  --image-pull-progress-deadline=2m \\
</span></span></span><span class=line><span class=cl><span class=s>  --kubeconfig=/var/lib/kubelet/kubeconfig \\
</span></span></span><span class=line><span class=cl><span class=s>  --network-plugin=cni \\
</span></span></span><span class=line><span class=cl><span class=s>  --register-node=true \\
</span></span></span><span class=line><span class=cl><span class=s>  --v=2
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><h4 id=kubernetes-proxy-configuration>Kubernetes Proxy configuration</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mv kube-proxy.kubeconfig /var/lib/kube-proxy/kubeconfig</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
</span></span></span><span class=line><span class=cl><span class=s>kind: KubeProxyConfiguration
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>clientConnection:
</span></span></span><span class=line><span class=cl><span class=s>  kubeconfig: &#34;/var/lib/kube-proxy/kubeconfig&#34;
</span></span></span><span class=line><span class=cl><span class=s>mode: &#34;iptables&#34;
</span></span></span><span class=line><span class=cl><span class=s>clusterCIDR: &#34;10.10.0.0/16&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-proxy.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kube Proxy
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kube-proxy \\
</span></span></span><span class=line><span class=cl><span class=s>  --config=/var/lib/kube-proxy/kube-proxy-config.yaml
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><h4 id=service-startup>Service startup</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>  sudo systemctl <span class=nb>enable</span> docker kubelet kube-proxy
</span></span><span class=line><span class=cl>  sudo systemctl start docker kubelet kube-proxy
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h4 id=calico-cni-deployment>Calico CNI deployment</h4><p>Download deployment yaml.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>https://docs.projectcalico.org/v3.5/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-O</span></span></code></pre></div><p>Modify Pod cidr pool as below</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi calico.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CALICO_IPV4POOL_CIDR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.10.0.0/16&#34;</span></span></span></code></pre></div><p>Create deployment</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl apply -f calico.yaml</code></pre></div><h4 id=coredns-deployment>CoreDNS deployment</h4><p>Download and apply prebuilt CoreDNS yaml</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl apply -f https://raw.githubusercontent.com/ansilh/kubernetes-the-hardway-virtualbox/master/config/coredns.yaml</code></pre></div><h4 id=verification>Verification</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl cluster-info</span></span></code></pre></div><blockquote><p><strong>Output</strong></p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Kubernetes</span><span class=w> </span><span class=n>master</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>running</span><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=c1>//localhost:8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>CoreDNS</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>running</span><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=p>:</span><span class=n>8080</span><span class=o>/</span><span class=n>api</span><span class=o>/</span><span class=n>v1</span><span class=o>/</span><span class=n>namespaces</span><span class=o>/</span><span class=n>kube</span><span class=o>-</span><span class=n>system</span><span class=o>/</span><span class=n>services</span><span class=o>/</span><span class=n>kube</span><span class=o>-</span><span class=n>dns</span><span class=p>:</span><span class=n>dns</span><span class=o>/</span><span class=n>proxy</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get componentstatus</span></span></code></pre></div><blockquote><p><strong>Output</strong></p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                 STATUS    MESSAGE             ERROR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>controller-manager   Healthy   ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>scheduler            Healthy   ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>etcd-0               Healthy   {&#34;health&#34;:&#34;true&#34;}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>etcd-2               Healthy   {&#34;health&#34;:&#34;true&#34;}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>etcd-1               Healthy   {&#34;health&#34;:&#34;true&#34;}</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get nodes</span></span></code></pre></div><blockquote><p><strong>Output</strong></p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME               STATUS   ROLES    AGE   VERSION</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>k8s-worker-ah-01   Ready    &lt;none&gt;   47m   v1.13.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>k8s-worker-ah-02   Ready    &lt;none&gt;   47m   v1.13.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>k8s-worker-ah-03   Ready    &lt;none&gt;   47m   v1.13.0</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -n kube-system</span></span></code></pre></div><blockquote><p><strong>Output</strong></p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                       READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>calico-node-8ztcq          1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>calico-node-hb7gt          1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>calico-node-mjkfn          1/1     Running   0          21m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>coredns-69cbb76ff8-kw8ls   1/1     Running   0          20m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>coredns-69cbb76ff8-vb7rz   1/1     Running   0          20m</span></span></span></code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 17</div><h1 id=persistent-volumes>Persistent Volumes</h1><p>In this session , we will discuss about Persistent volumes and Persistent volume claims.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Persistent Volumes</h1><article class=default><header class=headline></header><h1 id=introduction>Introduction</h1><h3 id=persistent-volumes-and-related-components>Persistent Volumes and Related components</h3><p>The <code>PersistentVolume</code> subsystem provides an API for users and administrators that abstracts details of how storage is provided from how it is consumed.</p><p>To do this we introduce two new API resources: <code>PersistentVolume</code> and <code>PersistentVolumeClaim</code></p><p>A <code>PersistentVolume</code> (PV) is a piece of storage in the cluster that has been provisioned by an administrator.
It is a resource in the cluster just like a node is a cluster resource.
PVs are volume plugins like Volumes, but have a lifecycle independent of any individual pod that uses the PV.
This API object captures the details of the implementation of the storage, be that NFS, iSCSI, or a cloud-provider-specific storage system.</p><p>A <code>PersistentVolumeClaim</code> (PVC) is a request for storage by a user.
It is similar to a pod. Pods consume node resources and PVCs consume PV resources.
Pods can request specific levels of resources (CPU and Memory).
Claims can request specific size and access modes (e.g., can be mounted once read/write or many times read-only).</p><p>A <code>StorageClass</code> provides a way for administrators to describe the “classes” of storage they offer.
Different classes might map to quality-of-service levels, or to backup policies, or to arbitrary policies determined by the cluster administrators.
Kubernetes itself is unopinionated about what classes represent. This concept is sometimes called “profiles” in other storage systems.</p><p><a href=#R-image-b965f4119c30d1bc421cecb451d2aaf4 class=lightbox-link><img src="./17-persistent_volumes/01-intro/intro.jpg?classes=shadow" alt="Dynamic Volumes" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b965f4119c30d1bc421cecb451d2aaf4><img src="./17-persistent_volumes/01-intro/intro.jpg?classes=shadow" alt="Dynamic Volumes" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
Lets follow a basic example outlined below
<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/ target=_blank>https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=iscsi-volume-provisioner>iSCSI Volume Provisioner</h1><h3 id=dynamic-volume-provisioner-with-targetd>Dynamic Volume Provisioner with targetd</h3><h4 id=setup-targetd-iscsi-server-on-centos-7>Setup targetd iscsi server on CentOS 7</h4><ul><li><p>Create a VM with two disks (50GB each)</p></li><li><p>Install CentOS 7 with minimal ISO with default option.
Select only first disk for installation</p></li><li><p>Disable SELinux</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># grep disabled /etc/sysconfig/selinux</span></span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>SELINUX</span><span class=o>=</span>disabled</span></span></code></pre></div><ul><li>Disable firewall</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl disable firewalld
</span></span><span class=line><span class=cl>systemctl stop firewalld</span></span></code></pre></div><ul><li>If yo are not rebooting the OS now , then make sure to disable SELinux using setenforce</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>setenforce <span class=m>0</span></span></span></code></pre></div><ul><li>Install <code>taregtd</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>yum install targetd</span></span></code></pre></div><ul><li>Create a volume group for <code>targetd</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vgcreate vg-targetd /dev/sdb</span></span></code></pre></div><ul><li>Enable targetd RPC access.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vi /etc/target/targetd.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>nutanix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># defaults below; uncomment and edit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># if using a thin pool, use &lt;volume group name&gt;/&lt;thin pool name&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># e.g vg-targetd/pool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>pool_name</span><span class=p>:</span><span class=w> </span><span class=l>vg-targetd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ssl</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>target_name</span><span class=p>:</span><span class=w> </span><span class=l>iqn.2003-01.org.linux-iscsi.k8straining:targetd</span></span></span></code></pre></div><ul><li>Start and enable targetd</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>systemctl start targetd
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> targetd
</span></span><span class=line><span class=cl>systemctl status targetd</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>● target.service - Restore LIO kernel target configuration
</span></span></span><span class=line><span class=cl><span class=go>   Loaded: loaded (/usr/lib/systemd/system/target.service; enabled; vendor preset: disabled)
</span></span></span><span class=line><span class=cl><span class=go>   Active: active (exited) since Wed 2019-02-06 13:12:58 EST; 10s ago
</span></span></span><span class=line><span class=cl><span class=go> Main PID: 15795 (code=exited, status=0/SUCCESS)
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Feb 06 13:12:58 iscsi.k8straining.com systemd[1]: Starting Restore LIO kernel target configuration...
</span></span></span><span class=line><span class=cl><span class=go>Feb 06 13:12:58 iscsi.k8straining.com target[15795]: No saved config file at /etc/target/saveconfig.json, ok, exiting
</span></span></span><span class=line><span class=cl><span class=go>Feb 06 13:12:58 iscsi.k8straining.com systemd[1]: Started Restore LIO kernel target configuration.
</span></span></span></code></pre></div><h4 id=worker-nodes>Worker nodes</h4><p>On each worker nodes</p><p>Make sure the iqn is present</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /etc/iscsi/initiatorname.iscsi</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl status iscsid
</span></span><span class=line><span class=cl>$ sudo systemctl restart iscsid</span></span></code></pre></div><h4 id=download-and-modify-storage-provisioner-yaml-on-master-node>Download and modify storage provisioner yaml on Master node</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create secret generic targetd-account --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>admin --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span>nutanix</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://raw.githubusercontent.com/ansilh/kubernetes-the-hardway-virtualbox/master/config/iscsi-provisioner-d.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vi iscsi-provisioner-d.yaml</span></span></code></pre></div><p>Modify <code>TARGETD_ADDRESS</code> to the targetd server address.</p><h4 id=download-and-modify--persistentvolumeclaim-and-storageclass>Download and modify PersistentVolumeClaim and StorageClass</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://raw.githubusercontent.com/ansilh/kubernetes-the-hardway-virtualbox/master/config/iscsi-provisioner-pvc.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>wget https://raw.githubusercontent.com/ansilh/kubernetes-the-hardway-virtualbox/master/config/iscsi-provisioner-class.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>vi iscsi-provisioner-class.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>targetPortal -&gt; 10.136.102.168</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>iqn -&gt; iqn.2003-01.org.linux-iscsi.k8straining:targetd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>initiators -&gt; iqn.1993-08.org.debian:01:k8s-worker-ah-01,iqn.1993-08.org.debian:01:k8s-worker-ah-02,iqn.1993-08.org.debian:01:k8s-worker-ah-03</span></span></span></code></pre></div><h4 id=apply-all-configuration>Apply all configuration</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f iscsi-provisioner-d.yaml -f iscsi-provisioner-pvc.yaml -f iscsi-provisioner-class.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get all</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                                     READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/iscsi-provisioner-6c977f78d4-gxb2x   1/1     Running   0          33s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-d74ff    1/1     Running   0          147m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-rfgfj    1/1     Running   0          147m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/nginx-deployment-76bf4969df-v4pq5    1/1     Running   0          147m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubernetes   ClusterIP   172.168.0.1   &lt;none&gt;        443/TCP   4d3h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                READY   UP-TO-DATE   AVAILABLE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/iscsi-provisioner   1/1     1            1           33s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/nginx-deployment    3/3     3            3           3h50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                           DESIRED   CURRENT   READY   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/iscsi-provisioner-6c977f78d4   1         1         1       33s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/nginx-deployment-76bf4969df    3         3         3       3h50m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/nginx-deployment-779fcd779f    0         0         0       155m</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pvc</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS               AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>myclaim   Bound    pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343   100Mi      RWO            iscsi-targetd-vg-targetd   4s</span></span></span></code></pre></div><h4 id=on-iscsi-server>On iscsi server</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># targetcli ls</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>Warning</span><span class=p>:</span><span class=w> </span><span class=l>Could not load preferences file /root/.targetcli/prefs.bin.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>o- / ......................................................................................................................... [...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>o- backstores .............................................................................................................. [...]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| o- block .................................................................................................. [Storage Objects</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>| | o- vg-targetd:pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343  [/dev/vg-targetd/pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343 (100.0MiB) write-thru activated]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| |   o- alua ................................................................................................... [ALUA Groups</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| |     o- default_tg_pt_gp ....................................................................... [ALUA state</span><span class=p>:</span><span class=w> </span><span class=l>Active/optimized]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| o- fileio ................................................................................................. [Storage Objects</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| o- pscsi .................................................................................................. [Storage Objects</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| o- ramdisk ................................................................................................ [Storage Objects</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>o- iscsi ............................................................................................................ [Targets</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>| o- iqn.2003-01.org.linux-iscsi.k8straining:targetd ................................................................... [TPGs</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|   o- tpg1 ............................................................................................... [no-gen-acls, no-auth]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     o- acls .......................................................................................................... [ACLs</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     | o- iqn.1993-08.org.debian:01:k8s-worker-ah-01 ........................................................... [Mapped LUNs</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|     | | o- mapped_lun0 ................................... [lun0 block/vg-targetd:pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343 (rw)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     | o- iqn.1993-08.org.debian:01:k8s-worker-ah-02 ........................................................... [Mapped LUNs</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|     | | o- mapped_lun0 ................................... [lun0 block/vg-targetd:pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343 (rw)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     | o- iqn.1993-08.org.debian:01:k8s-worker-ah-03 ........................................................... [Mapped LUNs</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|     |   o- mapped_lun0 ................................... [lun0 block/vg-targetd:pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343 (rw)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     o- luns .......................................................................................................... [LUNs</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|     | o- lun0  [block/vg-targetd:pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343 (/dev/vg-targetd/pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343) (default_tg_pt_gp)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>|     o- portals .................................................................................................... [Portals</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=l>|       o- 0.0.0.0:3260 ..................................................................................................... [OK]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>o- loopback ......................................................................................................... [Targets</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=p>]</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>lvs</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl>  <span class=na>LV</span>                                       <span class=s>VG         Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span>
</span></span><span class=line><span class=cl>  <span class=na>home</span>                                     <span class=s>centos     -wi-ao---- &lt;41.12g</span>
</span></span><span class=line><span class=cl>  <span class=na>root</span>                                     <span class=s>centos     -wi-ao----  50.00g</span>
</span></span><span class=line><span class=cl>  <span class=na>swap</span>                                     <span class=s>centos     -wi-ao----  &lt;7.88g</span>
</span></span><span class=line><span class=cl>  <span class=na>pvc-2a484a72-2a3e-11e9-aa2d-506b8db54343</span> <span class=s>vg-targetd -wi-ao---- 100.00m</span></span></span></code></pre></div><p>More details can be found in below URLs</p><p><a href=https://github.com/kubernetes-incubator/external-storage/tree/master/iscsi/targetd target=_blank>https://github.com/kubernetes-incubator/external-storage/tree/master/iscsi/targetd</a>
<a href=https://github.com/kubernetes-incubator/external-storage/tree/master/iscsi/targetd/kubernetes target=_blank>https://github.com/kubernetes-incubator/external-storage/tree/master/iscsi/targetd/kubernetes</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=nfs-volume-provisioner>NFS Volume Provisioner</h1><h3 id=setup-an-nfs-server>Setup an NFS server</h3><p>In this setup we are assuming that the firewall and SELinux were disabled.</p><ul><li>Install NFS client tools</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo yum install nfs-utils</span></span></code></pre></div><ul><li>Create a share directory</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir /share</span></span></code></pre></div><ul><li>Edit exports file and add entry to share the directory</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /etc/exports</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>/share *(rw,sync,no_root_squash,no_all_squash)</span></span></span></code></pre></div><ul><li>Restart NFS server</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart nfs-server</span></span></code></pre></div><h3 id=deploy-nfs-volume-provisioner>Deploy NFS volume provisioner</h3><ul><li>Create a deployment file using below spec and make sure to modify <code>&lt;NFS_SERVER_IP></code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Recreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>quay.io/external_storage/nfs-client-provisioner:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/persistentvolumes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>PROVISIONER_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>fuseim.pri/ifs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_SERVER</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>&lt;NFS_SERVER_IP&gt; &lt;&lt;&lt;----- Replace this with NFS server IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NFS_PATH</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>/share</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>&lt;NFS_SERVER_IP&gt; &lt;&lt;&lt;----- Replace this with NFS server IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ifs/kubernetes</span></span></span></code></pre></div><ul><li>Create a Storage Class</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>managed-nfs-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>fuseim.pri/ifs</span><span class=w> </span><span class=c># or choose another name, must match deployment&#39;s env PROVISIONER_NAME&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>archiveOnDelete</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;false&#34;</span></span></span></code></pre></div><ul><li>Create Needed RBAC rules</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;persistentvolumes&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;create&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;delete&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;persistentvolumeclaims&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;storage.k8s.io&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;storageclasses&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;events&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;create&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;patch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>run-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner-runner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;endpoints&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;create&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;patch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># replace with namespace where provisioner is deployed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>leader-locking-nfs-client-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span></span></span></code></pre></div><ul><li>Sample claim</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-claim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume.beta.kubernetes.io/storage-class</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;managed-nfs-storage&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Mi</span></span></span></code></pre></div><ul><li>A test pod to claim the volume</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/busybox:1.24</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;/bin/sh&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;touch /mnt/SUCCESS &amp;&amp; sleep 1000 || exit 1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/mnt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Never&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>test-claim      </span></span></span></code></pre></div><p>The Pod will execute a sleep command for 1000 seconds.
You can login to the Pod and verify the volume mount.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 18</div><h1 id=tls-bootstrapping>TLS Bootstrapping</h1><p>In this session , we will discuss about how a node can join a cluster using TLS bootstrapping.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of TLS Bootstrapping</h1><article class=default><header class=headline></header><h1 id=tls-bootstrapping-with-token-file>TLS bootstrapping with token file</h1><h3 id=workflow>Workflow</h3><p><a href=#R-image-459d7033f4d19eec8e968dddecd2f98b class=lightbox-link><img src="./18-tls_bootstrapping/01-bootstapping-with-file/tls-boot-strapping.png?classes=shadow" alt="TLS Bootstrap" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-459d7033f4d19eec8e968dddecd2f98b><img src="./18-tls_bootstrapping/01-bootstapping-with-file/tls-boot-strapping.png?classes=shadow" alt="TLS Bootstrap" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>Create a Token</p><div class="wrap-code highlight"><pre tabindex=0><code>$ head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ echo 12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,\&#34;system:bootstrappers\&#34; |sudo tee -a /etc/kubernetes/config/bootstrap-token.conf</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,&#34;system:bootstrappers&#34;</code></pre></div><p>Create a token auth file</p><div class="wrap-code highlight"><pre tabindex=0><code>$ cat /etc/kubernetes/config/bootstrap-token.conf</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,&#34;system:bootstrappers&#34;</code></pre></div><p>Add below flags to API server</p><div class="wrap-code highlight"><pre tabindex=0><code>--enable-bootstrap-token-auth=true \
--token-auth-file=/etc/kubernetes/config/bootstrap-token.conf \</code></pre></div><p>Add RBAC for Node TLS bootstrapping and certificate auto renewal.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>create-csrs-for-bootstrapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:node-bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-csrs-for-group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-renewals-for-nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><p>Create a bootstrap-kubeconfig which can be used by kubelet</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>awk -F <span class=s2>&#34;,&#34;</span> <span class=s1>&#39;{print $1}&#39;</span> /etc/kubernetes/config/bootstrap-token.conf<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=o>=</span><span class=k>$(</span>grep master /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-cluster bootstrap --embed-certs<span class=o>=</span><span class=nb>true</span> --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=si>}</span>:6443 --certificate-authority<span class=o>=</span>ca.pem</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-credentials kubelet-bootstrap --token<span class=o>=</span><span class=si>${</span><span class=nv>TOKEN</span><span class=si>}</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-context bootstrap --user<span class=o>=</span>kubelet-bootstrap --cluster<span class=o>=</span>bootstrap</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig use-context bootstrap</span></span></code></pre></div><p>Copy bootstrap-kubeconfig to worker node</p><h3 id=kubelet-configuration>Kubelet configuration</h3><ul><li>Turnoff swap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo swapoff /dev/dm-1 <span class=c1>##&lt;--- select appropriate swap device based on your OS config</span></span></span></code></pre></div><ul><li><p>Install and start <a href=./02-installation/04-docker-install/index.html>docker service</a></p></li><li><p>Once docker is installed , execute below steps to make docker ready for <code>kubelet</code> integration.</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /lib/systemd/system/docker.service</span></span></code></pre></div><ul><li>Disable iptables, default bridge network and masquerading on docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>ExecStart</span><span class=o>=</span><span class=sr>/usr/</span><span class=n>bin</span><span class=o>/</span><span class=n>dockerd</span> <span class=o>-</span><span class=n>H</span> <span class=ss>fd</span><span class=p>:</span><span class=sr>//</span> <span class=o>--</span><span class=n>bridge</span><span class=o>=</span><span class=n>none</span> <span class=o>--</span><span class=n>iptables</span><span class=o>=</span><span class=kp>false</span> <span class=o>--</span><span class=n>ip</span><span class=o>-</span><span class=n>masq</span><span class=o>=</span><span class=kp>false</span></span></span></code></pre></div><ul><li>Cleanup all docker specific networking from worker nodes</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo iptables -t nat -F
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> docker0 down
</span></span><span class=line><span class=cl>$ sudo ip link delete docker0</span></span></code></pre></div><ul><li>Restart docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart docker</span></span></code></pre></div><ul><li>Move bootstrap config file to <code>/var/lib/kubelet/</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir /var/lib/kubelet/
</span></span><span class=line><span class=cl>$ sudo mv bootstrap-kubeconfig /var/lib/kubelet/  </span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF |sudo tee /etc/systemd/system/kubelet.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \
</span></span></span><span class=line><span class=cl><span class=s> --bootstrap-kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --cert-dir=/var/lib/kubelet/ \
</span></span></span><span class=line><span class=cl><span class=s> --kubeconfig=/var/lib/kubelet/kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --rotate-certificates=true \
</span></span></span><span class=line><span class=cl><span class=s> --runtime-cgroups=/systemd/system.slice \
</span></span></span><span class=line><span class=cl><span class=s> --kubelet-cgroups=/systemd/system.slice
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Reload and start the kubelet service</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start kubelet</span></span></code></pre></div><p>Now execute kubectl get nodes and see if the node is listed there.</p><p>You may configure <code>kube-proxy</code> as a DaemonSet so that it will automatically start after node registration completion.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tls-bootstrapping-with-bootstrap-token>TLS bootstrapping with bootstrap-token</h1><h3 id=introduction>Introduction</h3><p>Bootstrap tokens are a simple bearer token that is meant to be used when creating new clusters or joining new nodes to an existing cluster. It was built to support kubeadm, but can be used in other contexts for users that wish to start clusters without kubeadm. It is also built to work, via RBAC policy, with the Kubelet TLS Bootstrapping system.</p><p>You can read more about bootstrap tokens <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/ target=_blank>here</a></p><p>Bootstrap Tokens take the form of abcdef.0123456789abcdef.
More formally, they must match the regular expression [a-z0-9]{6}.[a-z0-9]{16}</p><p>In this session , we will join a worker node to the cluster using bootstrap tokens.</p><p>Kubeadm uses bootstrap token to join a node to cluster.</p><p>Implementation Flow of Kubeadm is as follows.</p><ul><li>kubeadm connects to the API server address specified over TLS. As we don&rsquo;t yet have a root certificate to trust, this is an insecure connection and the server certificate is not validated. kubeadm provides no authentication credentials at all.</li></ul><p>Implementation note: the API server doesn&rsquo;t have to expose a new and special insecure HTTP endpoint.</p><p>(D)DoS concern: Before this flow is secure to use/enable publicly (when not bootstrapping), the API Server must support rate-limiting. There are a couple of ways rate-limiting can be implemented to work for this use-case, but defining the rate-limiting flow in detail here is out of scope. One simple idea is limiting unauthenticated requests to come from clients in RFC1918 ranges.</p><ul><li>kubeadm requests a ConfigMap containing the kubeconfig file defined above.
This ConfigMap exists at a well known URL: https://<server>/api/v1/namespaces/kube-public/configmaps/cluster-info</li></ul><p>This ConfigMap is really public. Users don&rsquo;t need to authenticate to read this ConfigMap. In fact, the client MUST NOT use a bearer token here as we don&rsquo;t trust this endpoint yet.</p><ul><li><p>The API server returns the ConfigMap with the kubeconfig contents as normal
Extra data items on that ConfigMap contains JWS signatures. kubeadm finds the correct signature based on the token-id part of the token. (Described below).</p></li><li><p>kubeadm verifies the JWS and can now trust the server. Further communication is simpler as the CA certificate in the kubeconfig file can be trusted.</p></li></ul><p>You may read more about the proposal <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md target=_blank>here</a></p><h3 id=api-server>API server</h3><p>To support bootstrap token based discovery and to join nodes to cluster ; we need to make sure below flags are in place on API server.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>--</span><span class=n>client</span><span class=o>-</span><span class=n>ca</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>enable</span><span class=o>-</span><span class=n>bootstrap</span><span class=o>-</span><span class=n>token</span><span class=o>-</span><span class=n>auth</span><span class=o>=</span><span class=kp>true</span></span></span></code></pre></div><p>If not present , then add these flags to <code>/etc/systemd/system/kube-apiserver.service</code> unit file.</p><h3 id=controller>Controller</h3><p>make sure below flags are in place on kube-controller-manager .</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>--</span><span class=n>controllers</span><span class=o>=*</span><span class=p>,</span><span class=n>bootstrapsigner</span><span class=p>,</span><span class=n>tokencleaner</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>experimental</span><span class=o>-</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>duration</span><span class=o>=</span><span class=mi>8760</span><span class=n>h0m0s</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>cert</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>key</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>-</span><span class=n>key</span><span class=o>.</span><span class=n>pem</span></span></span></code></pre></div><p>If not present , then add these flags to <code>/etc/systemd/system/kube-controller-manager.service</code> unit file.</p><ul><li>Reload and restart API server and Controller unit files</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>  sudo systemctl restart kube-apiserver.service
</span></span><span class=line><span class=cl>  sudo systemctl restart kube-controller-manager.service
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 id=rbac-permission-to-enable-certificate-signign>RBAC Permission to enable certificate signign</h3><ul><li>To allow kubelet to create CSR</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>create-csrs-for-bootstrapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:node-bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>CSR auto signing for bootstrapper</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-csrs-for-group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>Certificates self renewal</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-renewals-for-nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><h3 id=create-bootstrap-token>Create bootstrap token</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=k>$(</span>openssl rand -hex 3<span class=k>)</span>.<span class=k>$(</span>openssl rand -hex 8<span class=k>)</span></span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>80a6ee.fd219151288b08d8
</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi bootstrap-token.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Name MUST be of form &#34;bootstrap-token-&lt;token id&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap-token-80a6ee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap.kubernetes.io/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>stringData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Human readable description. Optional.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;The default bootstrap token.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Token ID and secret. Required.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token-id</span><span class=p>:</span><span class=w> </span><span class=l>80a6ee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token-secret</span><span class=p>:</span><span class=w> </span><span class=l>fd219151288b08d8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Expiration. Optional.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>expiration</span><span class=p>:</span><span class=w> </span><span class=ld>2019-12-05T12:00:00Z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Allowed usages.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>usage-bootstrap-authentication</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>usage-bootstrap-signing</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Extra groups to authenticate the token as. Must start with &#34;system:bootstrappers:&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>auth-extra-groups</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers:worker,system:bootstrappers:ingress</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f bootstrap-token.yaml</span></span></code></pre></div><p>Create cluster-info for clients which will be downloaded if needed by client</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>KUBERNETES_MASTER</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/master/{print $1;exit}&#39;</span> /etc/hosts<span class=k>)</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-cluster bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig-public  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_MASTER</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span>true</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n kube-public create configmap cluster-info <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span><span class=nv>kubeconfig</span><span class=o>=</span>bootstrap-kubeconfig-public</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n kube-public get configmap cluster-info -o yaml</span></span></code></pre></div><ul><li>RBAC to allow anonymous users to access the <code>cluster-info</code> ConfigMap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create role anonymous-for-cluster-info --resource<span class=o>=</span>configmaps --resource-name<span class=o>=</span>cluster-info --namespace<span class=o>=</span>kube-public --verb<span class=o>=</span>get,list,watch
</span></span><span class=line><span class=cl>$ kubectl create rolebinding anonymous-for-cluster-info-binding --role<span class=o>=</span>anonymous-for-cluster-info --user<span class=o>=</span>system:anonymous --namespace<span class=o>=</span>kube-public</span></span></code></pre></div><p>Create bootstrap-kubeconfig for worker nodes</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-cluster bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_MASTER</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span>true</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-credentials kubelet-bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token<span class=o>=</span>80a6ee.fd219151288b08d8</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-context bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --user<span class=o>=</span>kubelet-bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cluster<span class=o>=</span>bootstrap</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig use-context bootstrap</span></span></code></pre></div><p>Copy the bootstrap-kubeconfig to worker node and then execute below steps from worker node.</p><h3 id=kubelet-configuration>Kubelet configuration</h3><ul><li>Turnoff swap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo swapoff /dev/dm-1 <span class=c1>##&lt;--- select appropriate swap device based on your OS config</span></span></span></code></pre></div><ul><li><p>Install and start <a href=./02-installation/04-docker-install/index.html>docker service</a></p></li><li><p>Once docker is installed , execute below steps to make docker ready for <code>kubelet</code> integration.</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /lib/systemd/system/docker.service</span></span></code></pre></div><ul><li>Disable iptables, default bridge network and masquerading on docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>ExecStart</span><span class=o>=</span><span class=sr>/usr/</span><span class=n>bin</span><span class=o>/</span><span class=n>dockerd</span> <span class=o>-</span><span class=n>H</span> <span class=ss>fd</span><span class=p>:</span><span class=sr>//</span> <span class=o>--</span><span class=n>bridge</span><span class=o>=</span><span class=n>none</span> <span class=o>--</span><span class=n>iptables</span><span class=o>=</span><span class=kp>false</span> <span class=o>--</span><span class=n>ip</span><span class=o>-</span><span class=n>masq</span><span class=o>=</span><span class=kp>false</span></span></span></code></pre></div><ul><li>Cleanup all docker specific networking from worker nodes</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo iptables -t nat -F
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> docker0 down
</span></span><span class=line><span class=cl>$ sudo ip link delete docker0</span></span></code></pre></div><ul><li>Restart docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart docker</span></span></code></pre></div><ul><li>Move bootstrap config file to <code>/var/lib/kubelet/</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir /var/lib/kubelet/
</span></span><span class=line><span class=cl>$ sudo mv bootstrap-kubeconfig /var/lib/kubelet/  </span></span></code></pre></div><ul><li>Create a systemd untit file and add necessary flags.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF |sudo tee /etc/systemd/system/kubelet.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \
</span></span></span><span class=line><span class=cl><span class=s> --bootstrap-kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --cert-dir=/var/lib/kubelet/ \
</span></span></span><span class=line><span class=cl><span class=s> --kubeconfig=/var/lib/kubelet/kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --rotate-certificates=true \
</span></span></span><span class=line><span class=cl><span class=s> --runtime-cgroups=/systemd/system.slice \
</span></span></span><span class=line><span class=cl><span class=s> --kubelet-cgroups=/systemd/system.slice
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Reload and start the kubelet service</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start kubelet</span></span></code></pre></div><p>Now execute kubectl get nodes and see if the node is listed there.</p><p>You may configure <code>kube-proxy</code> as a DaemonSet so that it will automatically start after node registration completion.</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 19</div><h1 id=security>Security</h1><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Security</h1><article class=default><header class=headline></header><h1 id=security-context>Security Context</h1><h3 id=configure-a-security-context-for-a-pod-or-container>Configure a Security Context for a Pod or Container</h3><p>A security context defines privilege and access control settings for a Pod or Container. Security context settings include:</p><ul><li><p>Discretionary Access Control: Permission to access an object, like a file, is based on user ID (UID) and group ID (GID).</p></li><li><p>Security Enhanced Linux (SELinux): Objects are assigned security labels.</p></li><li><p>Running as privileged or unprivileged.</p></li><li><p>Linux Capabilities: Give a process some privileges, but not all the privileges of the root user.</p></li><li><p>AppArmor: Use program profiles to restrict the capabilities of individual programs.</p></li><li><p>Seccomp: Filter a process’s system calls.</p></li><li><p>AllowPrivilegeEscalation: Controls whether a process can gain more privileges than its parent process. This bool directly controls whether the no_new_privs flag gets set on the container process. AllowPrivilegeEscalation is true always when the container is: 1) run as Privileged OR 2) has CAP_SYS_ADMIN</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;secure-debugger.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>secure-debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secure-debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sec-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>1000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w> </span><span class=m>2000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secure-debugger</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>sec-vol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data/sec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>allowPrivilegeEscalation</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><strong><code>fsGroup</code>: Volumes that support ownership management are modified to be owned and writable by the GID specified in fsGroup</strong></p></div></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f secure-debugger.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it secure-debugger -- /bin/sh
</span></span><span class=line><span class=cl>/ $ id
</span></span><span class=line><span class=cl><span class=nv>uid</span><span class=o>=</span><span class=m>1000</span> <span class=nv>gid</span><span class=o>=</span>0<span class=o>(</span>root<span class=o>)</span> <span class=nv>groups</span><span class=o>=</span><span class=m>2000</span>
</span></span><span class=line><span class=cl>/ $ ls -ld /data/sec/
</span></span><span class=line><span class=cl>drwxrwsrwx    <span class=m>2</span> root     <span class=m>2000</span>          <span class=m>4096</span> Feb <span class=m>26</span> 17:54 /data/sec/
</span></span><span class=line><span class=cl>/ $ <span class=nb>cd</span> /data/sec/
</span></span><span class=line><span class=cl>/data/sec $ touch test_file
</span></span><span class=line><span class=cl>/data/sec $ ls -lrt
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>-rw-r--r--    <span class=m>1</span> <span class=m>1000</span>     <span class=m>2000</span>             <span class=m>0</span> Feb <span class=m>26</span> 17:54 test_file
</span></span><span class=line><span class=cl>/data/sec $</span></span></code></pre></div><p>To apply capabilities , we can use below in each containers.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>capabilities</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>add</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;NET_ADMIN&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;SYS_TIME&#34;</span><span class=p>]</span></span></span></code></pre></div><p>You may read more about capabilities <a href=http://man7.org/linux/man-pages/man7/capabilities.7.html target=_blank>here</a></p><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p>Read <a href=https://kubernetes.io/docs/tasks/configure-pod-container/security-context/ target=_blank>more</a></p></div></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pod-security-policy>Pod Security Policy</h1><p>A Pod Security Policy is a cluster-level resource that controls security sensitive aspects of the pod specification. The PodSecurityPolicy objects define a set of conditions that a pod must run with in order to be accepted into the system, as well as defaults for the related fields.</p><p>Pod security policy control is implemented as an optional (but recommended) admission controller.
If PSP is not enabled , then enable it in API server using admission-controller flag.</p><p>When a <code>PodSecurityPolicy</code> resource is created, it does nothing. In order to use it, the requesting user or target pod’s <code>ServiceAccount</code> must be authorized to use the policy, by allowing the use verb on the policy.</p><p>i.e.;</p><ul><li>A <code>Role</code> have to be created first with resource <code>PodSecurityPolicy</code> in a namespace</li><li>A <code>RoleBinding</code> have to be created from the <code>ServiceAccount</code> to the <code>Role</code> in a namespace</li><li>Then create a object using <code>kubectl --as=&lt;serviceaccount> -n &lt;namespace> ..</code></li></ul><p>An example PSP is below.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>policy/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PodSecurityPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>example</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>  </span><span class=c># Don&#39;t allow privileged pods!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># The rest fills in some required fields.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>seLinux</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>supplementalGroups</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fsGroup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rule</span><span class=p>:</span><span class=w> </span><span class=l>RunAsAny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=s1>&#39;*&#39;</span></span></span></code></pre></div><p>A well documented example is in <a href=https://kubernetes.io/docs/concepts/policy/pod-security-policy/#example target=_blank>official documentation</a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 20</div><h1 id=elk-stack>ELK Stack</h1><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of ELK Stack</h1><article class=default><header class=headline></header><h1 id=elastic-search>Elastic Search</h1><p>We will create volumes with hostpath for testing purposes.
In production , we will use PVs from a volume provisioner or we will use dynamic volume provisioning</p><ul><li>Create volumes according to the number of nodes</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;es-volumes-manual.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv-001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/data01&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv-002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/data02&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv-003</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/data03&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f es-volumes-manual.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pv</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME             CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                     STORAGECLASS   REASON   AGE
</span></span></span><span class=line><span class=cl><span class=go>pv-001           50Gi       RWO            Retain           Available                             manual                  8s
</span></span></span><span class=line><span class=cl><span class=go>pv-002           50Gi       RWO            Retain           Available                             manual                  8s
</span></span></span><span class=line><span class=cl><span class=go>pv-003           50Gi       RWO            Retain           Available                             manual                  8s
</span></span></span></code></pre></div><p>Create a namespace</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;kube-logging.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f kube-logging.yaml</span></span></code></pre></div><ul><li>Create a headless service</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;es-service.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inter-node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f es-service.yaml</span></span></code></pre></div><p>Create stateful set</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;es_statefulset.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>es-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.elastic.co/elasticsearch/elasticsearch-oss:6.4.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>inter-node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/elasticsearch/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>k8s-logs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>discovery.zen.ping.unicast.hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;es-cluster-0.elasticsearch,es-cluster-1.elasticsearch,es-cluster-2.elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>discovery.zen.minimum_master_nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ES_JAVA_OPTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xms512m -Xmx512m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fix-permissions</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;chown -R 1000:1000 /usr/share/elasticsearch/data&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/elasticsearch/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increase-vm-max-map</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;sysctl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-w&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;vm.max_map_count=262144&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>increase-fd-ulimit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;sh&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;ulimit -n 65536&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>manual</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f es_statefulset.yaml</span></span></code></pre></div><ul><li>Montor StatefulSet rollout status</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl rollout status sts/es-cluster --namespace<span class=o>=</span>kube-logging</span></span></code></pre></div><ul><li>Verify elastic search cluster by checking the state</li></ul><p>Forward the pod port 9200 to localhost port 9200</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl port-forward es-cluster-0 9200:9200 --namespace=kube-logging</code></pre></div><p>Execute curl command to see the cluster state.
Here , master node is <code>'J0ZQqGI0QTqljoLxh5O3-A'</code> , which is <code>es-cluster-0</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=err>curl</span> <span class=err>http:</span><span class=c1>//localhost:9200/_cluster/state?pretty
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cluster_name&#34;</span> <span class=p>:</span> <span class=s2>&#34;k8s-logs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;compressed_size_in_bytes&#34;</span> <span class=p>:</span> <span class=mi>358</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;cluster_uuid&#34;</span> <span class=p>:</span> <span class=s2>&#34;ahM0thu1RSKQ5CXqZOdPHA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;version&#34;</span> <span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;state_uuid&#34;</span> <span class=p>:</span> <span class=s2>&#34;vDwLQHzJSGixU2AItNY1KA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;master_node&#34;</span> <span class=p>:</span> <span class=s2>&#34;J0ZQqGI0QTqljoLxh5O3-A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;blocks&#34;</span> <span class=p>:</span> <span class=p>{</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;nodes&#34;</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;jZdz75kSSSWDpkIHYoRFIA&#34;</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span> <span class=p>:</span> <span class=s2>&#34;es-cluster-1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ephemeral_id&#34;</span> <span class=p>:</span> <span class=s2>&#34;flfl4-TURLS_yTUOlZsx5g&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transport_address&#34;</span> <span class=p>:</span> <span class=s2>&#34;10.10.151.186:9300&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;attributes&#34;</span> <span class=p>:</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;J0ZQqGI0QTqljoLxh5O3-A&#34;</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span> <span class=p>:</span> <span class=s2>&#34;es-cluster-0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ephemeral_id&#34;</span> <span class=p>:</span> <span class=s2>&#34;qXcnM2V1Tcqbw1cWLKDkSg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transport_address&#34;</span> <span class=p>:</span> <span class=s2>&#34;10.10.118.123:9300&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;attributes&#34;</span> <span class=p>:</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;pqGu-mcNQS-OksmiJfCUJA&#34;</span> <span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span> <span class=p>:</span> <span class=s2>&#34;es-cluster-2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;ephemeral_id&#34;</span> <span class=p>:</span> <span class=s2>&#34;X0RtmusQS7KM5LOy9wSF3Q&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transport_address&#34;</span> <span class=p>:</span> <span class=s2>&#34;10.10.36.224:9300&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;attributes&#34;</span> <span class=p>:</span> <span class=p>{</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=err>snippned..</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=kibana>Kibana</h1><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;kibana.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kibana</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>docker.elastic.co/kibana/kibana-oss:6.4.3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ELASTICSEARCH_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>http://elasticsearch:9200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>5601</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f kibana.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl rollout status deployment/kibana --namespace<span class=o>=</span>kube-logging</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Waiting for deployment &#34;kibana&#34; rollout to finish: 0 of 1 updated replicas are available...
</span></span></span><span class=line><span class=cl><span class=go>deployment &#34;kibana&#34; successfully rolled out
</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods --namespace=kube-logging</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME                     READY   STATUS    RESTARTS   AGE
es-cluster-0             1/1     Running   0          21m
es-cluster-1             1/1     Running   0          20m
es-cluster-2             1/1     Running   0          19m
kibana-87b7b8cdd-djbl4   1/1     Running   0          72s</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl port-forward kibana-87b7b8cdd-djbl4 5601:5601 --namespace=kube-logging</code></pre></div><p>You may use <a href=https://blog.devolutions.net/2017/4/how-to-configure-an-ssh-tunnel-on-putty target=_blank>PuTTY tunneling</a> to access the 127.0.0.1:5601 port
or you can use <a href=https://www.ssh.com/ssh/tunneling/example target=_blank>ssh command tunneling</a> if you are using Mac or Linux</p><p>After accessing the URL <code>http://localhost:5601</code> via browser , you will see the Kibana web interface</p><p><a href=#R-image-e53f5c49963ccd2400c2834ef127cdff class=lightbox-link><img src="./20-elk_stack/02-kibana/kibana.jpg?classes=shadow&amp;pc=50" alt=Kibana class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e53f5c49963ccd2400c2834ef127cdff><img src="./20-elk_stack/02-kibana/kibana.jpg?classes=shadow&amp;pc=50" alt=Kibana class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=send-logs-via-fluent-bit>Send logs via Fluent-bit</h1><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;fluent-bit-service-account.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f fluent-bit-service-account.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>serviceaccount/fluent-bit created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;fluent-bit-role.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>namespaces</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=l>get</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=l>list</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=l>watch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f fluent-bit-role.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>clusterrole.rbac.authorization.k8s.io/fluent-bit-read created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;fluent-bit-role-binding.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-read</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f fluent-bit-role-binding.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>clusterrolebinding.rbac.authorization.k8s.io/fluent-bit-read created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;fluent-bit-configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Configuration files: server, input, filters and output</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ======================================================</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fluent-bit.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [SERVICE]
</span></span></span><span class=line><span class=cl><span class=sd>        Flush         1
</span></span></span><span class=line><span class=cl><span class=sd>        Log_Level     info
</span></span></span><span class=line><span class=cl><span class=sd>        Daemon        off
</span></span></span><span class=line><span class=cl><span class=sd>        Parsers_File  parsers.conf
</span></span></span><span class=line><span class=cl><span class=sd>        HTTP_Server   On
</span></span></span><span class=line><span class=cl><span class=sd>        HTTP_Listen   0.0.0.0
</span></span></span><span class=line><span class=cl><span class=sd>        HTTP_Port     2020
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    @INCLUDE input-kubernetes.conf
</span></span></span><span class=line><span class=cl><span class=sd>    @INCLUDE filter-kubernetes.conf
</span></span></span><span class=line><span class=cl><span class=sd>    @INCLUDE output-elasticsearch.conf</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>input-kubernetes.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [INPUT]
</span></span></span><span class=line><span class=cl><span class=sd>        Name              tail
</span></span></span><span class=line><span class=cl><span class=sd>        Tag               kube.*
</span></span></span><span class=line><span class=cl><span class=sd>        Path              /var/log/containers/*.log
</span></span></span><span class=line><span class=cl><span class=sd>        Parser            docker
</span></span></span><span class=line><span class=cl><span class=sd>        DB                /var/log/flb_kube.db
</span></span></span><span class=line><span class=cl><span class=sd>        Mem_Buf_Limit     5MB
</span></span></span><span class=line><span class=cl><span class=sd>        Skip_Long_Lines   On
</span></span></span><span class=line><span class=cl><span class=sd>        Refresh_Interval  10</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>filter-kubernetes.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [FILTER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name                kubernetes
</span></span></span><span class=line><span class=cl><span class=sd>        Match               kube.*
</span></span></span><span class=line><span class=cl><span class=sd>        Kube_URL            https://kubernetes.default:443
</span></span></span><span class=line><span class=cl><span class=sd>        Merge_Log           On
</span></span></span><span class=line><span class=cl><span class=sd>        K8S-Logging.Parser  On</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>output-elasticsearch.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [OUTPUT]
</span></span></span><span class=line><span class=cl><span class=sd>        Name            es
</span></span></span><span class=line><span class=cl><span class=sd>        Match           *
</span></span></span><span class=line><span class=cl><span class=sd>        Host            \${FLUENT_ELASTICSEARCH_HOST}
</span></span></span><span class=line><span class=cl><span class=sd>        Port            \${FLUENT_ELASTICSEARCH_PORT}
</span></span></span><span class=line><span class=cl><span class=sd>        Logstash_Format On
</span></span></span><span class=line><span class=cl><span class=sd>        Retry_Limit     False</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parsers.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name   apache
</span></span></span><span class=line><span class=cl><span class=sd>        Format regex
</span></span></span><span class=line><span class=cl><span class=sd>        Regex  ^(?&lt;host&gt;[^ ]*) [^ ]* (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &#34;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&#34;]*?)(?: +\S*)?)?&#34; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*)(?: &#34;(?&lt;referer&gt;[^\&#34;]*)&#34; &#34;(?&lt;agent&gt;[^\&#34;]*)&#34;)?$
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %d/%b/%Y:%H:%M:%S %z
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name   apache2
</span></span></span><span class=line><span class=cl><span class=sd>        Format regex
</span></span></span><span class=line><span class=cl><span class=sd>        Regex  ^(?&lt;host&gt;[^ ]*) [^ ]* (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &#34;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^ ]*) +\S*)?&#34; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*)(?: &#34;(?&lt;referer&gt;[^\&#34;]*)&#34; &#34;(?&lt;agent&gt;[^\&#34;]*)&#34;)?$
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %d/%b/%Y:%H:%M:%S %z
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name   apache_error
</span></span></span><span class=line><span class=cl><span class=sd>        Format regex
</span></span></span><span class=line><span class=cl><span class=sd>        Regex  ^\[[^ ]* (?&lt;time&gt;[^\]]*)\] \[(?&lt;level&gt;[^\]]*)\](?: \[pid (?&lt;pid&gt;[^\]]*)\])?( \[client (?&lt;client&gt;[^\]]*)\])? (?&lt;message&gt;.*)$
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name   nginx
</span></span></span><span class=line><span class=cl><span class=sd>        Format regex
</span></span></span><span class=line><span class=cl><span class=sd>        Regex ^(?&lt;remote&gt;[^ ]*) (?&lt;host&gt;[^ ]*) (?&lt;user&gt;[^ ]*) \[(?&lt;time&gt;[^\]]*)\] &#34;(?&lt;method&gt;\S+)(?: +(?&lt;path&gt;[^\&#34;]*?)(?: +\S*)?)?&#34; (?&lt;code&gt;[^ ]*) (?&lt;size&gt;[^ ]*)(?: &#34;(?&lt;referer&gt;[^\&#34;]*)&#34; &#34;(?&lt;agent&gt;[^\&#34;]*)&#34;)?$
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %d/%b/%Y:%H:%M:%S %z
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name   json
</span></span></span><span class=line><span class=cl><span class=sd>        Format json
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %d/%b/%Y:%H:%M:%S %z
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name        docker
</span></span></span><span class=line><span class=cl><span class=sd>        Format      json
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key    time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %Y-%m-%dT%H:%M:%S.%L
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Keep   On
</span></span></span><span class=line><span class=cl><span class=sd>        # Command      |  Decoder | Field | Optional Action
</span></span></span><span class=line><span class=cl><span class=sd>        # =============|==================|=================
</span></span></span><span class=line><span class=cl><span class=sd>        Decode_Field_As   escaped    log
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    [PARSER]
</span></span></span><span class=line><span class=cl><span class=sd>        Name        syslog
</span></span></span><span class=line><span class=cl><span class=sd>        Format      regex
</span></span></span><span class=line><span class=cl><span class=sd>        Regex       ^\&lt;(?&lt;pri&gt;[0-9]+)\&gt;(?&lt;time&gt;[^ ]* {1,2}[^ ]* [^ ]*) (?&lt;host&gt;[^ ]*) (?&lt;ident&gt;[a-zA-Z0-9_\/\.\-]*)(?:\[(?&lt;pid&gt;[0-9]+)\])?(?:[^\:]*\:)? *(?&lt;message&gt;.*)$
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Key    time
</span></span></span><span class=line><span class=cl><span class=sd>        Time_Format %b %d %H:%M:%S</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f fluent-bit-configmap.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>configmap/fluent-bit-config created</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;fluent-bit-ds.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>extensions/v1beta1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>k8s-app</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-logging</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>kubernetes.io/cluster-service</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2020&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prometheus.io/path</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/metrics/prometheus</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>fluent/fluent-bit:1.0.4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>2020</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;9200&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/fluent-bit/etc/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>terminationGracePeriodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>varlibdockercontainers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/docker/containers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>fluent-bit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>node-role.kubernetes.io/master</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>Exists</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=l>NoSchedule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f fluent-bit-ds.yaml</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>daemonset.extensions/fluent-bit created</code></pre></div><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 21</div><h1 id=helm>Helm</h1><p><a href=#R-image-d1cca7af12aa7e10370deb53e260fa34 class=lightbox-link><img src=./21-helm/helm.svg alt=helm class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-d1cca7af12aa7e10370deb53e260fa34><img src=./21-helm/helm.svg alt=helm class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>The package manager for kubernetes and much more..</p><p>Helm is the best way to find, share, and use software built for kubernetes.</p><p><b>Read this <a href=https://medium.com/virtuslab/think-twice-before-using-helm-25fbb18bc822 target=_blank>post</a> before adopting Helm</b></p><p><b>Also read <a href=https://github.com/helm/community/blob/master/helm-v3/000-helm-v3.md target=_blank>Helm 3</a> design proposal<b></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Helm</h1><article class=default><header class=headline></header><h1 id=installation>Installation</h1><h4 id=download-helm-binaries>Download Helm binaries</h4><ul><li>Go to <code>https://github.com/helm/helm/releases</code></li><li>Copy download location from <code>Installation and Upgrading</code> section.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ wget https://storage.googleapis.com/kubernetes-helm/helm-v2.13.0-linux-amd64.tar.gz</span></span></code></pre></div><h4 id=extract-tarball>Extract tarball</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tar -xvf helm-v2.13.0-linux-amd64.tar.gz</span></span></code></pre></div><h4 id=configure-helm-client>Configure <code>Helm</code> client.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mv linux-amd64/helm /usr/local/bin/helm
</span></span><span class=line><span class=cl>$ helm version</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>Client: &amp;version.Version{SemVer:&#34;v2.13.0&#34;, GitCommit:&#34;79d07943b03aea2b76c12644b4b54733bc5958d6&#34;, GitTreeState:&#34;clean&#34;}
Error: could not find tiller</code></pre></div><h4 id=helm-server-side-configuration---tiller>Helm Server side configuration - Tiller</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;tiller-rbac.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tiller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tiller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cluster-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tiller</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f tiller-rbac.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm init --service-account tiller</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>Creating /home/k8s/.helm
Creating /home/k8s/.helm/repository
Creating /home/k8s/.helm/repository/cache
Creating /home/k8s/.helm/repository/local
Creating /home/k8s/.helm/plugins
Creating /home/k8s/.helm/starters
Creating /home/k8s/.helm/cache/archive
Creating /home/k8s/.helm/repository/repositories.yaml
Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com
Adding local repo with URL: http://127.0.0.1:8879/charts
$HELM_HOME has been configured at /home/k8s/.helm.

Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.

Please note: by default, Tiller is deployed with an insecure &#39;allow unauthenticated users&#39; policy.
To prevent this, run `helm init` with the --tiller-tls-verify flag.
For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation
Happy Helming!</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods -n kube-system <span class=p>|</span>grep tiller</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>tiller-deploy-5b7c66d59c-8t7pc               1/1     Running   0          36s</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=a-minimal-package>A Minimal Package</h1><p>In this demo , we will create an Nginx deployment with one replica.
This demo is like more or less applying a deployment yaml . But in upcoming sessions we will see how we can leverage helm to customize the deployment without modifying yaml specs.</p><h4 id=create-a-demo-helm-nginx-pkg-package>Create a demo helm-nginx-pkg package</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir helm-nginx-pkg</span></span></code></pre></div><ul><li>Create a <code>templates</code> directory.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir helm-nginx-pkg/templates</span></span></code></pre></div><h4 id=create-a-deployment-yaml-inside-templates-diretory>Create a deployment yaml inside <code>templates</code> diretory.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run nginx-deployment --image<span class=o>=</span>nginx:1.9.10 --dry-run -o yaml &gt;helm-nginx-pkg/templates/nginx-deployment.yaml</span></span></code></pre></div><h4 id=create-a-chartyaml-httpshelmshdocsdeveloping_chartsthe-chart-yaml-file>Create a Chart.yaml (<a href=https://helm.sh/docs/developing_charts/#the-chart-yaml-file target=_blank>https://helm.sh/docs/developing_charts/#the-chart-yaml-file</a>)</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;helm-nginx-pkg/Chart.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Demo Helm chart to deploy Nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>maintainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Ansil H&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;ansilh@gmail.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://ansilh.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><h4 id=inspect-the-chart-and-see-the-details-of-package><code>inspect</code> the chart and see the details of package.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm inspect chart ./helm-nginx-pkg/</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=l>Demo Helm chart to deploy Nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>maintainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>email</span><span class=p>:</span><span class=w> </span><span class=l>ansilh@gmail.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Ansil H</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>https://ansilh.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span></span></span></code></pre></div><h4 id=dry-run-install-to-see-everything-works-or-not>Dry-run install to see everything works or not</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm install ./helm-nginx-pkg  --debug --dry-run</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>[debug] Created tunnel using local port</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;43945&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[debug] SERVER</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1:43945&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[debug] Original chart version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[debug] CHART PATH</span><span class=p>:</span><span class=w> </span><span class=l>/home/k8s/helm-nginx-pkg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NAME</span><span class=p>:</span><span class=w>   </span><span class=l>alliterating-crab</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>REVISION</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RELEASED</span><span class=p>:</span><span class=w> </span><span class=l>Fri Mar 15 14:13:59 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>CHART</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>USER-SUPPLIED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>COMPUTED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>HOOKS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>MANIFEST</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Source: nginx-deployment/templates/nginx-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.9.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><h4 id=to-verify-nothing-is-created-as-part-of-dry-run>To verify nothing is created as part of dry-run</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm ls</span></span></code></pre></div><h4 id=install-package>Install package</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm install ./helm-nginx-pkg</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>NAME</span><span class=p>:</span><span class=w>   </span><span class=l>filled-toad</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>LAST DEPLOYED</span><span class=p>:</span><span class=w> </span><span class=l>Fri Mar 15 14:15:50 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NAMESPACE</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>STATUS</span><span class=p>:</span><span class=w> </span><span class=l>DEPLOYED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME              READY  UP-TO-DATE  AVAILABLE  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment  0/1    0           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Pod(related)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                               READY  STATUS   RESTARTS  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-64f767964b-qj9t9  0/1    Pending  0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>$ kubectl get pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-64f767964b-qj9t9   1/1     Running   0          16s</span></span></span></code></pre></div><h4 id=list-deployed-charts>List deployed charts</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm ls</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME       	REVISION	UPDATED                 	STATUS  	CHART             	APP VERSION	NAMESPACE
</span></span></span><span class=line><span class=cl><span class=go>filled-toad	1       	Fri Mar 15 14:15:50 2019	DEPLOYED	nginx-deployment-1	           	default
</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-64f767964b-drfcc   1/1     Running   0          21s</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=lint>Lint</h1><h4 id=linting>Linting</h4><p>Helm lint will help to correct and standardize the package format</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm lint ./helm-nginx-pkg/</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>==&gt; Linting ./helm-nginx-pkg/
[ERROR] Chart.yaml: directory name (helm-nginx-pkg) and chart name (nginx-deployment) must be the same
[INFO] Chart.yaml: icon is recommended
[INFO] values.yaml: file does not exist

Error: 1 chart(s) linted, 1 chart(s) failed</code></pre></div><h4 id=lets-correct-the-errors>Lets correct the errors</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mv helm-nginx-pkg nginx-deployment</span></span></code></pre></div><ul><li>Add an icon path (we will see where its used later)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;&gt;nginx-deployment/Chart.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>icon</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;https://img.icons8.com/nolan/64/000000/linux.png&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>Create <code>values.yaml</code> (we will see the use of this file later)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ touch nginx-deployment/values.yaml</span></span></code></pre></div><ul><li>Lint the package again</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm lint ./nginx-deployment</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>==&gt; Linting ./nginx-deployment
Lint OK

1 chart(s) linted, no failures</code></pre></div><p>This time we see a perfect &ldquo;OK&rdquo;</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=upgrade>Upgrade</h1><h1 id=deployment>Deployment</h1><h4 id=modify-values-file-with-below-content>Modify <code>values</code> file with below content</h4><div class="wrap-code highlight"><pre tabindex=0><code>cat &lt;&lt;EOF &gt;nginx-deployment/values.yaml
replicaCount: 2
image:
  repository: &#34;nginx&#34;
  tag: &#34;1.14&#34;
EOF</code></pre></div><h4 id=modify-deployment-template>Modify deployment template</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi nginx-deployment/templates/nginx-deployment.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>.Values.replicaCount }}</span><span class=w> </span><span class=c># &lt;-- This is value is referred from values.yaml `replicaCount` field</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span>{{<span class=w> </span><span class=l>.Values.image.repository }}:{{ .Values.image.tag }}</span><span class=w> </span><span class=c># &lt;-- this is self explanatory :)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><h4 id=lint-the-chart-to-make-sure-everything-good>Lint the chart to make sure everything good.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm lint ./nginx-deployment/</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>==&gt; Linting ./nginx-deployment/
Lint OK

1 chart(s) linted, no failures</code></pre></div><ul><li>The <code>REVISION</code> is <code>1</code> as of now.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm ls</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>NAME</span>            <span class=s>REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE</span>
</span></span><span class=line><span class=cl><span class=na>ungaged-possum</span>  <span class=s>1               Fri Mar 15 16:41:28 2019        DEPLOYED        nginx-deployment-1                      default</span></span></span></code></pre></div><h4 id=execute-a-dry-run>Execute a dry-run</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm upgrade ungaged-possum ./nginx-deployment/   --dry-run --debug</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>[debug] Created tunnel using local port</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;43533&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>[debug] SERVER</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;127.0.0.1:43533&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>REVISION</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RELEASED</span><span class=p>:</span><span class=w> </span><span class=l>Fri Mar 15 18:17:19 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>CHART</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>USER-SUPPLIED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>COMPUTED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1.14&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>HOOKS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>MANIFEST</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Source: nginx-deployment/templates/nginx-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.14</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>Release &#34;ungaged-possum&#34; has been upgraded. Happy Helming!</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>LAST DEPLOYED</span><span class=p>:</span><span class=w> </span><span class=l>Fri Mar 15 16:41:28 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NAMESPACE</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>STATUS</span><span class=p>:</span><span class=w> </span><span class=l>DEPLOYED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME              READY  UP-TO-DATE  AVAILABLE  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment  1/1    1           1          95m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Pod(related)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                               READY  STATUS   RESTARTS  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-64f767964b-drfcc  1/1    Running  0         95m</span></span></span></code></pre></div><h4 id=upgrade-package>Upgrade package</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm upgrade ungaged-possum ./nginx-deployment/</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>Release</span> <span class=s>&#34;ungaged-possum&#34; has been upgraded. Happy Helming!</span>
</span></span><span class=line><span class=cl><span class=na>LAST</span> <span class=s>DEPLOYED: Fri Mar 15 18:17:52 2019</span>
</span></span><span class=line><span class=cl><span class=na>NAMESPACE</span><span class=o>:</span> <span class=s>default</span>
</span></span><span class=line><span class=cl><span class=na>STATUS</span><span class=o>:</span> <span class=s>DEPLOYED</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>RESOURCES</span><span class=o>:</span>
</span></span><span class=line><span class=cl><span class=na>=</span><span class=o>=</span><span class=s>&gt; v1/Deployment</span>
</span></span><span class=line><span class=cl><span class=na>NAME</span>              <span class=s>READY  UP-TO-DATE  AVAILABLE  AGE</span>
</span></span><span class=line><span class=cl><span class=na>nginx-deployment</span>  <span class=s>1/2    1           1          96m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>=</span><span class=o>=</span><span class=s>&gt; v1/Pod(related)</span>
</span></span><span class=line><span class=cl><span class=na>NAME</span>                               <span class=s>READY  STATUS   RESTARTS  AGE</span>
</span></span><span class=line><span class=cl><span class=na>nginx-deployment-64f767964b-drfcc</span>  <span class=s>1/1    Running  0         96m</span></span></span></code></pre></div><h4 id=verify-the-number-of-pods-after-upgarde>Verify the number of <code>Pods</code> after upgarde.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME                               READY   STATUS    RESTARTS   AGE
nginx-deployment-d5d56dcf9-6cxvk   1/1     Running   0          7s
nginx-deployment-d5d56dcf9-8r868   1/1     Running   0          20s</code></pre></div><h4 id=verify-the-new-nginx-version>Verify the new Nginx version</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> nginx-deployment-d5d56dcf9-6cxvk -- nginx -v</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>nginx version: nginx/1.14.2</code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm ls</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>NAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE
ungaged-possum  2               Fri Mar 15 18:17:52 2019        DEPLOYED        nginx-deployment-1                      default</code></pre></div><h4 id=check-the-helm-upgrade-history>Check the helm upgrade history</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm <span class=nb>history</span> ungaged-possum</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>REVISION        UPDATED                         STATUS          CHART                   DESCRIPTION
1               Fri Mar 15 16:41:28 2019        SUPERSEDED      nginx-deployment-1      Install complete
2               Fri Mar 15 18:17:52 2019        DEPLOYED        nginx-deployment-1      Upgrade complete</code></pre></div><h4 id=check-the-changes-happened-between-revisions>Check the changes happened between revisions</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sdiff &lt;<span class=o>(</span>helm get ungaged-possum --revision<span class=o>=</span>1<span class=o>)</span> &lt;<span class=o>(</span>helm get ungaged-possum --revision<span class=o>=</span>2<span class=o>)</span></span></span></code></pre></div><div class="box notices cstyle note"><div class=box-label><i class="fa-fw fas fa-exclamation-circle"></i> Note</div><div class=box-content><p><b>Output on right hand side shows the changed values.<br><code>|</code> Indicates changes in line.<br><code>></code> Indicates inserted lines.</b></p></div></div><div class="wrap-code highlight"><pre tabindex=0><code>REVISION: 1                                                   | REVISION: 2
RELEASED: Fri Mar 15 16:41:28 2019                            | RELEASED: Fri Mar 15 18:17:52 2019
CHART: nginx-deployment-1                                       CHART: nginx-deployment-1
USER-SUPPLIED VALUES:                                           USER-SUPPLIED VALUES:
{}                                                              {}

COMPUTED VALUES:                                                COMPUTED VALUES:
{}                                                            | image:
                                                              &gt;   repository: nginx
                                                              &gt;   tag: &#34;1.14&#34;
                                                              &gt; replicaCount: 2

HOOKS:                                                          HOOKS:
MANIFEST:                                                       MANIFEST:

---                                                             ---
# Source: nginx-deployment/templates/nginx-deployment.yaml      # Source: nginx-deployment/templates/nginx-deployment.yaml
apiVersion: apps/v1                                             apiVersion: apps/v1
kind: Deployment                                                kind: Deployment
metadata:                                                       metadata:
  creationTimestamp: null                                         creationTimestamp: null
  labels:                                                         labels:
    run: nginx-deployment                                           run: nginx-deployment
  name: nginx-deployment                                          name: nginx-deployment
spec:                                                           spec:
  replicas: 1                                                 |   replicas: 2
  selector:                                                       selector:
    matchLabels:                                                    matchLabels:
      run: nginx-deployment                                           run: nginx-deployment
  strategy: {}                                                    strategy: {}
  template:                                                       template:
    metadata:                                                       metadata:
      creationTimestamp: null                                         creationTimestamp: null
      labels:                                                         labels:
        run: nginx-deployment                                           run: nginx-deployment
    spec:                                                           spec:
      containers:                                                     containers:
      - image: nginx:1.9.10                                   |       - image: nginx:1.14
        name: nginx-deployment                                          name: nginx-deployment
        resources: {}                                                   resources: {}
status: {}                                                      status: {}</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=rollback>Rollback</h1><h4 id=list-revisions>List revisions</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm list</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ungaged-possum  2               Fri Mar 15 18:17:52 2019        DEPLOYED        nginx-deployment-1                      default</span></span></span></code></pre></div><h4 id=rollback-to-revision-1>Rollback to revision 1</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm rollback ungaged-possum <span class=m>1</span></span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Rollback was a success! Happy Helming!
</span></span></span></code></pre></div><h4 id=list-the-revision-after-rollback>List the revision after rollback</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm list</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>ungaged-possum  3               Sat Mar 16 10:14:47 2019        DEPLOYED        nginx-deployment-1                      default</span></span></span></code></pre></div><h4 id=verify-rollback>Verify rollback</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                                READY   STATUS    RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>nginx-deployment-64f767964b-trx7h   1/1     Running   0          44s</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> nginx-deployment-64f767964b-trx7h -- nginx -v</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>nginx version</span><span class=p>:</span><span class=w> </span><span class=l>nginx/1.9.10</span></span></span></code></pre></div><h4 id=examine-the-changes-between-active-revision-and-previous-one>Examine the changes between active revision and previous one.</h4><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sdiff &lt;<span class=o>(</span>helm get ungaged-possum --revision<span class=o>=</span>2<span class=o>)</span> &lt;<span class=o>(</span>helm get ungaged-possum --revision<span class=o>=</span>3<span class=o>)</span></span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>REVISION: 2                                                   | REVISION</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RELEASED: Fri Mar 15 18:17:52 2019                            | RELEASED</span><span class=p>:</span><span class=w> </span><span class=l>Sat Mar 16 10:14:47 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>CHART: nginx-deployment-1                                       CHART</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>USER-SUPPLIED VALUES</span><span class=p>:</span><span class=w>                                           </span><span class=nt>USER-SUPPLIED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>{}<span class=w>                                                              </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>COMPUTED VALUES</span><span class=p>:</span><span class=w>                                                </span><span class=nt>COMPUTED VALUES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>                                                        </span><span class=l>| {}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>nginx                                           &lt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1.14&#34;</span><span class=w>                                                 </span><span class=l>&lt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>                                               </span><span class=l>&lt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>HOOKS</span><span class=p>:</span><span class=w>                                                          </span><span class=nt>HOOKS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>MANIFEST</span><span class=p>:</span><span class=w>                                                       </span><span class=nt>MANIFEST</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>                                                             </span>---<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Source: nginx-deployment/templates/nginx-deployment.yaml      # Source: nginx-deployment/templates/nginx-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion: apps/v1                                             apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind: Deployment                                                kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>                                                       </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp: null                                         creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>                                                         </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run: nginx-deployment                                           run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name: nginx-deployment                                          name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>                                                           </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas: 2                                                 |   replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>                                                       </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>                                                    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run: nginx-deployment                                           run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{<span class=nt>}                                                    strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>                                                       </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>                                                       </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp: null                                         creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>                                                         </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run: nginx-deployment                                           run</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>                                                           </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>                                                     </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>image: nginx:1.14                                     |       - image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.9.10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name: nginx-deployment                                          name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{<span class=nt>}                                                   resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{<span class=nt>}                                                      status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>In earlier sections , we have notices that there is no change in chart.
Its recommended to change the chart version based on the changes you make</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi nginx-deployment/Chart.yaml</span></span></code></pre></div><p>Change revision from 1 to 2</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>2</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=helm-create>Helm Create</h1><p>With <code>create</code> command , we can create a standard helm directory/file structure which can be modified for our package.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ helm create mychart</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ tree mychart/</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>mychart/
├── Chart.yaml         # A YAML file containing information about the chart.
├── charts             # A directory containing any charts upon which this chart depends.
├── templates          # A directory of templates that, when combined with values, will generate valid Kubernetes manifest files.
│   ├── NOTES.txt      # A plain text file containing short usage notes.
│   ├── _helpers.tpl   # Also called &#34;partials&#34; that can be embedded into existing files while a Chart is being installed.
│   ├── deployment.yaml # A deployment spec
│   ├── ingress.yaml    # An ingress spec
│   ├── service.yaml    # An service spec
│   └── tests  
│       └── test-connection.yaml # A pod definition , that can be executed to test the Chart(https://github.com/helm/helm/blob/master/docs/chart_tests.md)
└── values.yaml         # The default configuration values for this chart

3 directories, 8 files</code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=kubeapps>Kubeapps</h1><p>Kubeapps is a web-based UI for deploying and managing applications in Kubernetes clusters</p><h4 id=kubeapps-installation>Kubeapps Installation</h4><ul><li>List present repos</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm repo list</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>NAME    URL
</span></span></span><span class=line><span class=cl><span class=go>stable  https://kubernetes-charts.storage.googleapis.com
</span></span></span><span class=line><span class=cl><span class=go>local   http://127.0.0.1:8879/charts
</span></span></span></code></pre></div><ul><li>Add bitnami repo</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm repo add bitnami https://charts.bitnami.com/bitnami</span></span></code></pre></div><p>&ldquo;bitnami&rdquo; has been added to your repositories</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm repo list</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>NAME</span>    <span class=s>URL</span>
</span></span><span class=line><span class=cl><span class=na>stable</span>  <span class=s>https://kubernetes-charts.storage.googleapis.com</span>
</span></span><span class=line><span class=cl><span class=na>local</span>   <span class=s>http://127.0.0.1:8879/charts</span>
</span></span><span class=line><span class=cl><span class=na>bitnami</span> <span class=s>https://charts.bitnami.com/bitnami</span></span></span></code></pre></div><ul><li>Install Kubeapps</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm install --name kubeapps --namespace kubeapps bitnami/kubeapps</span></span></code></pre></div><p>If it fails with below error , execute install one more time</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Error: unable to recognize &#34;&#34;: no matches for kind &#34;AppRepository&#34; in version &#34;kubeapps.com/v1alpha1&#34;
</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>NAME</span><span class=p>:</span><span class=w>   </span><span class=l>kubeapps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>LAST DEPLOYED</span><span class=p>:</span><span class=w> </span><span class=l>Sat Mar 16 11:00:08 2019</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NAMESPACE</span><span class=p>:</span><span class=w> </span><span class=l>kubeapps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>STATUS</span><span class=p>:</span><span class=w> </span><span class=l>DEPLOYED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                DATA  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-frontend-config            1     0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-dashboard-config  2     0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Pod(related)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                                         READY  STATUS             RESTARTS  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-6b59fbd4c5-8ggdr                                    0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-6b59fbd4c5-pbt4h                                    0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-apprepository-controller-59bff895fb-tjdtb  0/1    ContainerCreating  0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-chartsvc-5cc9c456fc-7r24x                  0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-chartsvc-5cc9c456fc-rzgzx                  0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-dashboard-6b54cd94fc-bm2st                 0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-dashboard-6b54cd94fc-zskq5                 0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy-d584c568c-spf8m               0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy-d584c568c-z2skv               0/1    Pending            0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-mongodb-8694b4b9f6-jqxw2                            0/1    ContainerCreating  0         0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                            TYPE       CLUSTER-IP       EXTERNAL-IP  PORT(S)    AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps                        ClusterIP  172.168.130.35   &lt;none&gt;       80/TCP     0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-chartsvc      ClusterIP  172.168.155.89   &lt;none&gt;       8080/TCP   0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-dashboard     ClusterIP  172.168.201.176  &lt;none&gt;       8080/TCP   0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy  ClusterIP  172.168.20.4     &lt;none&gt;       8080/TCP   0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-mongodb                ClusterIP  172.168.84.95    &lt;none&gt;       27017/TCP  0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1/ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                        SECRETS  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-apprepository-controller  1        0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy              1        0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1beta1/Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME              READY  UP-TO-DATE  AVAILABLE  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-mongodb  0/1    1           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1beta1/Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                        AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-apprepository-controller  0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy              0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-repositories-read                  0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-repositories-write                 0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1beta1/RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                        AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-apprepository-controller  0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy              0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>==&gt; v1beta2/Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                        READY  UP-TO-DATE  AVAILABLE  AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps                                    0/2    0           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-apprepository-controller  0/1    1           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-chartsvc                  0/2    0           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-dashboard                 0/2    0           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubeapps-internal-tiller-proxy              0/2    0           0          0s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NOTES</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>**</span><span class=w> </span><span class=l>Please be patient while the chart is being deployed **</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Tip</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>Watch the deployment status using the command</span><span class=p>:</span><span class=w> </span><span class=l>kubectl get pods -w --namespace kubeapps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Kubeapps can be accessed via port 80 on the following DNS name from within your cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>kubeapps.kubeapps.svc.cluster.local</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>To access Kubeapps from outside your K8s cluster, follow the steps below</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>1. Get the Kubeapps URL by running these commands</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>echo &#34;Kubeapps URL: http://127.0.0.1:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>export POD_NAME=$(kubectl get pods --namespace kubeapps -l &#34;app=kubeapps&#34; -o jsonpath=&#34;{.items[0].metadata.name}&#34;)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>kubectl port-forward --namespace kubeapps $POD_NAME 8080:8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=m>2</span><span class=l>. Open a browser and access Kubeapps using the obtained URL.</span></span></span></code></pre></div><ul><li>Make sure everything is no failed objects in <code>kubeapps</code> namespace.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get all --namespace<span class=o>=</span>kubeapps</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>NAME                                                              READY   STATUS      RESTARTS   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/apprepo-sync-bitnami-9f266-6ds4l                              0/1     Completed   0          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/apprepo-sync-incubator-p6fjk-q7hv2                            0/1     Completed   0          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/apprepo-sync-stable-79l58-mqrmg                               1/1     Running     0          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/apprepo-sync-svc-cat-725kn-kxvg6                              0/1     Completed   0          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-6b59fbd4c5-8ggdr                                     1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-6b59fbd4c5-pbt4h                                     1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-apprepository-controller-59bff895fb-tjdtb   1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-chartsvc-5cc9c456fc-7r24x                   1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-chartsvc-5cc9c456fc-rzgzx                   1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-dashboard-6b54cd94fc-bm2st                  1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-dashboard-6b54cd94fc-zskq5                  1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-tiller-proxy-d584c568c-spf8m                1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-internal-tiller-proxy-d584c568c-z2skv                1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>pod/kubeapps-mongodb-8694b4b9f6-jqxw2                             1/1     Running     0          2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                     TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)     AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubeapps                         ClusterIP   172.168.130.35    &lt;none&gt;        80/TCP      2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubeapps-internal-chartsvc       ClusterIP   172.168.155.89    &lt;none&gt;        8080/TCP    2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubeapps-internal-dashboard      ClusterIP   172.168.201.176   &lt;none&gt;        8080/TCP    2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubeapps-internal-tiller-proxy   ClusterIP   172.168.20.4      &lt;none&gt;        8080/TCP    2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>service/kubeapps-mongodb                 ClusterIP   172.168.84.95     &lt;none&gt;        27017/TCP   2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                                         READY   UP-TO-DATE   AVAILABLE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps                                     2/2     2            2           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps-internal-apprepository-controller   1/1     1            1           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps-internal-chartsvc                   2/2     2            2           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps-internal-dashboard                  2/2     2            2           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps-internal-tiller-proxy               2/2     2            2           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>deployment.apps/kubeapps-mongodb                             1/1     1            1           2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                                                    DESIRED   CURRENT   READY   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-6b59fbd4c5                                     2         2         2       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-internal-apprepository-controller-59bff895fb   1         1         1       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-internal-chartsvc-5cc9c456fc                   2         2         2       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-internal-dashboard-6b54cd94fc                  2         2         2       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-internal-tiller-proxy-d584c568c                2         2         2       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>replicaset.apps/kubeapps-mongodb-8694b4b9f6                             1         1         1       2m15s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                     COMPLETIONS   DURATION   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>job.batch/apprepo-sync-bitnami-9f266     1/1           53s        54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>job.batch/apprepo-sync-incubator-p6fjk   1/1           54s        54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>job.batch/apprepo-sync-stable-79l58      0/1           54s        54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>job.batch/apprepo-sync-svc-cat-725kn     1/1           13s        54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>NAME                                   SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cronjob.batch/apprepo-sync-bitnami     0 * * * *   False     0        &lt;none&gt;          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cronjob.batch/apprepo-sync-incubator   0 * * * *   False     0        &lt;none&gt;          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cronjob.batch/apprepo-sync-stable      0 * * * *   False     0        &lt;none&gt;          54s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>cronjob.batch/apprepo-sync-svc-cat     0 * * * *   False     0        &lt;none&gt;          54s</span></span></span></code></pre></div><ul><li>Access Kubeapps dashboard
(My API server&rsquo;s insecure port is listening on 8080 port , so I had to use 8081 for port-forwarding)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>export</span> <span class=nv>POD_NAME</span><span class=o>=</span><span class=k>$(</span>kubectl get pods --namespace kubeapps -l <span class=s2>&#34;app=kubeapps&#34;</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.items[0].metadata.name}&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>$ kubectl port-forward --namespace kubeapps <span class=nv>$POD_NAME</span> 8080:8081</span></span></code></pre></div><ul><li>Start an tunnel to 127.0.0.1:8081 using SSH via the host</li><li>Access Web GUI</li></ul><p><a href=#R-image-134b63fc1b3bd682a79fedbb7758b347 class=lightbox-link><img src="./21-helm/07-kubeapp/login.jpg?classes=shadow" alt=Kubeapps class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-134b63fc1b3bd682a79fedbb7758b347><img src="./21-helm/07-kubeapp/login.jpg?classes=shadow" alt=Kubeapps class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><ul><li>Create a service account for Kubeapps login</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create serviceaccount kubeapps-operator
</span></span><span class=line><span class=cl>$ kubectl create clusterrolebinding kubeapps-operator --clusterrole<span class=o>=</span>cluster-admin --serviceaccount<span class=o>=</span>default:kubeapps-operator</span></span></code></pre></div><ul><li>Retrieve token</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get secret <span class=k>$(</span>kubectl get serviceaccount kubeapps-operator -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.secrets[].name}&#39;</span><span class=k>)</span> -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.token}&#39;</span> <span class=p>|</span> base64 --decode</span></span></code></pre></div><ul><li>Use this token to login</li></ul><p><a href=#R-image-408b63c63f1de2964a65ab6ba66ab25b class=lightbox-link><img src="./21-helm/07-kubeapp/after-login.jpg?classes=shadow" alt=KubeApps class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-408b63c63f1de2964a65ab6ba66ab25b><img src="./21-helm/07-kubeapp/after-login.jpg?classes=shadow" alt=KubeApps class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><ul><li>Click on <code>Catalog</code> to see all Helm charts from upstream repositories.</li></ul><p><a href=#R-image-9632404726f843ac8c1188b5c17a5649 class=lightbox-link><img src="./21-helm/07-kubeapp/catalog.jpg?classes=shadow" alt=Catalog class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-9632404726f843ac8c1188b5c17a5649><img src="./21-helm/07-kubeapp/catalog.jpg?classes=shadow" alt=Catalog class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=chartmuseum>ChartMuseum</h1><div><a href=https://chartmuseum.com target=_blank><img src=./21-helm/08-chart_museum/chartmuseum.svg style=display:block;margin-left:auto;margin-right:auto;width:10%></a></div>We can use ChartMuseum to host our own Helm packages.
In this session , we will configure ChartMuseum and will add the repository to Kubeapps<p>We will also upload the nginx-deployment helm package that we have created in earlier session to our local repository.</p><ul><li>Download and configure chartmuseum</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -LO https://s3.amazonaws.com/chartmuseum/release/latest/bin/linux/amd64/chartmuseum</span></span></code></pre></div><div class="box notices cstyle info"><div class=box-label><i class="fa-fw fas fa-info-circle"></i> Info</div><div class=box-content><p>We will be using <b>/{HOME}/chartstorage</b> directory to store the packages</p></div></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ chmod +x ./chartmuseum
</span></span><span class=line><span class=cl>$ sudo mv ./chartmuseum /usr/local/bin
</span></span><span class=line><span class=cl>$ mkdir ./chartstorage</span></span></code></pre></div><ul><li>Create a systemd service file.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>cat &lt;&lt;EOF | sudo tee /etc/systemd/system/chartmuseum.service
</span></span></span><span class=line><span class=cl><span class=go>[Unit]
</span></span></span><span class=line><span class=cl><span class=go>Description=Helm Chartmuseum
</span></span></span><span class=line><span class=cl><span class=go>Documentation=https://chartmuseum.com/
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[Service]
</span></span></span><span class=line><span class=cl><span class=go>ExecStart=/usr/local/bin/chartmuseum \\
</span></span></span><span class=line><span class=cl><span class=go> --debug \\
</span></span></span><span class=line><span class=cl><span class=go> --port=8090 \\
</span></span></span><span class=line><span class=cl><span class=go> --storage=&#34;local&#34; \\
</span></span></span><span class=line><span class=cl><span class=go> --storage-local-rootdir=&#34;/home/${USER}/chartstorage/&#34;
</span></span></span><span class=line><span class=cl><span class=go>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=go>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[Install]
</span></span></span><span class=line><span class=cl><span class=go>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span></code></pre></div><ul><li>Start chartmuseum</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start chartmuseum
</span></span><span class=line><span class=cl>$ sudo systemctl <span class=nb>enable</span> chartmuseum</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Created symlink from /etc/systemd/system/multi-user.target.wants/chartmuseum.service to /etc/systemd/system/chartmuseum.service.
</span></span></span></code></pre></div><ul><li>Package our Helm chart</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> nginx-deployment/
</span></span><span class=line><span class=cl>$ helm package .</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Successfully packaged chart and saved it to: /home/ubuntu/nginx-deployment/nginx-deployment-2.tgz
</span></span></span></code></pre></div><ul><li>Upload package to ChartMuseum</li></ul><p>The URL IP is the IP of system which the chartmuseum service is running.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ curl -L --data-binary <span class=s2>&#34;@/home/ubuntu/nginx-deployment/nginx-deployment-2.tgz&#34;</span> 192.168.31.20:8090/api/charts</span></span></code></pre></div><ul><li>Also add the repository to helm</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ helm repo add chartmuseum http://192.168.31.20:8090</span></span></code></pre></div><ul><li>Add repo to Kubeapps</li></ul><p>Click <code>Configuration</code> -> <code>App Repositories</code> -> <code>Add App Repository</code></p><p>Fill <code>Name</code> and <code>URL</code> , then click <code>Install Repo</code></p><p><a href=#R-image-f6edfa2cafe0c930726ff61fdf3b4979 class=lightbox-link><img src=./21-helm/08-chart_museum/add-repo.jpg alt=repoadd class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-f6edfa2cafe0c930726ff61fdf3b4979><img src=./21-helm/08-chart_museum/add-repo.jpg alt=repoadd class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><ul><li>Repo will appear in the list after addition</li></ul><p><a href=#R-image-c269247f19c1982f97be7e3bc9df05d6 class=lightbox-link><img src=./21-helm/08-chart_museum/added-repo.jpg alt=repoadded class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c269247f19c1982f97be7e3bc9df05d6><img src=./21-helm/08-chart_museum/added-repo.jpg alt=repoadded class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><ul><li>View the Helm packages which is hosted in ChartMuseum</li></ul><p>Click <code>Catalog</code> and search <code>nginx-deployment</code></p><p>Remember , we have added an <code>icon</code> in our <code>Chart.yaml</code> file . You can see the same icon in deployment.</p><p><a href=#R-image-af6a475338f3768cc488bd95ec08ce8d class=lightbox-link><img src=./21-helm/08-chart_museum/demo-nginx.jpg alt=repochart class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-af6a475338f3768cc488bd95ec08ce8d><img src=./21-helm/08-chart_museum/demo-nginx.jpg alt=repochart class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=chartmuseum-ui>ChartMuseum UI</h1><p>Earlier we used <code>curl</code> command to upload our first helm package.
In this session , we will configure a UI for our local repository so that we can add/delete packages easily.</p><ul><li>Set <code>CHART_MUSESUM_URL</code> variable to the local repo URL.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>CHART_MUSESUM_URL</span><span class=o>=</span>http://192.168.31.20:8090</span></span></code></pre></div><ul><li>Create a deployment and service for UI.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF &gt;chartmuseum-ui.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>CHART_MUSESUM_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>${CHART_MUSESUM_URL}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>idobry/chartmuseumui:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>chartmuseum-ui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>Apply the spec to <code>kubeapps</code> namespace</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f chartmuseum-ui.yaml --namespace<span class=o>=</span>kubeapps</span></span></code></pre></div><ul><li>Verify everything is in good state. (We may have to wait for few minutes while downloading the container image)</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get all --namespace<span class=o>=</span>kubeapps <span class=p>|</span>grep chartmuseum-ui</span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>pod/chartmuseum-ui-57b6d8f7dc-nbwwt                               1/1     Running     0          99s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>service/chartmuseum-ui                   LoadBalancer   172.168.85.102    192.168.31.202   80:30640/TCP   99s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>deployment.apps/chartmuseum-ui                               1/1     1            1           99s
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>replicaset.apps/chartmuseum-ui-57b6d8f7dc                 
</span></span></span></code></pre></div><ul><li>Now we can access the UI using cluster IP and add or delete Helm packages to our local repository.</li></ul><p><a href=#R-image-71ddf2d1395bbdc5eff5b6afa9995302 class=lightbox-link><img src=./21-helm/09-chartmuseum-ui/ui.jpg alt=ui class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-71ddf2d1395bbdc5eff5b6afa9995302><img src=./21-helm/09-chartmuseum-ui/ui.jpg alt=ui class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 22</div><h1 id=security>Security</h1><p>We will see two Statefulset examples in this session</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Security</h1><article class=default><header class=headline></header><h1 id=nginx>Nginx</h1><h3 id=headless-service>HeadLess service</h3><p>For headless Services that do not define selectors, the endpoints controller does not create Endpoints records. However, the DNS system will create entries
This will help application to do discovery of active pods</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span></span></span></code></pre></div><h3 id=ordinal-index>Ordinal Index</h3><p>Ordinal index starts from 0 to N-1 where N is the number of replicas in spec</p><h3 id=startstop-order>Start/Stop order</h3><p>For a StatefulSet with N replicas, when Pods are being deployed, they are created sequentially, in order from {0..N-1}</p><h3 id=nginx-statefulset>Nginx StatefulSet</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nginx&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>k8s.gcr.io/nginx-slim:0.8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>www</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>www</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=w> </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>iscsi-targetd-vg-targetd</span></span></span></code></pre></div><h3 id=basics>Basics</h3><p><a href=https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/ target=_blank>https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=cassandra>Cassandra</h1><h3 id=example>Example</h3><p><a href=https://kubernetes.io/docs/tutorials/stateful-application/cassandra/ target=_blank>https://kubernetes.io/docs/tutorials/stateful-application/cassandra/</a></p><p>Testing cassandra</p><footer class=footline></footer></article></section><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 23</div><h1 id=harbor-private-registry>Harbor Private Registry</h1><p>In this session we will deploy and configure a private registry usng <code>Harbor</code></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Harbor Private Registry</h1><article class=default><header class=headline></header><h1 id=setup-harbor>Setup Harbor</h1><p><a href=#R-image-c658b221fd6a871c27ed648a4bd3bc0e class=lightbox-link><img src=./23-harobor/01-private-registry/harbor.jpg alt=Harbor class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-c658b221fd6a871c27ed648a4bd3bc0e><img src=./23-harobor/01-private-registry/harbor.jpg alt=Harbor class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>All container images that we used in the previous examples were downloaded from <code>Docker Hub</code> which is a public registry.
But in production environments , we have to use private image registry so that we will have better control of images and its security.</p><p>In this session , we will deploy a private registry using <strong><code>Harbor</code></strong></p><p>Students needs to deploy this in a separate <code>Ubuntu 16.04</code> LTS VM (4GB memmory + 2vCPUs). If you are attending live session , then instructor will provide private registry URL and credentials.</p><p>In this lab , we use below IP/FQDN. Make sure to create necessary DNS entries or /etc/hosts entries to use the registry once configured.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>IP Address : 10.136.102.79
</span></span></span><span class=line><span class=cl><span class=go>FQDN: k8s-harbor-registry.linxlabs.com
</span></span></span></code></pre></div><h3 id=install-docker>Install Docker</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span class=p>|</span> sudo apt-key add -
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo add-apt-repository <span class=s2>&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class=k>$(</span>lsb_release -cs<span class=k>)</span><span class=s2> stable&#34;</span>
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo apt-get update
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo apt-get install -y docker-ce
</span></span></code></pre></div><p>Verify Docker service state</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo systemctl status docker --no-pager --lines <span class=m>0</span>
</span></span></code></pre></div><p>Example output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>● docker.service - Docker Application Container Engine
</span></span></span><span class=line><span class=cl><span class=go>   Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
</span></span></span><span class=line><span class=cl><span class=go>   Active: active (running) since Fri 2020-04-10 20:49:29 IST; 2min 27s ago
</span></span></span><span class=line><span class=cl><span class=go>     Docs: https://docs.docker.com
</span></span></span><span class=line><span class=cl><span class=go> Main PID: 4315 (dockerd)
</span></span></span><span class=line><span class=cl><span class=go>   CGroup: /system.slice/docker.service
</span></span></span><span class=line><span class=cl><span class=go>           └─4315 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
</span></span></span></code></pre></div><h3 id=download-docker-compose-binary>Download <code>docker-compose</code> binary</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> sudo curl -L <span class=s2>&#34;https://github.com/docker/compose/releases/download/1.25.5/docker-compose-</span><span class=k>$(</span>uname -s<span class=k>)</span><span class=s2>-</span><span class=k>$(</span>uname -m<span class=k>)</span><span class=s2>&#34;</span> -o /usr/local/bin/docker-compose
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo chmod +x /usr/local/bin/docker-compose
</span></span><span class=line><span class=cl><span class=gp>$</span> sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
</span></span></code></pre></div><h3 id=setup-certificates>Setup Certificates</h3><p>Create a staging directory first</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>mkdir ~/harbor_certs/
</span></span></span><span class=line><span class=cl><span class=go>cd ~/harbor_certs/
</span></span></span></code></pre></div><p>Create CA</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>openssl genrsa -out ca.key 4096
</span></span></span><span class=line><span class=cl><span class=go>openssl req -x509 -new -nodes -sha512 -days 3650 \
</span></span></span><span class=line><span class=cl><span class=go> -subj &#34;/C=IN/ST=Kerala/L=Kollam/O=demo/OU=Personal/CN=ca.linxlabs.com&#34; \
</span></span></span><span class=line><span class=cl><span class=go> -key ca.key \
</span></span></span><span class=line><span class=cl><span class=go> -out ca.crt
</span></span></span></code></pre></div><p>Create SSL extension file</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>cat &gt; v3.ext &lt;&lt;-EOF
</span></span></span><span class=line><span class=cl><span class=go>authorityKeyIdentifier=keyid,issuer
</span></span></span><span class=line><span class=cl><span class=go>basicConstraints=CA:FALSE
</span></span></span><span class=line><span class=cl><span class=go>keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
</span></span></span><span class=line><span class=cl><span class=go>extendedKeyUsage = serverAuth
</span></span></span><span class=line><span class=cl><span class=go>subjectAltName = @alt_names
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>[alt_names]
</span></span></span><span class=line><span class=cl><span class=go>DNS.1=linxlabs.com
</span></span></span><span class=line><span class=cl><span class=go>DNS.2=k8s-harbor-registry.linxlabs.com
</span></span></span><span class=line><span class=cl><span class=go>DNS.3=k8s-harbor-registry
</span></span></span><span class=line><span class=cl><span class=go>EOF
</span></span></span></code></pre></div><p>Create a Ceertificate Signing Request(CSR) for Harbor&rsquo;s nginx service</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ openssl genrsa -out server.key <span class=m>4096</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ openssl req -sha512 -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -subj <span class=s2>&#34;/C=IN/ST=Kerala/L=Kollam/O=demo/OU=Personal/CN=k8s-harbor-registry.linxlabs.com&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -key k8s-harbor-registry.linxlabs.com.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -out k8s-harbor-registry.linxlabs.com.csr</span></span></code></pre></div><p>Generate and Sign Certificates</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ openssl x509 -req -sha512 -days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -extfile v3.ext <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -CA ca.crt -CAkey ca.key -CAcreateserial <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -in k8s-harbor-registry.linxlabs.com.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -out k8s-harbor-registry.linxlabs.com.crt</span></span></code></pre></div><p>After signing , we will get output like below</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Signature ok
</span></span></span><span class=line><span class=cl><span class=go>subject=/C=IN/ST=Kerala/L=Kollam/O=demo/OU=Personal/CN=k8s-harbor-registry.linxlabs.com
</span></span></span><span class=line><span class=cl><span class=go>Getting CA Private Key
</span></span></span></code></pre></div><p>Create certificate directory for harbor</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p /data/cert/
</span></span><span class=line><span class=cl>$ sudo cp  k8s-harbor-registry.linxlabs.com.crt k8s-harbor-registry.linxlabs.com.key /data/cert/</span></span></code></pre></div><h3 id=download-harbor-offline-installer>Download Harbor offline installer.</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo curl https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz -O</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ tar -xvf harbor-offline-installer-v1.7.1.tgz</span></span></code></pre></div><p>Configure Harbor.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>cd</span> harbor
</span></span><span class=line><span class=cl>$ sed -i <span class=s1>&#39;s/hostname: reg.mydomain.com/hostname: k8s-harbor-registry.linxlabs.com/&#39;</span> harbor.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sed -i <span class=s1>&#39;s@  certificate: /your/certificate/path@  certificate: /data/cert/k8s-harbor-registry.linxlabs.com.crt@&#39;</span> harbor.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sed -i <span class=s1>&#39;s@  private_key: /your/private/key/path@  private_key: /data/cert/k8s-harbor-registry.linxlabs.com.key@&#39;</span> harbor.yml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ grep k8s-harbor harbor.yml
</span></span><span class=line><span class=cl>hostname: k8s-harbor-registry.linxlabs.com
</span></span><span class=line><span class=cl> certificate: /data/cert/k8s-harbor-registry.linxlabs.com.crt
</span></span><span class=line><span class=cl> certificate: /data/cert/k8s-harbor-registry.linxlabs.com.key</span></span></code></pre></div><p>Install Harbor & Start Harbor.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo ./install.sh --with-notary --with-clair --with-chartmuseum</span></span></code></pre></div><p>After successful installation , we will get below output.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>[</span>Step 5<span class=o>]</span>: starting Harbor ...
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;harbor_harbor&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;harbor_harbor-clair&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;harbor_harbor-notary&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;harbor_harbor-chartmuseum&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating network <span class=s2>&#34;harbor_notary-sig&#34;</span> with the default driver
</span></span><span class=line><span class=cl>Creating harbor-log ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating redis         ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating registry      ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating registryctl   ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating chartmuseum   ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating harbor-portal ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating harbor-db     ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating notary-signer ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating clair             ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating harbor-core   ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating notary-server     ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating nginx             ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating harbor-jobservice ... <span class=k>done</span>
</span></span><span class=line><span class=cl>Creating clair-adapter     ... <span class=k>done</span>
</span></span><span class=line><span class=cl>✔ ----Harbor has been installed and started successfully.----</span></span></code></pre></div><p>Also , you can use docker-compose to verify the health of containers</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo docker-compose ps
</span></span><span class=line><span class=cl>      Name                     Command                  State                                      Ports
</span></span><span class=line><span class=cl>---------------------------------------------------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>chartmuseum         ./docker-entrypoint.sh           Up <span class=o>(</span>healthy<span class=o>)</span>   9999/tcp
</span></span><span class=line><span class=cl>clair               ./docker-entrypoint.sh           Up <span class=o>(</span>healthy<span class=o>)</span>   6060/tcp, 6061/tcp
</span></span><span class=line><span class=cl>clair-adapter       /clair-adapter/clair-adapter     Up <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp
</span></span><span class=line><span class=cl>harbor-core         /harbor/harbor_core              Up <span class=o>(</span>healthy<span class=o>)</span>
</span></span><span class=line><span class=cl>harbor-db           /docker-entrypoint.sh            Up <span class=o>(</span>healthy<span class=o>)</span>   5432/tcp
</span></span><span class=line><span class=cl>harbor-jobservice   /harbor/harbor_jobservice  ...   Up <span class=o>(</span>healthy<span class=o>)</span>
</span></span><span class=line><span class=cl>harbor-log          /bin/sh -c /usr/local/bin/ ...   Up <span class=o>(</span>healthy<span class=o>)</span>   127.0.0.1:1514-&gt;10514/tcp
</span></span><span class=line><span class=cl>harbor-portal       nginx -g daemon off<span class=p>;</span>             Up <span class=o>(</span>healthy<span class=o>)</span>   8080/tcp
</span></span><span class=line><span class=cl>nginx               nginx -g daemon off<span class=p>;</span>             Up <span class=o>(</span>healthy<span class=o>)</span>   0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:80-&gt;8080/tcp, 0.0.0.0:443-&gt;8443/tcp
</span></span><span class=line><span class=cl>notary-server       /bin/sh -c migrate-patch - ...   Up
</span></span><span class=line><span class=cl>notary-signer       /bin/sh -c migrate-patch - ...   Up
</span></span><span class=line><span class=cl>redis               redis-server /etc/redis.conf     Up <span class=o>(</span>healthy<span class=o>)</span>   6379/tcp
</span></span><span class=line><span class=cl>registry            /home/harbor/entrypoint.sh       Up <span class=o>(</span>healthy<span class=o>)</span>   5000/tcp
</span></span><span class=line><span class=cl>registryctl         /home/harbor/start.sh            Up <span class=o>(</span>healthy<span class=o>)</span></span></span></code></pre></div><p>Now , you will be able to access Harbor UI using URL &ldquo;<a href=https://k8s-harbor-registry.linxlabs.com target=_blank>https://k8s-harbor-registry.linxlabs.com</a>&rdquo; (Need DNS entry/host file entry)
or use the IP of the VM &ldquo;https://10.136.102.79&rdquo;</p><p>Default username & password is <strong>admin/Harbor12345</strong></p><p><a href=#R-image-284cf147cda9b5d447f39cb5ed225719 class=lightbox-link><img src=./23-harobor/01-private-registry/harbor-page.jpg alt=Harbor class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-284cf147cda9b5d447f39cb5ed225719><img src=./23-harobor/01-private-registry/harbor-page.jpg alt=Harbor class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=configure-harbor>Configure Harbor</h1><p>In this session , we will create a new user and then we will add that user to the default public project on Harbor.</p><h3 id=create-user>Create user</h3><p><code>Administration -> Users -> + NEW USER</code>
<a href=#R-image-05b90193c0e7dea4bb1af4ef8d586ca3 class=lightbox-link><img src=./23-harobor/02-configure-harbor/01_user_create.png alt=usr class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-05b90193c0e7dea4bb1af4ef8d586ca3><img src=./23-harobor/02-configure-harbor/01_user_create.png alt=usr class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a>
Fill the user details and set password for the account.
<a href=#R-image-eda54a5ceac01ca2cddd243d4128ccf0 class=lightbox-link><img src=./23-harobor/02-configure-harbor/02_user_create_data.png alt=usr_create class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-eda54a5ceac01ca2cddd243d4128ccf0><img src=./23-harobor/02-configure-harbor/02_user_create_data.png alt=usr_create class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a>
User will be listed after creation
<a href=#R-image-7daa7ed5e583d10f3c94f32ea5f9b00a class=lightbox-link><img src=./23-harobor/02-configure-harbor/03_user_create_confirm.png alt=usr_create_confirm class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7daa7ed5e583d10f3c94f32ea5f9b00a><img src=./23-harobor/02-configure-harbor/03_user_create_confirm.png alt=usr_create_confirm class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><h3 id=add-user-to-the-library-project>Add user to the <code>library</code> project.</h3><p><code>Projects -> library</code>
<a href=#R-image-a2f990ef61dd9fa79a9e8bb924f19fb6 class=lightbox-link><img src=./23-harobor/02-configure-harbor/04_project_library.png alt=project class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-a2f990ef61dd9fa79a9e8bb924f19fb6><img src=./23-harobor/02-configure-harbor/04_project_library.png alt=project class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p><code>Members -> + USER</code>
<a href=#R-image-1169f3baef2449a8a5bba9d9a3310dfa class=lightbox-link><img src=./23-harobor/02-configure-harbor/05_project_library_members.png alt=usr_project class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-1169f3baef2449a8a5bba9d9a3310dfa><img src=./23-harobor/02-configure-harbor/05_project_library_members.png alt=usr_project class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>Add new user to the project as <code>Developer</code>
<a href=#R-image-2a00cb6d5d41e2099c4ecd89968e63e6 class=lightbox-link><img src=./23-harobor/02-configure-harbor/06_project_library_members_add.png alt=add_usr_project class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-2a00cb6d5d41e2099c4ecd89968e63e6><img src=./23-harobor/02-configure-harbor/06_project_library_members_add.png alt=add_usr_project class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>Now we can use this account to push images to this Private registry.</p><p>In next session , we will reconfigure docker to use this registry.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=re-configure-docker-to-use-harbor>Re-Configure Docker to use Harbor</h1><p>In part 1, we have generated CA certificates. Using the same CA , we will generate docker client certificates.
So , logon to the same harbor host and then go the directory where CA certificates were stored. In our case ;</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nb>cd</span> ~/harbor_certs/</span></span></code></pre></div><p>Generate a CSR for docker and get it signed for the client</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ openssl genrsa -out docker-client.linxlabs.com.key <span class=m>4096</span>
</span></span><span class=line><span class=cl>$ openssl req -sha512 -new <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -subj <span class=s2>&#34;/C=IN/ST=Kerala/L=Kollam/O=demo/OU=Personal/CN=docker-client.linxlabs.com&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -key docker-client.linxlabs.com.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -out docker-client.linxlabs.com.csr</span></span></code></pre></div><p>Sign Certificates</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ openssl x509 -req -sha512 -days <span class=m>3650</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -extfile v3.ext <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -CA ca.crt -CAkey ca.key -CAcreateserial <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -in docker-client.linxlabs.com.csr <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -out docker-client.linxlabs.com.crt</span></span></code></pre></div><p>You will get an output like below.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Signature ok
</span></span></span><span class=line><span class=cl><span class=go>subject=/C=IN/ST=Kerala/L=Kollam/O=demo/OU=Personal/CN=docker-client.linxlabs.com
</span></span></span><span class=line><span class=cl><span class=go>Getting CA Private Key
</span></span></span></code></pre></div><p>Docker needs the certificate in PEM format , so lets convert the client certificate.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ openssl x509 -inform PEM -in docker-client.linxlabs.com.crt -out docker-client.linxlabs.com.cert</span></span></code></pre></div><p>On docker client system , create directories to store certificates.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo mkdir -p /etc/docker/certs.d/k8s-harbor-registry.linxlabs.com</span></span></code></pre></div><p>Copy certificate from CA server (harbor host) to the docker client host , then follow below procedure.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo cp ca.crt docker-client.linxlabs.com.key docker-client.linxlabs.com.cert /etc/docker/certs.d/k8s-harbor-registry.linxlabs.com</span></span></code></pre></div><p>Restart docker after placing certificates.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart docker</span></span></code></pre></div><p>Now try to logon to the private registry.</p><div class="box notices cstyle warning"><div class=box-label><i class="fa-fw fas fa-exclamation-triangle"></i> Warning</div><div class=box-content><p>If there is no DNS entry for registry FQDN , then make sure the entry is added to /etc/hosts</p></div></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker login k8s-harbor-registry.linxlabs.com
</span></span><span class=line><span class=cl>Username: ansil
</span></span><span class=line><span class=cl>Password:
</span></span><span class=line><span class=cl>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
</span></span><span class=line><span class=cl>Configure a credential helper to remove this warning. See
</span></span><span class=line><span class=cl>https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Login Succeeded</span></span></code></pre></div><p>Verify docker image pull/push</p><p>Download an image from docker hub</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo docker pull alpine
</span></span><span class=line><span class=cl>Using default tag: latest
</span></span><span class=line><span class=cl>latest: Pulling from library/alpine
</span></span><span class=line><span class=cl>aad63a933944: Pull <span class=nb>complete</span>
</span></span><span class=line><span class=cl>Digest: sha256:b276d875eeed9c7d3f1cfa7edb06b22ed22b14219a7d67c52c56612330348239
</span></span><span class=line><span class=cl>Status: Downloaded newer image <span class=k>for</span> alpine:latest
</span></span><span class=line><span class=cl>docker.io/library/alpine:latest</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker images
</span></span><span class=line><span class=cl>REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE
</span></span><span class=line><span class=cl>alpine                          latest              a187dde48cd2        <span class=m>2</span> weeks ago         5.6MB</span></span></code></pre></div><p>Tag the image for pushing it to private registry</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker tag alpine:latest k8s-harbor-registry.linxlabs.com/library/ansil/alpine:latest</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ docker push k8s-harbor-registry.linxlabs.com/library/ansil/alpine:latest</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>The push refers to repository [k8s-harbor-registry.linxlabs.com/library/ansil/alpine]
</span></span></span><span class=line><span class=cl><span class=go>beee9f30bc1f: Pushed
</span></span></span><span class=line><span class=cl><span class=go>latest: digest: sha256:cb8a924afdf0229ef7515d9e5b3024e23b3eb03ddbba287f4a19c6ac90b8d221 size: 528
</span></span></span></code></pre></div><p>Logon to Harbor UI and verify the status of the new image & scan it for vulnerability</p><p><a href=#R-image-43e7408d1434b80a389cbc4a95d91993 class=lightbox-link><img src=./23-harobor/03-configure-docker/07_project_library_after_push.png alt class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-43e7408d1434b80a389cbc4a95d91993><img src=./23-harobor/03-configure-docker/07_project_library_after_push.png alt class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a>
<a href=#R-image-85954a88841d51e2e033300113f5d1af class=lightbox-link><img src=./23-harobor/03-configure-docker/08_image_scan.png alt class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-85954a88841d51e2e033300113f5d1af><img src=./23-harobor/03-configure-docker/08_image_scan.png alt class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a>
<a href=#R-image-480615156db8284afcc26d188e38e4de class=lightbox-link><img src=./23-harobor/03-configure-docker/09_image_scan_result.png alt class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-480615156db8284afcc26d188e38e4de><img src=./23-harobor/03-configure-docker/09_image_scan_result.png alt class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><footer class=footline></footer></article></section></section></div></main></div><script src=./js/clipboard.min.js?1704645834 defer></script><script src=./js/perfect-scrollbar.min.js?1704645834 defer></script><script src=./js/theme.js?1704645834 defer></script></body></html>