<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=generator content="Relearn 5.23.2+tip"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="Kubernetes pocket gude and more"><meta name=author content="Ansil H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubernetes.ansilh.com/images/hero.png"><meta name=twitter:title content="TLS Bootstrapping :: Hugo Relearn Theme"><meta name=twitter:description content="Kubernetes pocket gude and more"><meta property="og:title" content="TLS Bootstrapping :: Hugo Relearn Theme"><meta property="og:description" content="Kubernetes pocket gude and more"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.ansilh.com/18-tls_bootstrapping/index.html"><meta property="og:image" content="https://kubernetes.ansilh.com/images/hero.png"><meta property="og:site_name" content="Hugo Relearn Theme"><title>TLS Bootstrapping :: Hugo Relearn Theme</title>
<link href=../images/logo.svg?1704651914 rel=icon type=image/svg+xml><link href=../css/fontawesome-all.min.css?1704651918 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1704651918 rel=stylesheet></noscript><link href=../css/nucleus.css?1704651918 rel=stylesheet><link href=../css/auto-complete.css?1704651918 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1704651918 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1704651918 rel=stylesheet><link href=../css/fonts.css?1704651918 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1704651918 rel=stylesheet></noscript><link href=../css/theme.css?1704651918 rel=stylesheet><link href=../css/theme-neon.css?1704651918 rel=stylesheet id=R-variant-style><link href=../css/chroma-neon.css?1704651918 rel=stylesheet id=R-variant-chroma-style><link href=../css/variant.css?1704651918 rel=stylesheet><link href=../css/print.css?1704651918 rel=stylesheet media=print><link href=../css/format-print.css?1704651918 rel=stylesheet><link href=../css/ie.css?1704651918 rel=stylesheet><script src=../js/url.js?1704651918></script><script src=../js/variant.js?1704651918></script><script>window.index_js_url="../index.search.js";var root_url="../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://kubernetes.ansilh.com/",window.relearn.themeVariantModifier="",window.variants&&variants.init(["neon"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><style>#R-body img.bg-white{background-color:#fff}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../18-tls_bootstrapping/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>TLS Bootstrapping</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 18</div><h1 id=tls-bootstrapping>TLS Bootstrapping</h1><p>In this session , we will discuss about how a node can join a cluster using TLS bootstrapping.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of TLS Bootstrapping</h1><article class=default><header class=headline></header><h1 id=tls-bootstrapping-with-token-file>TLS bootstrapping with token file</h1><h3 id=workflow>Workflow</h3><p><a href=#R-image-8fc735a3d51a461ef75862762c648ac1 class=lightbox-link><img src="../18-tls_bootstrapping/01-bootstapping-with-file/tls-boot-strapping.png?classes=shadow" alt="TLS Bootstrap" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8fc735a3d51a461ef75862762c648ac1><img src="../18-tls_bootstrapping/01-bootstapping-with-file/tls-boot-strapping.png?classes=shadow" alt="TLS Bootstrap" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>Create a Token</p><div class="wrap-code highlight"><pre tabindex=0><code>$ head -c 16 /dev/urandom | od -An -t x | tr -d &#39; &#39;</code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>$ echo 12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,\&#34;system:bootstrappers\&#34; |sudo tee -a /etc/kubernetes/config/bootstrap-token.conf</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,&#34;system:bootstrappers&#34;</code></pre></div><p>Create a token auth file</p><div class="wrap-code highlight"><pre tabindex=0><code>$ cat /etc/kubernetes/config/bootstrap-token.conf</code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>12c12e7eb3a9c3f9255bb74529c6768e,kubelet-bootstrap,10001,&#34;system:bootstrappers&#34;</code></pre></div><p>Add below flags to API server</p><div class="wrap-code highlight"><pre tabindex=0><code>--enable-bootstrap-token-auth=true \
--token-auth-file=/etc/kubernetes/config/bootstrap-token.conf \</code></pre></div><p>Add RBAC for Node TLS bootstrapping and certificate auto renewal.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>create-csrs-for-bootstrapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:node-bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-csrs-for-group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-renewals-for-nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><p>Create a bootstrap-kubeconfig which can be used by kubelet</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>TOKEN</span><span class=o>=</span><span class=k>$(</span>awk -F <span class=s2>&#34;,&#34;</span> <span class=s1>&#39;{print $1}&#39;</span> /etc/kubernetes/config/bootstrap-token.conf<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=o>=</span><span class=k>$(</span>grep master /etc/hosts <span class=p>|</span>awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-cluster bootstrap --embed-certs<span class=o>=</span><span class=nb>true</span> --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_PUBLIC_ADDRESS</span><span class=si>}</span>:6443 --certificate-authority<span class=o>=</span>ca.pem</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-credentials kubelet-bootstrap --token<span class=o>=</span><span class=si>${</span><span class=nv>TOKEN</span><span class=si>}</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig set-context bootstrap --user<span class=o>=</span>kubelet-bootstrap --cluster<span class=o>=</span>bootstrap</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig use-context bootstrap</span></span></code></pre></div><p>Copy bootstrap-kubeconfig to worker node</p><h3 id=kubelet-configuration>Kubelet configuration</h3><ul><li>Turnoff swap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo swapoff /dev/dm-1 <span class=c1>##&lt;--- select appropriate swap device based on your OS config</span></span></span></code></pre></div><ul><li><p>Install and start <a href=../02-installation/04-docker-install/index.html>docker service</a></p></li><li><p>Once docker is installed , execute below steps to make docker ready for <code>kubelet</code> integration.</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /lib/systemd/system/docker.service</span></span></code></pre></div><ul><li>Disable iptables, default bridge network and masquerading on docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>ExecStart</span><span class=o>=</span><span class=sr>/usr/</span><span class=n>bin</span><span class=o>/</span><span class=n>dockerd</span> <span class=o>-</span><span class=n>H</span> <span class=ss>fd</span><span class=p>:</span><span class=sr>//</span> <span class=o>--</span><span class=n>bridge</span><span class=o>=</span><span class=n>none</span> <span class=o>--</span><span class=n>iptables</span><span class=o>=</span><span class=kp>false</span> <span class=o>--</span><span class=n>ip</span><span class=o>-</span><span class=n>masq</span><span class=o>=</span><span class=kp>false</span></span></span></code></pre></div><ul><li>Cleanup all docker specific networking from worker nodes</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo iptables -t nat -F
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> docker0 down
</span></span><span class=line><span class=cl>$ sudo ip link delete docker0</span></span></code></pre></div><ul><li>Restart docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart docker</span></span></code></pre></div><ul><li>Move bootstrap config file to <code>/var/lib/kubelet/</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir /var/lib/kubelet/
</span></span><span class=line><span class=cl>$ sudo mv bootstrap-kubeconfig /var/lib/kubelet/  </span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF |sudo tee /etc/systemd/system/kubelet.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \
</span></span></span><span class=line><span class=cl><span class=s> --bootstrap-kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --cert-dir=/var/lib/kubelet/ \
</span></span></span><span class=line><span class=cl><span class=s> --kubeconfig=/var/lib/kubelet/kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --rotate-certificates=true \
</span></span></span><span class=line><span class=cl><span class=s> --runtime-cgroups=/systemd/system.slice \
</span></span></span><span class=line><span class=cl><span class=s> --kubelet-cgroups=/systemd/system.slice
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Reload and start the kubelet service</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start kubelet</span></span></code></pre></div><p>Now execute kubectl get nodes and see if the node is listed there.</p><p>You may configure <code>kube-proxy</code> as a DaemonSet so that it will automatically start after node registration completion.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=tls-bootstrapping-with-bootstrap-token>TLS bootstrapping with bootstrap-token</h1><h3 id=introduction>Introduction</h3><p>Bootstrap tokens are a simple bearer token that is meant to be used when creating new clusters or joining new nodes to an existing cluster. It was built to support kubeadm, but can be used in other contexts for users that wish to start clusters without kubeadm. It is also built to work, via RBAC policy, with the Kubelet TLS Bootstrapping system.</p><p>You can read more about bootstrap tokens <a href=https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/ target=_blank>here</a></p><p>Bootstrap Tokens take the form of abcdef.0123456789abcdef.
More formally, they must match the regular expression [a-z0-9]{6}.[a-z0-9]{16}</p><p>In this session , we will join a worker node to the cluster using bootstrap tokens.</p><p>Kubeadm uses bootstrap token to join a node to cluster.</p><p>Implementation Flow of Kubeadm is as follows.</p><ul><li>kubeadm connects to the API server address specified over TLS. As we don&rsquo;t yet have a root certificate to trust, this is an insecure connection and the server certificate is not validated. kubeadm provides no authentication credentials at all.</li></ul><p>Implementation note: the API server doesn&rsquo;t have to expose a new and special insecure HTTP endpoint.</p><p>(D)DoS concern: Before this flow is secure to use/enable publicly (when not bootstrapping), the API Server must support rate-limiting. There are a couple of ways rate-limiting can be implemented to work for this use-case, but defining the rate-limiting flow in detail here is out of scope. One simple idea is limiting unauthenticated requests to come from clients in RFC1918 ranges.</p><ul><li>kubeadm requests a ConfigMap containing the kubeconfig file defined above.
This ConfigMap exists at a well known URL: https://<server>/api/v1/namespaces/kube-public/configmaps/cluster-info</li></ul><p>This ConfigMap is really public. Users don&rsquo;t need to authenticate to read this ConfigMap. In fact, the client MUST NOT use a bearer token here as we don&rsquo;t trust this endpoint yet.</p><ul><li><p>The API server returns the ConfigMap with the kubeconfig contents as normal
Extra data items on that ConfigMap contains JWS signatures. kubeadm finds the correct signature based on the token-id part of the token. (Described below).</p></li><li><p>kubeadm verifies the JWS and can now trust the server. Further communication is simpler as the CA certificate in the kubeconfig file can be trusted.</p></li></ul><p>You may read more about the proposal <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/cluster-lifecycle/bootstrap-discovery.md target=_blank>here</a></p><h3 id=api-server>API server</h3><p>To support bootstrap token based discovery and to join nodes to cluster ; we need to make sure below flags are in place on API server.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>--</span><span class=n>client</span><span class=o>-</span><span class=n>ca</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>enable</span><span class=o>-</span><span class=n>bootstrap</span><span class=o>-</span><span class=n>token</span><span class=o>-</span><span class=n>auth</span><span class=o>=</span><span class=kp>true</span></span></span></code></pre></div><p>If not present , then add these flags to <code>/etc/systemd/system/kube-apiserver.service</code> unit file.</p><h3 id=controller>Controller</h3><p>make sure below flags are in place on kube-controller-manager .</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=o>--</span><span class=n>controllers</span><span class=o>=*</span><span class=p>,</span><span class=n>bootstrapsigner</span><span class=p>,</span><span class=n>tokencleaner</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>experimental</span><span class=o>-</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>duration</span><span class=o>=</span><span class=mi>8760</span><span class=n>h0m0s</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>cert</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>.</span><span class=n>pem</span>
</span></span><span class=line><span class=cl><span class=o>--</span><span class=n>cluster</span><span class=o>-</span><span class=n>signing</span><span class=o>-</span><span class=n>key</span><span class=o>-</span><span class=n>file</span><span class=o>=</span><span class=sr>/var/</span><span class=n>lib</span><span class=o>/</span><span class=n>kubernetes</span><span class=o>/</span><span class=n>ca</span><span class=o>-</span><span class=n>key</span><span class=o>.</span><span class=n>pem</span></span></span></code></pre></div><p>If not present , then add these flags to <code>/etc/systemd/system/kube-controller-manager.service</code> unit file.</p><ul><li>Reload and restart API server and Controller unit files</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>  sudo systemctl restart kube-apiserver.service
</span></span><span class=line><span class=cl>  sudo systemctl restart kube-controller-manager.service
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 id=rbac-permission-to-enable-certificate-signign>RBAC Permission to enable certificate signign</h3><ul><li>To allow kubelet to create CSR</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>create-csrs-for-bootstrapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:node-bootstrapper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>CSR auto signing for bootstrapper</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-csrs-for-group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:nodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><ul><li>Certificates self renewal</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>cat &lt;&lt;EOF | kubectl create -f -</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>auto-approve-renewals-for-nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Group</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:nodes</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>EOF</span></span></span></code></pre></div><h3 id=create-bootstrap-token>Create bootstrap token</h3><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=k>$(</span>openssl rand -hex 3<span class=k>)</span>.<span class=k>$(</span>openssl rand -hex 8<span class=k>)</span></span></span></code></pre></div><blockquote><p>Output</p></blockquote><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>80a6ee.fd219151288b08d8
</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi bootstrap-token.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Name MUST be of form &#34;bootstrap-token-&lt;token id&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap-token-80a6ee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>bootstrap.kubernetes.io/token</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>stringData</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Human readable description. Optional.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;The default bootstrap token.&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Token ID and secret. Required.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token-id</span><span class=p>:</span><span class=w> </span><span class=l>80a6ee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>token-secret</span><span class=p>:</span><span class=w> </span><span class=l>fd219151288b08d8</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Expiration. Optional.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>expiration</span><span class=p>:</span><span class=w> </span><span class=ld>2019-12-05T12:00:00Z</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Allowed usages.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>usage-bootstrap-authentication</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>usage-bootstrap-signing</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Extra groups to authenticate the token as. Must start with &#34;system:bootstrappers:&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>auth-extra-groups</span><span class=p>:</span><span class=w> </span><span class=l>system:bootstrappers:worker,system:bootstrappers:ingress</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f bootstrap-token.yaml</span></span></code></pre></div><p>Create cluster-info for clients which will be downloaded if needed by client</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=nv>KUBERNETES_MASTER</span><span class=o>=</span><span class=k>$(</span>awk <span class=s1>&#39;/master/{print $1;exit}&#39;</span> /etc/hosts<span class=k>)</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-cluster bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig-public  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_MASTER</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span>true</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n kube-public create configmap cluster-info <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span><span class=nv>kubeconfig</span><span class=o>=</span>bootstrap-kubeconfig-public</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl -n kube-public get configmap cluster-info -o yaml</span></span></code></pre></div><ul><li>RBAC to allow anonymous users to access the <code>cluster-info</code> ConfigMap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create role anonymous-for-cluster-info --resource<span class=o>=</span>configmaps --resource-name<span class=o>=</span>cluster-info --namespace<span class=o>=</span>kube-public --verb<span class=o>=</span>get,list,watch
</span></span><span class=line><span class=cl>$ kubectl create rolebinding anonymous-for-cluster-info-binding --role<span class=o>=</span>anonymous-for-cluster-info --user<span class=o>=</span>system:anonymous --namespace<span class=o>=</span>kube-public</span></span></code></pre></div><p>Create bootstrap-kubeconfig for worker nodes</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-cluster bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --server<span class=o>=</span>https://<span class=si>${</span><span class=nv>KUBERNETES_MASTER</span><span class=si>}</span>:6443 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --certificate-authority<span class=o>=</span>ca.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --embed-certs<span class=o>=</span>true</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-credentials kubelet-bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --token<span class=o>=</span>80a6ee.fd219151288b08d8</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config set-context bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubeconfig<span class=o>=</span>bootstrap-kubeconfig <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --user<span class=o>=</span>kubelet-bootstrap <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cluster<span class=o>=</span>bootstrap</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl config --kubeconfig<span class=o>=</span>bootstrap-kubeconfig use-context bootstrap</span></span></code></pre></div><p>Copy the bootstrap-kubeconfig to worker node and then execute below steps from worker node.</p><h3 id=kubelet-configuration>Kubelet configuration</h3><ul><li>Turnoff swap</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo swapoff /dev/dm-1 <span class=c1>##&lt;--- select appropriate swap device based on your OS config</span></span></span></code></pre></div><ul><li><p>Install and start <a href=../02-installation/04-docker-install/index.html>docker service</a></p></li><li><p>Once docker is installed , execute below steps to make docker ready for <code>kubelet</code> integration.</p></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo vi /lib/systemd/system/docker.service</span></span></code></pre></div><ul><li>Disable iptables, default bridge network and masquerading on docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=no>ExecStart</span><span class=o>=</span><span class=sr>/usr/</span><span class=n>bin</span><span class=o>/</span><span class=n>dockerd</span> <span class=o>-</span><span class=n>H</span> <span class=ss>fd</span><span class=p>:</span><span class=sr>//</span> <span class=o>--</span><span class=n>bridge</span><span class=o>=</span><span class=n>none</span> <span class=o>--</span><span class=n>iptables</span><span class=o>=</span><span class=kp>false</span> <span class=o>--</span><span class=n>ip</span><span class=o>-</span><span class=n>masq</span><span class=o>=</span><span class=kp>false</span></span></span></code></pre></div><ul><li>Cleanup all docker specific networking from worker nodes</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo iptables -t nat -F
</span></span><span class=line><span class=cl>$ sudo ip link <span class=nb>set</span> docker0 down
</span></span><span class=line><span class=cl>$ sudo ip link delete docker0</span></span></code></pre></div><ul><li>Restart docker</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl restart docker</span></span></code></pre></div><ul><li>Move bootstrap config file to <code>/var/lib/kubelet/</code></li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ mkdir /var/lib/kubelet/
</span></span><span class=line><span class=cl>$ sudo mv bootstrap-kubeconfig /var/lib/kubelet/  </span></span></code></pre></div><ul><li>Create a systemd untit file and add necessary flags.</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF |sudo tee /etc/systemd/system/kubelet.service
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Kubernetes Kubelet
</span></span></span><span class=line><span class=cl><span class=s>Documentation=https://github.com/kubernetes/kubernetes
</span></span></span><span class=line><span class=cl><span class=s>After=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>Requires=containerd.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/kubelet \
</span></span></span><span class=line><span class=cl><span class=s> --bootstrap-kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --cert-dir=/var/lib/kubelet/ \
</span></span></span><span class=line><span class=cl><span class=s> --kubeconfig=/var/lib/kubelet/kubeconfig \
</span></span></span><span class=line><span class=cl><span class=s> --rotate-certificates=true \
</span></span></span><span class=line><span class=cl><span class=s> --runtime-cgroups=/systemd/system.slice \
</span></span></span><span class=line><span class=cl><span class=s> --kubelet-cgroups=/systemd/system.slice
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=5
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div><ul><li>Reload and start the kubelet service</li></ul><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo systemctl daemon-reload
</span></span><span class=line><span class=cl>$ sudo systemctl start kubelet</span></span></code></pre></div><p>Now execute kubectl get nodes and see if the node is listed there.</p><p>You may configure <code>kube-proxy</code> as a DaemonSet so that it will automatically start after node registration completion.</p><footer class=footline></footer></article></section><script src=https://giscus.app/client.js data-repo=ansilh/kubernetes.github.io data-repo-id=R_kgDOLB2cOA data-category=Announcements data-category-id=DIC_kwDOLB2cOM4CcQpH data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></div></main></div><script src=../js/clipboard.min.js?1704651918 defer></script><script src=../js/perfect-scrollbar.min.js?1704651918 defer></script><script src=../js/theme.js?1704651918 defer></script></body></html>