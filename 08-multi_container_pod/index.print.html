<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=generator content="Relearn 5.23.2+tip"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="Kubernetes pocket gude and more"><meta name=author content="Ansil H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubernetes.ansilh.com/images/hero.png"><meta name=twitter:title content="Multi-Container Pods :: Hugo Relearn Theme"><meta name=twitter:description content="Kubernetes pocket gude and more"><meta property="og:title" content="Multi-Container Pods :: Hugo Relearn Theme"><meta property="og:description" content="Kubernetes pocket gude and more"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.ansilh.com/08-multi_container_pod/index.html"><meta property="og:image" content="https://kubernetes.ansilh.com/images/hero.png"><meta property="og:site_name" content="Hugo Relearn Theme"><title>Multi-Container Pods :: Hugo Relearn Theme</title>
<link href=../images/logo.svg?1704650113 rel=icon type=image/svg+xml><link href=../css/fontawesome-all.min.css?1704650116 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1704650116 rel=stylesheet></noscript><link href=../css/nucleus.css?1704650116 rel=stylesheet><link href=../css/auto-complete.css?1704650116 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1704650116 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1704650116 rel=stylesheet><link href=../css/fonts.css?1704650116 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1704650116 rel=stylesheet></noscript><link href=../css/theme.css?1704650116 rel=stylesheet><link href=../css/theme-neon.css?1704650116 rel=stylesheet id=R-variant-style><link href=../css/chroma-neon.css?1704650116 rel=stylesheet id=R-variant-chroma-style><link href=../css/variant.css?1704650116 rel=stylesheet><link href=../css/print.css?1704650116 rel=stylesheet media=print><link href=../css/format-print.css?1704650116 rel=stylesheet><link href=../css/ie.css?1704650116 rel=stylesheet><script src=../js/url.js?1704650116></script><script src=../js/variant.js?1704650116></script><script>window.index_js_url="../index.search.js";var root_url="../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://kubernetes.ansilh.com/",window.relearn.themeVariantModifier="",window.variants&&variants.init(["neon"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><style>#R-body img.bg-white{background-color:#fff}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../08-multi_container_pod/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Multi-Container Pods</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 8</div><h1 id=multi-container-pods>Multi-Container Pods</h1><p>In this session we will create Pods with more than one containers and few additional features in k8s.</p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Multi-Container Pods</h1><article class=default><header class=headline></header><h1 id=initcontainer>InitContainer</h1><p><a href=#R-image-af45681d85054da1fa0223afdea340ea class=lightbox-link><img src="../08-multi_container_pod/03-init-container/initcontainer.png?classes=shadow&amp;width=30pc" alt=InitContainer class="figure-image bg-white border lightbox shadow" style=height:auto;width:30pc loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-af45681d85054da1fa0223afdea340ea><img src="../08-multi_container_pod/03-init-container/initcontainer.png?classes=shadow&amp;width=30pc" alt=InitContainer class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
In this session , we will discuss about InitContainer</p><h3 id=non-persistent-web-server>Non-persistent web server</h3><p>As we already know ,containers are ephemeral and the modifications will be lost when container is destroyed.</p><p>In this example , we will download webpages from Github repository and store it in a <code>emptyDir</code> volume.</p><p>From this emptyDir volume , we will serve the HTML pages using an Nginx Pod</p><p><code>emptyDir</code> is a volume type , just like hostPath , but the contents of <code>emptyDir</code> will be destroyed when Pod is stopped.</p><p>So lets write a Pod specification for Nginx container and add InitContainer to download HTML page</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-pull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>clone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>https://github.com/ansilh/k8s-demo-web.git</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/html/.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/html/</span></span></span></code></pre></div><p>Problem with this design is , no way to pull the changes once Pod is up.
InitContainer run only once during the startup of the Pod.</p><p>Incase of InitContainer failure , Pod startup will fail and never start other containers.</p><p>We can specify more than one initcontainer if needed.
Startup of initcontainer will be sequential and the order will be selected based on the order in yaml spec.</p><p>In next session , we will discuss about other design patterns for Pod.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=inject-data-to-pod>Inject data to Pod</h1><h3 id=inject-data-to-pod-via-environmental-variable>Inject data to pod via Environmental variable</h3><p>We will create a Coffee Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run tea --image<span class=o>=</span>ansilh/demo-tea --env<span class=o>=</span><span class=nv>MY_NODE_NAME</span><span class=o>=</span>scratch --restart<span class=o>=</span>Never --dry-run -o yaml &gt;pod-with-env.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>scratch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Lets run this Pod</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-with-env.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pods
</span></span><span class=line><span class=cl>NAME         READY   STATUS              RESTARTS   AGE
</span></span><span class=line><span class=cl>tea          1/1     Running   <span class=m>0</span>          7s</span></span></code></pre></div><p>Lets expose the pod as <code>NodePort</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl expose pod tea --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>8080</span> --type<span class=o>=</span>NodePort</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get svc tea
</span></span><span class=line><span class=cl>NAME   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>        AGE
</span></span><span class=line><span class=cl>tea    NodePort   192.168.10.37   &lt;none&gt;        80:32258/TCP   42s</span></span></code></pre></div><p>Access the service using browser uisng node IP and port <code>32258</code></p><p>You will see below in Page
<code>Node:scratch</code></p><h3 id=expose-pod-fields-to-containers>Expose Pod fields to containers</h3><p>Lets extract the <code>nodeName</code> from spec ( Excuse me ? yeah we will see that in a moment )</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.nodeName}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>k8s-worker-01
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.hostIP}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>192.168.56.202
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$ kubectl get pods tea -o<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.podIP}&#39;</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span>
</span></span><span class=line><span class=cl>10.10.1.23
</span></span><span class=line><span class=cl>k8s@k8s-master-01:~$</span></span></code></pre></div><p>To get the JSON path , first we need to get the entire object output in JSON.
We have used output in <code>YAML</code> so far because its easy . But internally <code>kubectl</code> convers <code>YAML</code> to <code>JSON</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get pod tea -o json</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;apiVersion&#34;: </span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;kind&#34;: </span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;metadata&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;annotations&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;cni.projectcalico.org/podIP&#34;: </span><span class=s2>&#34;10.10.1.23/32&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;creationTimestamp&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;labels&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>&#34;run&#34;: </span><span class=s2>&#34;tea&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;namespace&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;resourceVersion&#34;: </span><span class=s2>&#34;218696&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;selfLink&#34;: </span><span class=s2>&#34;/api/v1/namespaces/default/pods/tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;uid&#34;: </span><span class=s2>&#34;14c1715b-11c5-11e9-9f0f-0800276a1bd2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;spec&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;containers&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;env&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;MY_NODE_NAME&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;value&#34;: </span><span class=s2>&#34;scratch&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;image&#34;: </span><span class=s2>&#34;ansilh/demo-tea&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;imagePullPolicy&#34;: </span><span class=s2>&#34;Always&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;coffee-new&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;resources&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;terminationMessagePath&#34;: </span><span class=s2>&#34;/dev/termination-log&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;terminationMessagePolicy&#34;: </span><span class=s2>&#34;File&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;volumeMounts&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;mountPath&#34;: </span><span class=s2>&#34;/var/run/secrets/kubernetes.io/serviceaccount&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;readOnly&#34;: </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;dnsPolicy&#34;: </span><span class=s2>&#34;ClusterFirst&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;enableServiceLinks&#34;: </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;nodeName&#34;: </span><span class=s2>&#34;k8s-worker-01&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;priority&#34;: </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;restartPolicy&#34;: </span><span class=s2>&#34;Never&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;schedulerName&#34;: </span><span class=s2>&#34;default-scheduler&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;securityContext&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;serviceAccount&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;serviceAccountName&#34;: </span><span class=s2>&#34;default&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;terminationGracePeriodSeconds&#34;: </span><span class=m>30</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;tolerations&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;effect&#34;: </span><span class=s2>&#34;NoExecute&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;node.kubernetes.io/not-ready&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;operator&#34;: </span><span class=s2>&#34;Exists&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;tolerationSeconds&#34;: </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;effect&#34;: </span><span class=s2>&#34;NoExecute&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;key&#34;: </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;operator&#34;: </span><span class=s2>&#34;Exists&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;tolerationSeconds&#34;: </span><span class=m>300</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;volumes&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;secret&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;defaultMode&#34;: </span><span class=m>420</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;secretName&#34;: </span><span class=s2>&#34;default-token-72pzg&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>&#34;status&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;conditions&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;Initialized&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;Ready&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;ContainersReady&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastProbeTime&#34;: </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastTransitionTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;status&#34;: </span><span class=s2>&#34;True&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;type&#34;: </span><span class=s2>&#34;PodScheduled&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;containerStatuses&#34;: </span><span class=p>[</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;containerID&#34;: </span><span class=s2>&#34;docker://291a72e7fdab6a9f7afc47c640126cf596f5e071903b6a9055b44ef5bcb1c104&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;image&#34;: </span><span class=s2>&#34;ansilh/demo-tea:latest&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;imageID&#34;: </span><span class=s2>&#34;docker-pullable://ansilh/demo-tea@sha256:998d07a15151235132dae9781f587ea4d2822c62165778570145b0f659dda7bb&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;lastState&#34;: </span>{}<span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;name&#34;: </span><span class=s2>&#34;coffee-new&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;ready&#34;: </span><span class=kc>true</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;restartCount&#34;: </span><span class=m>0</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>&#34;state&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nt>&#34;running&#34;: </span>{<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=nt>&#34;startedAt&#34;: </span><span class=s2>&#34;2019-01-06T15:09:42Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>],</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;hostIP&#34;: </span><span class=s2>&#34;192.168.56.202&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;phase&#34;: </span><span class=s2>&#34;Running&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;podIP&#34;: </span><span class=s2>&#34;10.10.1.23&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;qosClass&#34;: </span><span class=s2>&#34;BestEffort&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>&#34;startTime&#34;: </span><span class=s2>&#34;2019-01-06T15:09:36Z&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>}</span></span></code></pre></div><p>Remove below from <code>pod-with-env.yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>scratch</span></span></span></code></pre></div><p>Add below Pod spec</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>spec.nodeName</span></span></span></code></pre></div><p>Resulting Pod Yaml</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MY_NODE_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>spec.nodeName</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-tea</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee-new</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>dnsPolicy</span><span class=p>:</span><span class=w> </span><span class=l>ClusterFirst</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Delete the running pod files</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete pod tea</span></span></code></pre></div><p>Create the pod with modified yaml file</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl create -f pod-with-env.yaml</span></span></code></pre></div><p>Make sure <code>endpoint</code> is up in <code>service</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get ep tea
</span></span><span class=line><span class=cl>NAME   ENDPOINTS         AGE
</span></span><span class=line><span class=cl>tea    10.10.1.26:8080   31m</span></span></code></pre></div><p>Refresh the browser page. This time you will see <code>Node:k8s-worker-01</code></p><p>Lets do a cleanup on <code>default</code> namespace.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl delete --all pods
</span></span><span class=line><span class=cl>$ kubectl delete --all services</span></span></code></pre></div><p>Now you know</p><ul><li>How to use export Objects in Yaml and Json format</li><li>How to access each fields using <code>jsonpath</code></li><li>How to inject environmental variables to <code>Pod</code></li><li>How to inject system generated fields to <code>Pod</code> using environmental variables</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=introduction-to-volumes>Introduction to Volumes</h1><h3 id=persistent-volumes>Persistent volumes</h3><p>When a Pod dies , all container&rsquo;s contents will be destroyed and never preserved by default.
Sometimes you need to store the contents persistently (for eg:- etcd pod)</p><p>Kubernetes have a <code>Volumes</code> filed in Pod spec , which can be used to mount a volume inside container.</p><p><a href=#R-image-7a88f7db5fc82dc3170fef1281bb9c93 class=lightbox-link><img src="../08-multi_container_pod/02-volumes/volumes.png?classes=shadow" alt=volumes class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-7a88f7db5fc82dc3170fef1281bb9c93><img src="../08-multi_container_pod/02-volumes/volumes.png?classes=shadow" alt=volumes class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>Lets explain the volume specs</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl explain pod.spec.volumes</span></span></code></pre></div><p>So when you write Yaml , you have to put <code>volumes</code> object in <code>spec</code>. As we have seen , <code>volumes</code> type is <code>&lt;[]Object></code> ; means its an array</p><p>So the contents below volumes should start with a dash &ldquo;-&rdquo;.
Name is a mandatory field , so lets write those.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span></span></span></code></pre></div><p>We will use <code>hostPath</code> for now</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl explain pod.spec.volumes.hostPath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>KIND</span><span class=p>:</span><span class=w>     </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>VERSION</span><span class=p>:</span><span class=w>  </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCE</span><span class=p>:</span><span class=w> </span><span class=l>hostPath &lt;Object&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>DESCRIPTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>HostPath represents a pre-existing file or directory on the host machine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>that is directly exposed to the container. This is generally used for</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>system agents or other privileged things that are allowed to see the host</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>machine. Most containers will NOT need this. More info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Represents a host path mapped into a pod. Host path volumes do not support</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>ownership management or SELinux relabeling.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FIELDS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>path &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path of the directory on the host. If the path is a symlink, it will follow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>the link to the real path. More info</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>type &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Type for HostPath Volume Defaults to &#34;&#34; More info:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>https://kubernetes.io/docs/concepts/storage/volumes#hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>k8s@k8s-master-01:~$</span></span></span></code></pre></div><p>Host path needs a path on the host , so lets add that as well to the <code>spec</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span></span></span></code></pre></div><p>This will add a volume to <code>Pod</code></p><p>Now we have to tell the pods to use it.</p><p>In <code>containers</code> specification, we have <code>volumeMounts</code> field which can be used to <code>mount</code> the <code>volume</code>.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl explain pod.spec.containers.volumeMounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>KIND</span><span class=p>:</span><span class=w>     </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>VERSION</span><span class=p>:</span><span class=w>  </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>RESOURCE</span><span class=p>:</span><span class=w> </span><span class=l>volumeMounts &lt;[]Object&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>DESCRIPTION</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Pod volumes to mount into the container&#39;s filesystem. Cannot be updated.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>VolumeMount describes a mounting of a Volume within a container.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>FIELDS</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>mountPath    &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path within the container at which the volume should be mounted. Must not</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>contain &#39;:&#39;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>mountPropagation     &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>mountPropagation determines how mounts are propagated from the host to</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>container and the other way around. When not set, MountPropagationNone is</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>used. This field is beta in 1.10.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>name &lt;string&gt; -required-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>This must match the Name of a Volume.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>readOnly     &lt;boolean&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Mounted read-only if true, read-write otherwise (false or unspecified).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Defaults to false.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=l>subPath      &lt;string&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Path within the volume from which the container&#39;s volume should be mounted.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=l>Defaults to &#34;&#34; (volume&#39;s root).</span></span></span></code></pre></div><p><code>volumeMounts</code> is <code>&lt;[]Object></code> . <code>mountPath</code> is required and <code>name</code></p><p><code>name</code> must match the Name of a <code>Volume</code></p><p>Resulting <code>Pod</code> <code>spec</code> will become ;</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/usr/share/nginx/html&#34;</span></span></span></code></pre></div><p>Lets add the basic fields to complete the Yaml and save the file as <code>nginx.yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/var/data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;data&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/usr/share/nginx/html&#34;</span></span></span></code></pre></div><p>Create the <code>Pod</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl create -f nginx.yaml</span></span></code></pre></div><p>Check where its running.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods -o wide
NAME          READY   STATUS    RESTARTS   AGE   IP           NODE            NOMINATED NODE   READINESS GATES
nginx-pod01   1/1     Running   0          55s   10.10.1.27   k8s-worker-01   &lt;none&gt;           &lt;none&gt;</code></pre></div><p>Lets expose this Pod first.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl expose pod nginx-pod01 --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=na>error</span><span class=o>:</span> <span class=s>couldn&#39;t retrieve selectors via --selector flag or introspection: the pod has no labels and cannot be exposed</span>
</span></span><span class=line><span class=cl><span class=na>See</span> <span class=s>&#39;kubectl expose -h&#39; for help and examples.</span></span></span></code></pre></div><p>This indicates that we didn&rsquo;t add <code>label</code> , because the <code>service</code> needs a label to map the Pod to <code>endpoint</code></p><p>Lets add a label to the Pod.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl label pod nginx-pod01 run=nginx-pod01</code></pre></div><p>Now we can we can expose the Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl expose pod nginx-pod01 --port=80 --target-port=80 --type=NodePort</code></pre></div><p>Get the node port which service is listening to</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get svc nginx-pod01
NAME          TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
nginx-pod01   NodePort   192.168.10.51   &lt;none&gt;        80:31538/TCP   26s</code></pre></div><p>You will get <code>403 Forbidden</code> page , because there is no html page to load.</p><p>Now we can go to the node where the Pod is running and check the path <code>/var/data</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:~$ ls -ld /var/data
</span></span></span><span class=line><span class=cl><span class=go>drwxr-xr-x 2 root root 4096 Jan  7 00:52 /var/data
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:~$ cd /var/data
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$ ls -lrt
</span></span></span><span class=line><span class=cl><span class=go>total 0
</span></span></span><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$
</span></span></span></code></pre></div><p>Nothing is there.The directory is owned by root , so you have to create the file <code>index.html</code> with root.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>k8s@k8s-worker-01:/var/data$ sudo -i
</span></span></span><span class=line><span class=cl><span class=go>[sudo] password for k8s:
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:~# cd /var/data
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data#
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data# echo &#34;This is a test page&#34; &gt;index.html
</span></span></span><span class=line><span class=cl><span class=go>root@k8s-worker-01:/var/data#
</span></span></span></code></pre></div><p>Reload the web page and you should see &ldquo;This is a test page&rdquo;</p><p>Now you know;</p><ul><li>How to create a volume.</li><li>How to mount a volume.</li><li>How to access the contents of volume from host.</li></ul><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pod---manual-scheduling>Pod - manual scheduling</h1><h3 id=node-selector>Node Selector</h3><p>Suppose you have a Pod which needs to be running on a Pod which is having SSD in it.</p><p>First we need to add a label to the node which is having SSD</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl label node k8s-worker-01 <span class=nv>disktype</span><span class=o>=</span>ssd</span></span></code></pre></div><p>Now we can write a Pod spec with <code>nodeSelector</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>test</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd</span></span></span></code></pre></div><p>Scheduler will look at the node selector and select apropriate node to run the pod</p><h3 id=nodename>nodeName</h3><ul><li>Kube-scheduler will find a suitable pod by evaluating the constraints.</li><li>Scheduler will modify the value of .spec.nodeName of Pod object .</li><li>kubelet will observe the change via API server and will start the pod based on the specification.</li></ul><p>This means , we can manually specify the <code>nodeName</code> in <code>Pod</code> spec and schedule it.</p><p>You can read more about <code>nodeName</code> in below URL
<a href=https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodename target=_blank>https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodename</a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=pod-design-patterns>Pod design patterns</h1><p>When the containers have the exact same lifecycle, or when the containers must run on the same node. The most common scenario is that you have a helper process that needs to be located and managed on the same node as the primary container.</p><p>Another reason to combine containers into a single pod is for simpler communication between containers in the pod. These containers can communicate through shared volumes (writing to a shared file or directory) and through inter-process communication (semaphores or shared memory).</p><p>There are three common design patterns and use-cases for combining multiple containers into a single pod. We’ll walk through the <code>sidecar</code> pattern, the <code>adapter</code> pattern, and the <code>ambassador</code> pattern.</p><h3 id=example-1-sidecar-containers>Example #1: Sidecar containers</h3><p>Sidecar containers extend and enhance the “main” container, they take existing containers and make them better. As an example, consider a container that runs the Nginx web server. Add a different container that syncs the file system with a git repository, share the file system between the containers and you have built Git push-to-deploy.</p><p><a href=#R-image-e78d1aa7edae14dbaa3653d78d01ba66 class=lightbox-link><img src="../08-multi_container_pod/04-pod-patterns/sidecar.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-e78d1aa7edae14dbaa3653d78d01ba66><img src="../08-multi_container_pod/04-pod-patterns/sidecar.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>demo-web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/debug-tools</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>git-pull</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=s1>&#39;while true ; do [ ! -d /html/.git ] &amp;&amp; git  clone https://github.com/ansilh/k8s-demo-web.git /html/ || { cd /html; git pull; } ; date; sleep 5 ; done&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>html</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/html/</span></span></span></code></pre></div><p>Lets do a tail on the <code>logs</code> and see how the <code>git-pull</code> works</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl logs demo-web git-pull -f
</span></span><span class=line><span class=cl>Cloning into <span class=s1>&#39;/html&#39;</span>...
</span></span><span class=line><span class=cl>Fri Jan <span class=m>11</span> 20:39:25 UTC <span class=m>2019</span>
</span></span><span class=line><span class=cl>Already up to date.
</span></span><span class=line><span class=cl>Fri Jan <span class=m>11</span> 20:39:31 UTC <span class=m>2019</span></span></span></code></pre></div><p>Lets modify the WebPage and push the changes to Github</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=go>Already up to date.
</span></span></span><span class=line><span class=cl><span class=go>Fri Jan 11 20:44:04 UTC 2019
</span></span></span><span class=line><span class=cl><span class=go>From https://github.com/ansilh/k8s-demo-web
</span></span></span><span class=line><span class=cl><span class=go>   e2df24f..1791ee1  master     -&gt; origin/master
</span></span></span><span class=line><span class=cl><span class=go>Updating e2df24f..1791ee1
</span></span></span><span class=line><span class=cl><span class=go>Fast-forward
</span></span></span><span class=line><span class=cl><span class=go> images/pic-k8s.jpg | Bin 0 -&gt; 14645 bytes
</span></span></span><span class=line><span class=cl><span class=go> index.html         |   4 ++--
</span></span></span><span class=line><span class=cl><span class=go> 2 files changed, 2 insertions(+), 2 deletions(-)
</span></span></span><span class=line><span class=cl><span class=go> create mode 100644 images/pic-k8s.jpg
</span></span></span><span class=line><span class=cl><span class=go>Fri Jan 11 20:44:10 UTC 2019
</span></span></span><span class=line><span class=cl><span class=go>Already up to date.
</span></span></span></code></pre></div><h3 id=example-2-ambassador-containers>Example #2: Ambassador containers</h3><p>Ambassador containers proxy a local connection to the world. As an example, consider a Redis cluster with read-replicas and a single write master. You can create a Pod that groups your main application with a Redis ambassador container. The ambassador is a proxy is responsible for splitting reads and writes and sending them on to the appropriate servers. Because these two containers share a network namespace, they share an IP address and your application can open a connection on “localhost” and find the proxy without any service discovery. As far as your main application is concerned, it is simply connecting to a Redis server on localhost. This is powerful, not just because of separation of concerns and the fact that different teams can easily own the components, but also because in the development environment, you can simply skip the proxy and connect directly to a Redis server that is running on localhost.</p><p><a href=#R-image-cdf572a6237b04ea527aa434695b1a72 class=lightbox-link><img src="../08-multi_container_pod/04-pod-patterns/ambassador.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-cdf572a6237b04ea527aa434695b1a72><img src="../08-multi_container_pod/04-pod-patterns/ambassador.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><h3 id=example-3-adapter-containers>Example #3: Adapter containers</h3><p>Adapter containers standardize and normalize output. Consider the task of monitoring N different applications. Each application may be built with a different way of exporting monitoring data. (e.g. JMX, StatsD, application specific statistics) but every monitoring system expects a consistent and uniform data model for the monitoring data it collects. By using the adapter pattern of composite containers, you can transform the heterogeneous monitoring data from different systems into a single unified representation by creating Pods that groups the application containers with adapters that know how to do the transformation. Again because these Pods share namespaces and file systems, the coordination of these two containers is simple and straightforward.</p><p><a href=#R-image-8238447f83d17d212723dfaeea7cf595 class=lightbox-link><img src="../08-multi_container_pod/04-pod-patterns/adapter.png?classes=shadow" alt="Pod Design" class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-8238447f83d17d212723dfaeea7cf595><img src="../08-multi_container_pod/04-pod-patterns/adapter.png?classes=shadow" alt="Pod Design" class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=taints-and-tolerations>Taints and Tolerations</h1><p>You add a taint to a node using kubectl taint. For example,</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl taint nodes k8s-worker-02 <span class=nv>key</span><span class=o>=</span>value:NoSchedule</span></span></code></pre></div><p>places a taint on node node1. The taint has key key, value value, and taint effect <code>NoSchedule</code>. This means that no pod will be able to schedule onto node1 unless it has a matching toleration.</p><p>To remove the taint added by the command above, you can run:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl taint nodes k8s-worker-02 key:NoSchedule-</span></span></code></pre></div><p>You specify a toleration for a pod in the <code>PodSpec</code>. Both of the following tolerations “match” the taint created by the <code>kubectl</code> taint line above, and thus a pod with either toleration would be able to schedule onto node1:</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0><code>tolerations:
- key: &#34;key&#34;
  operator: &#34;Exists&#34;
  effect: &#34;NoSchedule&#34;</code></pre></div><p>A toleration “matches” a taint if the keys are the same and the effects are the same, and:</p><ul><li>the operator is Exists (in which case no value should be specified), or</li><li>the operator is Equal and the values are equal
Operator defaults to Equal if not specified.</li></ul><p>The above example used effect of <code>NoSchedule</code>. Alternatively, you can use effect of <code>PreferNoSchedule</code>. This is a “preference” or “soft” version of <code>NoSchedule</code> – the system will try to avoid placing a pod that does not tolerate the taint on the node, but it is not required. The third kind of effect is NoExecute</p><p>Normally, if a taint with effect <code>NoExecute</code> is added to a node, then any pods that do not tolerate the taint will be evicted immediately, and any pods that do tolerate the taint will never be evicted. However, a toleration with <code>NoExecute</code> effect can specify an optional <code>tolerationSeconds</code> field that dictates how long the pod will stay bound to the node after the taint is added. For example,</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;key1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;value1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3600</span></span></span></code></pre></div><footer class=footline></footer></article></section></div></main></div><script src=../js/clipboard.min.js?1704650116 defer></script><script src=../js/perfect-scrollbar.min.js?1704650116 defer></script><script src=../js/theme.js?1704650116 defer></script></body></html>