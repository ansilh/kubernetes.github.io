<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.121.1"><meta name=generator content="Relearn 5.23.2+tip"><meta name=robots content="noindex, nofollow, noarchive, noimageindex"><meta name=description content="Kubernetes pocket gude and more"><meta name=author content="Ansil H"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kubernetes.ansilh.com/images/hero.png"><meta name=twitter:title content="Services :: Hugo Relearn Theme"><meta name=twitter:description content="Kubernetes pocket gude and more"><meta property="og:title" content="Services :: Hugo Relearn Theme"><meta property="og:description" content="Kubernetes pocket gude and more"><meta property="og:type" content="website"><meta property="og:url" content="https://kubernetes.ansilh.com/07-services/index.html"><meta property="og:image" content="https://kubernetes.ansilh.com/images/hero.png"><meta property="og:site_name" content="Hugo Relearn Theme"><title>Services :: Hugo Relearn Theme</title>
<link href=../images/logo.svg?1704652835 rel=icon type=image/svg+xml><link href=../css/fontawesome-all.min.css?1704652840 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fontawesome-all.min.css?1704652840 rel=stylesheet></noscript><link href=../css/nucleus.css?1704652840 rel=stylesheet><link href=../css/auto-complete.css?1704652840 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/auto-complete.css?1704652840 rel=stylesheet></noscript><link href=../css/perfect-scrollbar.min.css?1704652840 rel=stylesheet><link href=../css/fonts.css?1704652840 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=../css/fonts.css?1704652840 rel=stylesheet></noscript><link href=../css/theme.css?1704652840 rel=stylesheet><link href=../css/theme-neon.css?1704652840 rel=stylesheet id=R-variant-style><link href=../css/chroma-neon.css?1704652840 rel=stylesheet id=R-variant-chroma-style><link href=../css/variant.css?1704652840 rel=stylesheet><link href=../css/print.css?1704652840 rel=stylesheet media=print><link href=../css/format-print.css?1704652840 rel=stylesheet><link href=../css/ie.css?1704652840 rel=stylesheet><script src=../js/url.js?1704652840></script><script src=../js/variant.js?1704652840></script><script>window.index_js_url="../index.search.js";var root_url="../",baseUri=root_url.replace(/\/$/,"");window.relearn=window.relearn||{},window.relearn.baseUriFull="https://kubernetes.ansilh.com/",window.relearn.themeVariantModifier="",window.variants&&variants.init(["neon"]),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><style>#R-body img.bg-white{background-color:#fff}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=../07-services/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>Services</span><meta itemprop=position content="1"></li></ol><div class="topbar-area topbar-area-end" data-area=end></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable chapter narrow" tabindex=-1><div class=flex-block-wrapper><article class=chapter><header class=headline></header><div class=article-subheading>Chapter 7</div><h1 id=services>Services</h1><p>In this session we will solve the maze
<a href=#R-image-b8209b4a3ff10f1c0630707166ee4e68 class=lightbox-link><img src="../07-services/services.png?classes=shadow" alt=maze class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b8209b4a3ff10f1c0630707166ee4e68><img src="../07-services/services.png?classes=shadow" alt=maze class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><footer class=footline></footer></article><section><h1 class=a11y-only>Subsections of Services</h1><article class=default><header class=headline></header><h1 id=expose-services-in-pod>Expose services in Pod</h1><h3 id=service>Service</h3><p>A Coffee Pod running in cluster and its listening on port 9090 on Pod&rsquo;s IP.
How can we expose that service to external world so that users can access it ?</p><p><a href=#R-image-244f2712f13ab35e4bd181903054534c class=lightbox-link><img src="../07-services/01-expose-pod/pod-service.png?classess=shadow" alt=Pod class="figure-image bg-white border lightbox noshadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-244f2712f13ab35e4bd181903054534c><img src="../07-services/01-expose-pod/pod-service.png?classess=shadow" alt=Pod class="lightbox-image bg-white border lightbox noshadow" loading=lazy></a></p><p>We need to <code>expose</code> the service.</p><p>As we know , the Pod IP is not routable outside of the cluster.
So we need a mechanism to reach the host&rsquo;s port and then that traffic should be diverted to Pod&rsquo;s port.</p><p>Lets create a Pod Yaml first.</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ vi coffe.yaml</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>ansilh/demo-coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span></span></span></code></pre></div><p>Create Yaml</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl create -f coffe.yaml</code></pre></div><p>Expose the Pod with below command</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl expose pod coffee --port=80 --target-port=9090  --type=NodePort</code></pre></div><p>This will create a <code>Service</code> object in kubernetes , which will map the Node&rsquo;s port 30836 to <code>Service</code> IP/Port 192.168.10.86:80</p><p>We can see the derails using <code>kubectl get service</code> command</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get service
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
coffee       NodePort    192.168.10.86    &lt;none&gt;        80:30391/TCP   6s
kubernetes   ClusterIP   192.168.10.1     &lt;none&gt;        443/TCP        26h</code></pre></div><p>We can also see that the port is listening and kube-proxy is the one listening on that port.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ sudo netstat -tnlup |grep 30836
tcp6       0      0 :::30391                :::*                    LISTEN      2785/kube-proxy</code></pre></div><p>Now you can open browser and access the <code>Coffee</code> app using URL <code>http://192.168.56.201:30391</code></p><h2 id=ports-in-service-objects>Ports in Service Objects</h2><h3 id=nodeport>nodePort</h3><p>This setting makes the service visible outside the Kubernetes cluster by the node’s IP address and the port number declared in this property. The service also has to be of type NodePort (if this field isn’t specified, Kubernetes will allocate a node port automatically).</p><h3 id=port>port</h3><p>Expose the service on the specified port internally within the cluster. That is, the service becomes visible on this port, and will send requests made to this port to the pods selected by the service.</p><h3 id=targetport>targetPort</h3><p>This is the port on the pod that the request gets sent to. Your application needs to be listening for network requests on this port for the service to work.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=nodeport>NodePort</h1><p>NodePort Exposes the service on each Node’s IP at a static port (the NodePort). A ClusterIP service, to which the NodePort service will route, is automatically created. You’ll be able to contact the NodePort service, from outside the cluster, by requesting <nodeip>:<nodeport>.</p><h4 id=how-nodeport-works>How <code>nodePort</code> works</h4><p><a href=#R-image-0aea1cc7224af9f87076cfa9cbe97d08 class=lightbox-link><img src="../07-services/02-nodeport/pod-service-nodeport.png?classes=shadow" alt=NodePort class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0aea1cc7224af9f87076cfa9cbe97d08><img src="../07-services/02-nodeport/pod-service-nodeport.png?classes=shadow" alt=NodePort class="lightbox-image bg-white border lightbox shadow" loading=lazy></a></p><p>kube-proxy watches the Kubernetes master for the addition and removal of Service and Endpoints objects.</p><p>(We will discuss about <code>Endpoints</code> later in this session.)</p><p>For each <code>Service</code>, it opens a port (randomly chosen) on the local node. Any connections to this “proxy port” will be proxied to one of the Service’s backend Pods (as reported in Endpoints). Lastly, it installs iptables rules which capture traffic to the Service’s <code>clusterIP</code> (which is virtual) and Port and redirects that traffic to the proxy port which proxies the backend Pod.</p><h4 id=nodeport-workflow><code>nodePort</code> workflow.</h4><ol><li><p><code>nodePort</code> -> <code>30391</code></p></li><li><p><code>port</code> -> <code>80</code></p></li><li><p><code>targetPort</code> -> <code>9090</code></p></li></ol><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=clusterip>ClusterIP</h1><p>It exposes the service on a cluster-internal IP.</p><p>When we expose a pod using <code>kubectl expose</code> command , we are creating a service object in API.</p><p>Choosing this value makes the service only reachable from within the cluster. <strong>This is the default ServiceType</strong>.</p><p>We can see the <code>Service</code> spec using <code>--dry-run</code> & <code>--output=yaml</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> kubectl expose pod coffee --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>9090</span>  --type<span class=o>=</span>ClusterIP --dry-run --output<span class=o>=</span>yaml
</span></span></code></pre></div><p>Output</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>creationTimestamp</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>ClusterIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>status</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadBalancer</span><span class=p>:</span><span class=w> </span>{}</span></span></code></pre></div><p>Cluster IP service is useful when you don&rsquo;t want to expose the service to external world. eg:- database service.</p><p>With service names , a frontend tier can access the database backend without knowing the IPs of the Pods.</p><p>CoreDNS (kube-dns) will dynamically create a service DNS entry and that will be resolvable from Pods.</p><h4 id=verify-service-dns>Verify Service DNS</h4><p>Start debug-tools container which is an alpine linux image with network related binaries</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl run debugger --image<span class=o>=</span>ansilh/debug-tools --restart<span class=o>=</span>Never</span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl <span class=nb>exec</span> -it debugger -- /bin/sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1># nslookup coffee</span>
</span></span><span class=line><span class=cl>Server:         192.168.10.10
</span></span><span class=line><span class=cl>Address:        192.168.10.10#53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:   coffee.default.svc.cluster.local
</span></span><span class=line><span class=cl>Address: 192.168.10.86
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1># nslookup 192.168.10.86</span>
</span></span><span class=line><span class=cl>86.10.168.192.in-addr.arpa      <span class=nv>name</span> <span class=o>=</span> coffee.default.svc.cluster.local.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/ <span class=c1>#</span></span></span></code></pre></div><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl><span class=err>coffee.default.svc.cluster.local</span>
</span></span><span class=line><span class=cl>  <span class=na>^</span>      <span class=s>^      ^    k8s domain</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>|      |  |-----------|</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>|      +--------------- Indicates that its a service</span>
</span></span><span class=line><span class=cl>  <span class=na>|</span>      <span class=s>+---------------------- Namespace</span>
</span></span><span class=line><span class=cl>  <span class=na>+-----------------------------</span> <span class=s>Service Name</span></span></span></code></pre></div><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=loadbalancer>LoadBalancer</h1><p>Exposes the service externally using a cloud provider’s load balancer. NodePort and ClusterIP services, to which the external load balancer will route, are automatically created.</p><p>We will discuss more about this topic later in this training.</p><footer class=footline></footer></article><article class=default><header class=headline></header><h1 id=endpoints>Endpoints</h1><h3 id=pods-behind-a-service>Pods behind a service.</h3><p><a href=#R-image-b4053212d8ab476513161a48e23b40e7 class=lightbox-link><img src="../07-services/05-endpoints/nodeport.png?classes=shadow" alt=NodePod class="figure-image bg-white border lightbox shadow" style=height:auto;width:auto loading=lazy></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-b4053212d8ab476513161a48e23b40e7><img src="../07-services/05-endpoints/nodeport.png?classes=shadow" alt=NodePod class="lightbox-image bg-white border lightbox shadow" loading=lazy></a>
Lets <code>describe</code> the service to see how the mapping of Pods works in a service object.</p><p>(Yes , we are slowly moving from general wordings to pure kubernetes terms)</p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>$ kubectl describe service coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Name</span><span class=p>:</span><span class=w>                     </span><span class=l>coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Namespace</span><span class=p>:</span><span class=w>                </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Labels</span><span class=p>:</span><span class=w>                   </span><span class=l>run=coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Annotations</span><span class=p>:</span><span class=w>              </span><span class=l>&lt;none&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Selector</span><span class=p>:</span><span class=w>                 </span><span class=l>run=coffee</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Type</span><span class=p>:</span><span class=w>                     </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>IP</span><span class=p>:</span><span class=w>                       </span><span class=m>192.168.10.86</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Port</span><span class=p>:</span><span class=w>                     </span><span class=l>&lt;unset&gt;  80/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>TargetPort</span><span class=p>:</span><span class=w>               </span><span class=m>9090</span><span class=l>/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>NodePort</span><span class=p>:</span><span class=w>                 </span><span class=l>&lt;unset&gt;  30391/TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Endpoints</span><span class=p>:</span><span class=w>                </span><span class=m>10.10.1.13</span><span class=p>:</span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>Session Affinity</span><span class=p>:</span><span class=w>         </span><span class=l>None</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>External Traffic Policy</span><span class=p>:</span><span class=w>  </span><span class=l>Cluster</span></span></span></code></pre></div><p>Here the label <code>run=coffee</code> is the one which creates the mapping from service to Pod.</p><p>Any pod with label <code>run=coffee</code> will be mapped under this service.</p><p>Those mappings are called <code>Endpoints</code>.</p><p>Lets see the <code>endpoints</code> of <code>service</code> <code>coffee</code></p><div class="wrap-code highlight"><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ kubectl get endpoints  coffee
</span></span><span class=line><span class=cl>NAME     ENDPOINTS         AGE
</span></span><span class=line><span class=cl>coffee   10.10.1.13:9090   3h48m</span></span></code></pre></div><p>As of now only one pod endpoint is mapped under this service.</p><p>lets create one more Pod with same label and see how it affects endpoints.</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl run coffee01 --image=ansilh/demo-coffee --restart=Never --labels=run=coffee</code></pre></div><p>Now we have one more Pod</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get pods
NAME       READY   STATUS    RESTARTS   AGE
coffee     1/1     Running   0          15h
coffee01   1/1     Running   0          6s</code></pre></div><p>Lets check the endpoint</p><div class="wrap-code highlight"><pre tabindex=0><code>$ kubectl get endpoints  coffee
NAME     ENDPOINTS                         AGE
coffee   10.10.1.13:9090,10.10.1.19:9090   3h51m</code></pre></div><p>Now we have two Pod endpoints mapped to this service.
So the requests comes to coffee service will be served from these pods in a round robin fashion.</p><footer class=footline></footer></article></section></div></main></div><script src=../js/clipboard.min.js?1704652841 defer></script><script src=../js/perfect-scrollbar.min.js?1704652841 defer></script><script src=../js/theme.js?1704652841 defer></script></body></html>